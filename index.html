<!DOCTYPE html><html lang="fr" translate="no"><head><meta charset="UTF-8" /><meta name="google" content="notranslate" /><title>Gestion de la Pharmacie a Domicile</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="theme-color" content="#5a5fb8" /><link rel="manifest" href="manifest.json" /><style>
    :root{
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --primary-color: #667eea;
      --accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-color: #f093fb;
      --text: #2c3e50;
      --text-light: #ecf0f1;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #3498db;
      --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
      --radius: 15px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --title-color: #00695c;
      --list-header: #00796b;
      --list-row: rgba(255, 255, 255, 0.98);
      --list-row-alt: rgba(255, 255, 255, 0.98);
      --list-border: rgba(0, 121, 107, 0.22);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="60" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
      animation: float 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(180deg); }
    }

    nav{
      background: var(--primary);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow-light);
    }

    nav ul{
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      list-style: none;
      align-items: center;
      justify-content: center;
    }

    /* Dark mode toggle button */
    .theme-toggle-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      margin-left: auto;
    }

    .theme-toggle-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    .theme-toggle-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
      transition: var(--transition);
    }

    body.dark-mode .theme-toggle-btn svg {
      transform: rotate(180deg);
    }

    /* Dark mode toggle */
    .theme-toggle {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* Dark mode styles */
    body.dark-mode {
      --background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      --card-bg: rgba(22, 33, 62, 0.95);
      --text: #ecf0f1;
      --text-light: #2c3e50;
      --list-header: #00796b;
      --list-row: rgba(22, 33, 62, 0.85);
      --list-row-alt: rgba(22, 33, 62, 0.85);
      --list-border: rgba(0, 121, 107, 0.28);
      --title-color: #00695c;
    }

    h1, h2, h3, h4{
      color: var(--title-color);
    }

    body.dark-mode .stat-card,
    body.dark-mode .form,
    body.dark-mode .table,
    body.dark-mode .hero,
    body.dark-mode .cta-section {
      background: var(--card-bg);
      color: var(--text);
    }

    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background: rgba(255,255,255,0.1);
      color: var(--text);
      border-color: rgba(255,255,255,0.2);
    }

    body.dark-mode input:focus,
    body.dark-mode textarea:focus,
    body.dark-mode select:focus {
      background: rgba(255,255,255,0.15);
    }

    /* Dark mode toggle */
    .theme-toggle {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* Dark mode styles */
    body.dark-mode {
      --background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      --card-bg: rgba(22, 33, 62, 0.95);
      --text: #ecf0f1;
      --text-light: #2c3e50;
      --list-header: #0f766e;
      --list-row: rgba(22, 33, 62, 0.85);
      --list-row-alt: rgba(0, 150, 136, 0.16);
      --list-border: rgba(0, 150, 136, 0.28);
    }

    body.dark-mode .stat-card,
    body.dark-mode .form,
    body.dark-mode .table,
    body.dark-mode .hero,
    body.dark-mode .cta-section {
      background: var(--card-bg);
      color: var(--text);
    }

    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background: rgba(255,255,255,0.1);
      color: var(--text);
      border-color: rgba(255,255,255,0.2);
    }

    body.dark-mode input:focus,
    body.dark-mode textarea:focus,
    body.dark-mode select:focus {
      background: rgba(255,255,255,0.15);
    }

    nav a{
      color: var(--text-light);
      text-decoration: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    /* SVG Icons */
    .nav-icon { width: 18px; height: 18px; fill: currentColor; }

    nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    nav a:hover::before {
      left: 100%;
    }

    nav a:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* Boutons nav: effet 3D + gras */
    nav a, .nav-btn{
      font-weight: 700;
      text-shadow: 0 1px 0 rgba(0,0,0,0.15);
      box-shadow: 0 6px 14px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(8px);
    }
    nav a:active, .nav-btn:active{
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.1);
    }

    /* Couleurs par section */
    nav a[data-target="home"]{ background: linear-gradient(135deg,#2c7be5,#6f42c1); }
    nav a[data-target="inventory"]{ background: linear-gradient(135deg,#1f9d55,#2dd4bf); }
    nav a[data-target="add"]{ background: linear-gradient(135deg,#f59e0b,#f97316); }
    nav a[data-target="edit-mode"]{ background: linear-gradient(135deg,#10b981,#22c55e); }
    nav a[data-target="delete-mode"]{ background: linear-gradient(135deg,#ef4444,#f43f5e); }
    nav a[data-target="use-mode"]{ background: linear-gradient(135deg,#0ea5e9,#6366f1); }
    nav a[data-target="to-buy"]{ background: linear-gradient(135deg,#f97316,#f43f5e); }
    nav a[data-target="alerts"]{ background: linear-gradient(135deg,#14b8a6,#0ea5e9); }
    nav a[data-target="genre-search"]{ background: linear-gradient(135deg,#6366f1,#8b5cf6); }
    #logout-link{ background: linear-gradient(135deg,#64748b,#6366f1); }
    #theme-toggle{ background: linear-gradient(135deg,#7c3aed,#6366f1); color:#fff; border-radius:12px; }

    /* Boutons A  masquer */
    .nav-hidden{ display:none !important; }
    nav li:has(> .nav-hidden){ display:none !important; }

    .container{
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    section{
      display: none;
      animation: slideIn 0.4s ease-out;
    }

    section.active{display: block}

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 4px;
      overflow: hidden;
      box-shadow: var(--shadow);
      animation: tableSlideIn 0.5s ease-out;
    }

    @keyframes tableSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    th, td{
      padding: 1rem;
      text-align: left;
      vertical-align: top;
    }

    th{
      background: var(--list-header);
      color: white;
      font-weight: 700;
      position: relative;
      letter-spacing: 0.3px;
    }

    th::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    }

    tbody tr{
      background: var(--list-row);
      border-bottom: 1px solid var(--list-border);
    }
    tbody td{
      border-bottom: none;
    }
    tr:hover{
      background: rgba(0, 150, 136, 0.12);
      transition: var(--transition);
    }

    .expired{color: var(--danger) !important; font-weight: bold; animation: pulse 2s infinite;}
    .expiring-soon{color: var(--warning) !important; font-weight: bold; animation: pulse 2s infinite;}
    .valid{color: var(--success) !important;}
    .stock-zero{color: var(--danger) !important; font-weight: bold; background: rgba(231, 76, 60, 0.1); animation: shake 0.5s;}

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }

    .action-btn{
      background: none;
      border: none;
      cursor: pointer;
      margin: 0 0.25rem;
      font-size: 1.1rem;
      padding: 0.5rem;
      border-radius: var(--radius);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    .action-btn:hover::before {
      width: 100%;
      height: 100%;
    }

    .action-btn:hover{transform: scale(1.1) rotate(5deg);}
    .edit{color: var(--success);}
    .delete{color: var(--danger);}
    .use{color: var(--warning);}

    form{
      max-width: 520px;
      margin-top: 1rem;
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      animation: formSlideIn 0.5s ease-out;
    }

    @keyframes formSlideIn {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .form-group{margin-bottom: 1.5rem}
    label{
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, textarea, select{
      width: 100%;
      padding: 1rem;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: var(--transition);
      background: rgba(255,255,255,0.8);
    }

    input:focus, textarea:focus, select:focus{
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.2);
      transform: translateY(-2px);
    }

    textarea{resize: vertical; min-height: 100px;}

    button[type=submit]{
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      width: 100%;
    }

    button[type=submit]::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    button[type=submit]:hover::before {
      left: 100%;
    }

    button[type=submit]:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    #search, #search-edit, #search-delete, #search-use{
      width: 100%;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: var(--radius);
      font-size: 1rem;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }

    #search:focus, #search-edit:focus, #search-delete:focus, #search-use:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.2);
    }

    .notes-cell{max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .med-name-cell{
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .med-thumb{
      width:28px;
      height:28px;
      border-radius:6px;
      object-fit:cover;
      border:1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.06);
      flex:0 0 auto;
    }

    /* Debug sync */
    #debug-sync{
      background: rgba(26, 26, 46, 0.9);
      color: #00ff00;
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      max-height: 120px;
      overflow-y: auto;
      border-bottom: 2px solid #00ff00;
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
    }

    #debug-sync .log-entry{margin: 2px 0; animation: logEntry 0.3s ease-out;}
    @keyframes logEntry {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    #debug-sync .log-success{color: #00ff00;}
    #debug-sync .log-error{color: #ff5555;}
    #debug-sync .log-info{color: #ffff00;}

    .notes-cell:hover{white-space: normal; overflow: visible;}

    .stats-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .stat-card{
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      animation: cardBounce 0.6s ease-out;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--accent);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    @keyframes cardBounce {
      0% { opacity: 0; transform: scale(0.8) translateY(20px); }
      50% { transform: scale(1.05) translateY(-5px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    .stat-number{
      font-size: 3rem;
      font-weight: bold;
      margin: 0.5rem 0;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: numberCount 1s ease-out;
    }

    @keyframes numberCount {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }

    .password-modal{
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .password-content{
      background: var(--card-bg);
      padding: 3rem;
      border-radius: var(--radius);
      text-align: center;
      width: 90%;
      max-width: 450px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      animation: modalSlideIn 0.4s ease-out;
    }

    .details-modal{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      z-index: 9000;
      padding: 1rem;
    }
    .details-content{
      background: var(--card-bg);
      color: var(--text);
      width: 100%;
      max-width: 520px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }
    .details-content h3{
      margin-bottom: 0.75rem;
      font-size: 1.2rem;
    }
    .details-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem 1rem;
      font-size: 0.95rem;
    }
    .details-grid .label{
      color: var(--primary-color);
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .details-grid .value{
      color: var(--text);
      word-break: break-word;
    }
    .details-actions{
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .details-close{
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
    }
    .details-image-clickable{
      cursor: zoom-in;
    }
    .image-zoom-modal{
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 11000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .image-zoom-modal img{
      max-width: 95vw;
      max-height: 90vh;
      width: auto;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.5);
      touch-action: none;
      user-select: none;
      -webkit-user-drag: none;
      transform: translate(0px, 0px) scale(1);
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.8) translateY(-20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .empty-msg{
      text-align: center;
      padding: 3rem;
      color: #666;
      font-style: italic;
      animation: fadeIn 0.5s ease-out;
    }

    .nav-btn{
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }

    .nav-btn:hover{
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }

    /* SVG Icons */
    .icon { width: 20px; height: 20px; fill: currentColor; }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      /* Navigation mobile - menu compact en grille */
      nav{padding:.3rem}
      nav ul{
        display:grid;
        grid-template-columns:repeat(5, 1fr);
        gap:.25rem;
        align-items:stretch;
        grid-auto-rows:58px
      }
      nav li{
        margin:0;
        padding:0;
        min-width:0;
        height:100%;
      }
      nav a, nav li > button{
        padding:.28rem .2rem;
        font-size:.56rem;
        text-align:center;
        flex-direction:column;
        gap:.15rem;
        line-height:1.05;
        min-height:50px;
        justify-content:center;
        border-radius:10px;
        width:100%;
        height:100%;
        box-sizing:border-box;
        display:flex;
        align-items:center;
        white-space:normal;
      }
      nav a svg{
        width:16px;
        height:16px;
        min-width:16px;
        min-height:16px;
        display:block;
      }
      nav a span{display:block}
      #theme-toggle{
        width:100%;
        height:100%;
        border-radius:10px;
      }
      #theme-toggle svg{
        width:16px;
        height:16px;
      }
      nav li:last-child{display:none} /* cacher version sur mobile */
      nav li:has(> #logout-link){
        grid-column: 2 / span 3;
      }

      /* Container - plus compact */
      .container{padding:.5rem}

      /* Titres rAduits */
      h1{font-size:1rem}
      h2{font-size:.95rem}
      h3{font-size:.9rem}

      /* Stats grid - compact */
      .stats-grid{
        grid-template-columns:repeat(2,1fr);
        gap:.4rem;
        margin:.5rem 0
      }
      .stat-card{
        padding:.5rem
      }
      .stat-number{font-size:1.1rem}

      /* Forms - compact */
      form{
        padding:.5rem;
        margin-top:.3rem
      }
      .form-group{margin-bottom:.5rem}
      label{font-size:.9rem;margin-bottom:.3rem}

      /* Inputs plus compacts */
      input,textarea,select{
        padding:.4rem;
        font-size:.85rem
      }

      /* Buttons */
      button[type=submit]{
        padding:.4rem .75rem;
        font-size:.85rem
      }

      /* Search + value row */
      #inventory>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }
      #inventory>div[style*="display:flex"]>div{
        justify-content:center
      }

      /* Use mode quantity */
      #use-mode>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }

      /* Tables responsive avec scroll horizontal */
      table{
        font-size:.75rem;
        display:block;
        overflow-x:auto;
        white-space:nowrap;
        -webkit-overflow-scrolling: touch;
        max-width: 100%;
        margin: 0;
        padding-left: 0.25rem;
        padding-right: 0.25rem;
        backdrop-filter: none;
      }
      /* Eviter dAcalage entre en-tAate et lignes */
      #med-table, #med-table-edit, #med-table-delete, #med-table-use{
        width:100%;
        table-layout:auto;
      }
      #med-table thead, #med-table tbody,
      #med-table-edit thead, #med-table-edit tbody,
      #med-table-delete thead, #med-table-delete tbody,
      #med-table-use thead, #med-table-use tbody{
        display:table-row-group;
        width:auto;
        table-layout:auto;
      }
      #med-table th, #med-table td,
      #med-table-edit th, #med-table-edit td,
      #med-table-delete th, #med-table-delete td,
      #med-table-use th, #med-table-use td{
        white-space:nowrap;
      }
      /* Table "A acheter" pleine largeur */
      #tobuy-table{
        display:table;
        width:100%;
        table-layout:fixed;
      }
      #tobuy-table th, #tobuy-table td{
        white-space:normal;
        word-break:break-word;
      }
      th,td{
        padding:.3rem .25rem;
        min-width:50px
      }
      .notes-cell{max-width:60px}
      .med-thumb{width:24px;height:24px;border-radius:6px}
       #med-table td.med-name-cell span,
      #med-table-edit td.med-name-cell span,
      #med-table-delete td.med-name-cell span,
      #med-table-use td.med-name-cell span{
        font-size:.92rem;
        line-height:1.2;
        font-weight:700;
      }

      /* Modal edit */
      #edit-modal{padding:.2rem}
      #edit-modal>div{
        padding:.5rem;
        max-width:98vw
      }

      /* Modal password */
      .password-content{
        padding:.75rem;
        max-width:90vw
      }

      /* Buttons row in modal */
      #edit-modal>div>form>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }

      /* Liste d'attention - responsive */
      .attention-list-item {
        font-size: 0.85rem;
        padding: 0.75rem;
      }

      /* Debug sync - plus compact */
      #debug-sync {
        font-size: 0.7rem;
        padding: 0.5rem;
      }
    }

    @media (max-width: 480px) {
      /* Navigation mobile - afficher tous les libellAs */
      nav ul{
        grid-template-columns:repeat(5, 1fr);
        gap:.2rem;
        grid-auto-rows:54px
      }
      nav li{
        margin:0;
        padding:0;
        min-width:0;
        height:100%;
      }
      nav a, nav li > button{
        padding:.2rem .15rem;
        font-size:.52rem;
        flex-direction:column;
        gap:.1rem;
        line-height:1.05;
        text-align:center;
        min-height:44px;
        border-radius:9px;
        width:100%;
        height:100%;
        box-sizing:border-box;
        display:flex;
        align-items:center;
        white-space:normal;
      }
      nav a svg{
        width:15px;
        height:15px
      }
      #theme-toggle svg{
        width:15px;
        height:15px;
      }
      .med-thumb{
        width:22px;
        height:22px;
        border-radius:5px;
      }
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      
      /* Toujours visible */
      #logout-link{
        display:block !important
      }
      nav li:has(> #logout-link){
        grid-column: 2 / span 3;
      }

      /* Colonnes visibles sur mobile */
      #med-table th:nth-child(1),
      #med-table td:nth-child(1){
        min-width:145px
      }
      #med-table th:nth-child(2),
      #med-table td:nth-child(2){
        min-width:60px
      }
      #med-table th:nth-child(3),
      #med-table td:nth-child(3){
        min-width:60px
      }
      #med-table th:nth-child(4),
      #med-table td:nth-child(4){
        min-width:45px
      }
      #med-table th:nth-child(5),
      #med-table td:nth-child(5){
        min-width:65px
      }
      #med-table th:nth-child(6),
      #med-table td:nth-child(6){
        min-width:60px
      }
      #med-table th:nth-child(7),
      #med-table td:nth-child(7){
        min-width:70px
      }
       #med-table td.med-name-cell span,
      #med-table-edit td.med-name-cell span,
      #med-table-delete td.med-name-cell span,
      #med-table-use td.med-name-cell span{
        font-size:1.03rem;
        line-height:1.2;
        font-weight:700;
      }

      /* Liste attention - trA s compact */
      .attention-list-item {
        font-size: 0.8rem;
        padding: 0.5rem;
        margin: 0.25rem 0;
      }

      /* Table "A acheter" - responsive */
      #tobuy-table {
        font-size: 0.7rem;
      }
      #tobuy-table th, #tobuy-table td {
        padding: 0.25rem 0.15rem;
      }
      #tobuy-table td:first-child{
        font-size:.95rem;
        font-weight:700;
      }
      #tobuy-table td:first-child, #tobuy-table td:nth-child(2), #tobuy-table td:nth-child(3){
        line-height:1.2;
      }
      #tobuy-table th, #tobuy-table td {
        padding: 0.25rem 0.15rem;
      }
    }
  </style></head><body><!-- Modal de connexion --><div id="pwd-modal" class="password-modal"><div class="password-content"><h2> Acces securise</h2><p style="margin-top:.5rem;">Entrez le mot de passe pour acceder a l'application</p><input type="password" id="pwd-input" placeholder="Mot de passe"
             style="width:100%;padding:.75rem;margin:1rem 0;border:1px solid #ddd;border-radius:var(--radius);font-size:1.1rem;" /><button id="pwd-btn"
              style="background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1.03rem;font-weight:600;">
        Acceder
      </button><button id="bio-btn"
              style="margin-top:.6rem;background:#2e7d32;color:#fff;border:none;padding:.6rem 1.2rem;border-radius:var(--radius);cursor:pointer;font-size:.95rem;font-weight:600;">
        Empreinte / Face ID
      </button><p id="pwd-error" style="color:#d32f2f;margin-top:1rem;display:none;">Mot de passe incorrect</p><p style="margin-top:.6rem;font-size:.85rem;color:#666;">Astuce : Entree = valider</p><p style="margin-top:.4rem;font-size:.8rem;color:#666;">L'empreinte fonctionne seulement sur mobile/PWA.</p></div></div><!-- Modal dAtails mAdicament --><div id="details-modal" class="details-modal"><div class="details-content"><h3 id="details-title">DAtails</h3><div style="display:flex;justify-content:center;margin:.5rem 0 1rem;"><img id="details-image" class="med-thumb" style="width:64px;height:64px;border-radius:10px;display:none;" alt=""></div><div class="details-grid"><div class="label">Nom</div><div class="value" id="details-name">-</div><div class="label">Dosage</div><div class="value" id="details-dosage">-</div><div class="label">Genre</div><div class="value" id="details-genre">-</div><div class="label">QuantitA</div><div class="value" id="details-quantity">-</div><div class="label">Date d'achat</div><div class="value" id="details-purchase">-</div><div class="label">Stock initial</div><div class="value" id="details-initial">-</div><div class="label">Prix</div><div class="value" id="details-price">-</div><div class="label">BoAtes</div><div class="value" id="details-boxes">-</div><div class="label">Peremption</div><div class="value" id="details-expiry">-</div><div class="label">Notes</div><div class="value" id="details-notes">-</div></div><div class="details-actions"><button class="details-close" id="details-close-btn">Fermer</button></div></div></div><div id="image-zoom-modal" class="image-zoom-modal"><img id="image-zoom-img" alt=""></div><!-- Navigation --><nav id="main-nav" style="display:none;"><ul><li><a href="#" data-target="home"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg> Accueil</a></li><li><a href="#" data-target="inventory"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 7h-4V4c0-1.1-.9-2-2-2H10c-1.1 0-2 .9-2 2v3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zM10 4h4v3h-4V4z"/></svg> Stock actuel</a></li><li><a href="#" data-target="add"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Saisie</a></li><li><a href="#" data-target="edit-mode"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Modifier</a></li><li><a href="#" data-target="delete-mode"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Supprimer</a></li><li><a href="#" data-target="use-mode"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Utiliser</a></li><li><a href="#" data-target="to-buy"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4V2C7 1.45 7.45 1 8 1s1 .45 1 1v2h6V2c0-.55.45-1 1-1s1 .45 1 1v2h5c.55 0 1 .45 1 1s-.45 1-1 1h-1v13c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V6H2c-.55 0-1-.45-1-1s.45-1 1-1h5zm2 0V3c0-.55.45-1 1-1s1 .45 1 1v1h4V3c0-.55.45-1 1-1s1 .45 1 1v1h2v2H5V6h4zm-2 4v9h12V8H7z"/></svg> A acheter</a></li><!-- Theme Toggle Button --><li><button id="theme-toggle" class="theme-toggle-btn" title="Basculer mode sombre/clair"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/></svg></button></li><!-- NOUVEAU : Sauvegarder / Restaurer / Vider / Sync --><li><a href="#" id="btn-save" class="nav-btn nav-hidden"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V7h10v2z"/></svg> Sauvegarder</a></li><li><a href="#" id="btn-restore" class="nav-btn nav-hidden"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg> Restaurer</a></li><li><a href="#" id="btn-clean-dup" class="nav-btn nav-hidden"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/></svg> Nettoyer</a></li><li><a href="#" id="btn-clear" class="nav-btn nav-hidden"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Vider</a></li><li><a href="#" id="btn-reset-all" class="nav-btn nav-hidden"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6V3L8 7l4 4V8c3.31 0 6 2.69 6 6a6 6 0 11-6-6z"/></svg> Reinitialiser</a></li><li><a href="#" id="btn-clear-local" class="nav-btn nav-hidden"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Vider local</a></li><li><a href="#" id="logout-link"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg> Quitter</a></li><li><span style="color:#fff;font-size:.7rem;opacity:.7;">v<span id="app-version">-</span></span></li></ul></nav><!-- Debug Sync Status - cachA par dAfaut --><!-- <div id="debug-sync" style="display:none;"> --><!--   <div class="log-info">Y Debug Sync Cloud</div> --><!-- </div> --><div class="container" id="main" style="display:none;"><!-- Accueil --><section id="home" class="section active"><h1>Gestionnaire de Pharmacie  Domicile</h1><div class="stats-grid"><div class="stat-card"><h3>Stock total</h3><div class="stat-number" id="total-meds">0</div></div><div class="stat-card"><h3>Expirs</h3><div class="stat-number" id="expired-count">0</div></div><div class="stat-card"><h3>Prexpiration</h3><div class="stat-number" id="preexp-count">0</div></div><div class="stat-card"><h3>Stock nul</h3><div class="stat-number" id="zerostock-count">0</div></div></div><h3>Mdicaments ncessitant une attention</h3><div id="attention-list" style="margin-top:.75rem;"></div><!-- Debug sync status --><div style="background:#f0f0f0;padding:1rem;margin-top:1rem;border-radius:8px;font-size:0.9rem;"><h4>tat Sync Cloud</h4><p>Locaux: <strong id="debug-local-count">0</strong></p><p>Cloud: <strong id="debug-cloud-count">0</strong></p><p>Statut: <strong id="debug-status">En attente...</strong></p><button onclick="forceDebugSync()" style="margin-top:0.5rem;padding:0.5rem 1rem;background:#2196F3;color:#fff;border:none;border-radius:4px;cursor:pointer;">Tester Sync</button></div></section><!-- Stock actuel --><section id="inventory" class="section"><h2> Stock actuel</h2><div style="display:flex;gap:1rem;margin:1rem 0;align-items:center;flex-wrap:wrap;"><input type="text" id="search" placeholder=" Rechercher (nom, dosage, notes)..." style="flex:1;"></div><table id="med-table"><thead><tr><th>Nom</th><th>Genre</th><th>Dosage</th><th>Qte</th><th>Peremption</th><th>Alerte</th><th>Actions</th></tr></thead><tbody></tbody></table></section><!-- Ajout --><section id="add" class="section"><h2>Ajouter un medicament</h2><form id="add-form"><div class="form-group"><label>Nom *</label><input type="text" id="name" required></div><div class="form-group"><label>Dosage *</label><input type="text" id="dosage" placeholder="ex : 500mg, 10ml" required></div><div class="form-group"><label>Genre *</label><select id="genre" required style="width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1.03rem;"><option value="">Selectionner...</option><option value="Comprimes">Comprimes</option><option value="Gelules">Gelules</option><option value="Suppositoires">Suppositoires</option><option value="Sachets">Sachets</option><option value="Gel">Gel</option><option value="Flacon">Flacon</option><option value="Sirop">Sirop</option><option value="Solution">Solution</option><option value="Pommade">Pommade</option><option value="Lotion">Lotion</option><option value="Creme">Creme</option><option value="Poudre">Poudre</option><option value="Gouttes">Gouttes</option><option value="Inhalation">Inhalation</option><option value="Patch">Patch</option><option value="Autre">Autre</option></select></div><div class="form-group"><label>Date d'achat</label><div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;"><input type="date" id="purchase-date" style="flex:1;min-width:160px;" disabled><label style="display:flex;align-items:center;gap:.4rem;font-size:.9rem;"><input type="checkbox" id="purchase-date-custom">
              Autre jour
            </label></div><small style="display:block;margin-top:.4rem;color:#666;">Par defaut : aujourd'hui. Cochez "Autre jour" pour saisir.</small></div><!-- Stock initial AVANT quantite actuelle --><div class="form-group"><label>Stock initial *</label><input type="number" id="initial-stock" min="0" required></div><div class="form-group"><label>Quantite actuelle *</label><input type="number" id="quantity" min="0" required></div><div class="form-group"><label>Prix (DH) *</label><input type="number" id="price" min="0" step="0.01" required></div><div class="form-group"><label>Nombre de boites *</label><input type="number" id="nb-boxes" min="1" value="1" required></div><div class="form-group"><label>Date de Peremption (MM/AA) *</label><input type="text" id="expiry-mmaa" inputmode="numeric" placeholder="ex : 02/26" maxlength="5" required><small style="display:block;margin-top:.5rem;color:#666;">Format : MM/AA</small></div><div class="form-group"><label>Photo (optionnel)</label><input type="file" id="image-file" accept="image/*" capture="environment"><small style="display:block;margin-top:.4rem;color:#666;">Camera ou galerie.</small></div><div class="form-group"><label>Notes</label><textarea id="notes" placeholder="Optionnel"></textarea></div><button type="submit">Ajouter</button></form></section><!-- Modifier --><section id="edit-mode" class="section"><h2>Modifier</h2><input type="text" id="search-edit" placeholder="Rechercher..." /><table id="med-table-edit"><thead><tr><th>Nom</th><th>Dosage</th><th>Qte</th><th>Peremption</th><th>Alerte</th><th>Modifier</th></tr></thead><tbody></tbody></table></section><!-- Supprimer --><section id="delete-mode" class="section"><h2>Supprimer</h2><input type="text" id="search-delete" placeholder="Rechercher..." /><table id="med-table-delete"><thead><tr><th>Nom</th><th>Dosage</th><th>Qte</th><th>Peremption</th><th>Alerte</th><th>Supprimer</th></tr></thead><tbody></tbody></table></section><!-- Utiliser --><section id="use-mode" class="section"><h2>Utiliser</h2><div class="form-group" style="max-width:420px;"><label for="use-qty">Quantite a utiliser :</label><div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;"><input type="number" id="use-qty" min="1" value="1" style="width:120px;"><span class="chip">Alerte stock faible <= 5</span></div></div><input type="text" id="search-use" placeholder="Rechercher..." /><table id="med-table-use"><thead><tr><th>Nom</th><th>Dosage</th><th>Qte</th><th>Peremption</th><th>Alerte</th><th>Utiliser</th></tr></thead><tbody></tbody></table></section><!-- A acheter --><section id="to-buy" class="section"><h2>Medicaments a acheter</h2><button id="tobuy-toggle" class="nav-btn" style="margin:.5rem 0;">Ajouter</button><form id="tobuy-form" style="max-width:420px;display:none;"><div class="form-group"><label>Nom du medicament *</label><input type="text" id="tobuy-name" required></div><div class="form-group"><label>Quantite *</label><input type="number" id="tobuy-qty" min="1" value="1" required></div><div class="form-group"><label>Genre / Notes</label><input type="text" id="tobuy-notes" placeholder="ex : comprime, sirop, creme..."></div><button type="submit">Ajouter a la liste</button></form><table id="tobuy-table" style="margin-top:1.5rem;"><thead><tr><th>Nom</th><th>Quantite</th><th>Genre</th><th>Actions</th></tr></thead><tbody></tbody></table></section></div><!-- Modal d'Adition --><div id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000;overflow-y:auto;padding:1rem;"><div style="background:#fff;padding:2rem;border-radius:8px;width:100%;max-width:540px;box-shadow:0 4px 20px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto;"><h3 style="margin-bottom:1.2rem;">Modifier le medicament</h3><form id="edit-form"><input type="hidden" id="edit-index"><div class="form-group"><label>Nom *</label><input type="text" id="edit-name" required></div><div class="form-group"><label>Dosage *</label><input type="text" id="edit-dosage" required></div><div class="form-group"><label>Genre *</label><select id="edit-genre" required style="width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1.03rem;"><option value="">SAlectionner...</option><option value="ComprimAs">ComprimAs</option><option value="GAlules">GAlules</option><option value="Suppositoires">Suppositoires</option><option value="Sachets">Sachets</option><option value="Gel">Gel</option><option value="Flacon">Flacon</option><option value="Sirop">Sirop</option><option value="Solution">Solution</option><option value="Pommade">Pommade</option><option value="Lotion">Lotion</option><option value="CrA me">CrA me</option><option value="Poudre">Poudre</option><option value="Gouttes">Gouttes</option><option value="Inhalation">Inhalation</option><option value="Patch">Patch</option><option value="Autre">Autre</option></select></div><div class="form-group"><label>Date d'achat</label><div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;"><input type="date" id="edit-purchase-date" style="flex:1;min-width:160px;" disabled><label style="display:flex;align-items:center;gap:.4rem;font-size:.9rem;"><input type="checkbox" id="edit-purchase-date-custom">
              Autre jour
            </label></div><small style="display:block;margin-top:.4rem;color:#666;">Par dAfaut : aujourd'hui. Cochez "Autre jour" pour saisir.</small></div><div class="form-group"><label>Stock initial *</label><input type="number" id="edit-initial" min="0" required></div><div class="form-group"><label>QuantitA actuelle *</label><input type="number" id="edit-quantity" min="0" required></div><div class="form-group"><label>Prix (DH) *</label><input type="number" id="edit-price" min="0" step="0.01" required></div><div class="form-group"><label>Nombre de boAtes *</label><input type="number" id="edit-nb-boxes" min="1" value="1" required></div><div class="form-group"><label>Peremption (MM/AA) *</label><input type="text" id="edit-expiry-mmaa" inputmode="numeric" maxlength="5" placeholder="ex : 02/26" required></div><div class="form-group"><label>Photo (optionnel)</label><input type="file" id="edit-image-file" accept="image/*" capture="environment"><small style="display:block;margin-top:.4rem;color:#666;">Laisser vide pour garder l'image actuelle.</small></div><div class="form-group"><label>Notes</label><textarea id="edit-notes"></textarea></div><div style="display:flex;gap:1rem;flex-wrap:wrap;"><button type="submit" style="flex:1;">Enregistrer</button><button type="button" id="edit-cancel" style="flex:1;background:#6c757d;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1.03rem;font-weight:600;">Annuler</button></div></form><p style="margin-top:1rem;font-size:.9rem;color:#666;">Astuce : Echap = fermer</p></div></div><script>
/* =========================
   CONFIG / STOCKAGE
========================= */
const PASSWORD = "mohamed1964";
const APP_VERSION = "2.50";
const FAST_SYNC_INTERVAL_MS = 5000;
const DEBUG_LOGS = false;
const STORAGE_KEY = "medicines";
const TOBUY_KEY = "medicines_to_buy";
const PENDING_DELETE_KEY = "medicines_pending_delete";
const PENDING_TOBUY_DELETE_KEY = "tobuy_pending_delete";

// (optionnel) clA si tu veux gArer des exemples une seule fois
const SEEDED_KEY = "medicines_seeded_once";

let auth = false;
let meds = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let toBuyList = JSON.parse(localStorage.getItem(TOBUY_KEY)) || [];

// Ajouter timestamps aux donnAes existantes si manquant
meds.forEach(m => {
  if(!m.created_at) m.created_at = new Date().toISOString();
  if(!m.updated_at) m.updated_at = new Date().toISOString();
});
toBuyList.forEach(t => {
  if(!t.created_at) t.created_at = new Date().toISOString();
  if(!t.updated_at) t.updated_at = new Date().toISOString();
});

/* =========================
   UTILITAIRES
========================= */
function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}

function getTodayISODate(){
  return new Date().toISOString().slice(0,10);
}

let lastStockScrollTs = 0;
window.addEventListener('scroll', () => { lastStockScrollTs = Date.now(); }, { passive: true });
window.addEventListener('touchmove', () => { lastStockScrollTs = Date.now(); }, { passive: true });

function openDetails(idx){
  // Evite l'ouverture du popup pendant le scroll (mobile + PC).
  if (Date.now() - lastStockScrollTs < 220) return;
  const m = meds[idx];
  if(!m) return;

  const setText = (id, val) => {
    const el = document.getElementById(id);
    if(el) el.textContent = val;
  };

  setText('details-title', `Details: ${m.name || ''}`);
  setText('details-name', m.name || '-');
  setText('details-dosage', m.dosage || '-');
  setText('details-genre', m.genre || '-');
  setText('details-quantity', String(Number(m.quantity) || 0));
  setText('details-purchase', m.purchaseDate || '-');
  setText('details-initial', String(Number(m.initialStock) || 0));
  setText('details-price', (Number(m.price) || 0).toFixed(2) + ' DH');
  setText('details-boxes', String(Number(m.nbBoxes) || 1));
  setText('details-expiry', fmtMMAA(m.expiry));
  setText('details-notes', (m.notes || '-'));

  const imgEl = document.getElementById('details-image');
  if(imgEl){
    if(m.imageUrl){
      imgEl.src = m.imageUrl;
      imgEl.style.display = 'block';
      imgEl.classList.add('details-image-clickable');
      imgEl.onclick = function(){
        openImageZoom(m.imageUrl);
      };
    } else {
      imgEl.removeAttribute('src');
      imgEl.style.display = 'none';
      imgEl.classList.remove('details-image-clickable');
      imgEl.onclick = null;
    }
  }

  const modal = document.getElementById('details-modal');
  if(modal) modal.style.display = 'flex';
}

function closeDetails(){
  const modal = document.getElementById('details-modal');
  if(modal) modal.style.display = 'none';
}
let imageZoomScale = 1;
let imageZoomTranslateX = 0;
let imageZoomTranslateY = 0;
let imageZoomStartDist = 0;
let imageZoomStartScale = 1;
let imageZoomDragging = false;
let imageZoomDragStartX = 0;
let imageZoomDragStartY = 0;

function clampImageZoom(v){
  return Math.max(1, Math.min(4, v));
}
function imageTouchDistance(t1, t2){
  const dx = t1.clientX - t2.clientX;
  const dy = t1.clientY - t2.clientY;
  return Math.hypot(dx, dy);
}
function applyImageZoomTransform(){
  const img = document.getElementById('image-zoom-img');
  if(!img) return;
  img.style.transform = `translate(${imageZoomTranslateX}px, ${imageZoomTranslateY}px) scale(${imageZoomScale})`;
}
function resetImageZoomTransform(){
  imageZoomScale = 1;
  imageZoomTranslateX = 0;
  imageZoomTranslateY = 0;
  imageZoomStartDist = 0;
  imageZoomStartScale = 1;
  imageZoomDragging = false;
  imageZoomDragStartX = 0;
  imageZoomDragStartY = 0;
  applyImageZoomTransform();
}
function setupImageZoomGestures(){
  const img = document.getElementById('image-zoom-img');
  if(!img || img.dataset.zoomReady === '1') return;
  img.dataset.zoomReady = '1';

  img.addEventListener('click', (e) => e.stopPropagation());

  img.addEventListener('touchstart', (e) => {
    e.stopPropagation();
    if(e.touches.length === 2){
      e.preventDefault();
      imageZoomStartDist = imageTouchDistance(e.touches[0], e.touches[1]);
      imageZoomStartScale = imageZoomScale;
      imageZoomDragging = false;
    } else if(e.touches.length === 1 && imageZoomScale > 1){
      e.preventDefault();
      imageZoomDragging = true;
      imageZoomDragStartX = e.touches[0].clientX - imageZoomTranslateX;
      imageZoomDragStartY = e.touches[0].clientY - imageZoomTranslateY;
    }
  }, { passive: false });

  img.addEventListener('touchmove', (e) => {
    if(e.touches.length === 2){
      e.preventDefault();
      const dist = imageTouchDistance(e.touches[0], e.touches[1]);
      if(imageZoomStartDist > 0){
        imageZoomScale = clampImageZoom(imageZoomStartScale * (dist / imageZoomStartDist));
        if(imageZoomScale === 1){
          imageZoomTranslateX = 0;
          imageZoomTranslateY = 0;
        }
        applyImageZoomTransform();
      }
    } else if(e.touches.length === 1 && imageZoomDragging && imageZoomScale > 1){
      e.preventDefault();
      imageZoomTranslateX = e.touches[0].clientX - imageZoomDragStartX;
      imageZoomTranslateY = e.touches[0].clientY - imageZoomDragStartY;
      applyImageZoomTransform();
    }
  }, { passive: false });

  img.addEventListener('touchend', () => {
    imageZoomStartDist = 0;
    if(imageZoomScale <= 1){
      imageZoomDragging = false;
      imageZoomTranslateX = 0;
      imageZoomTranslateY = 0;
      applyImageZoomTransform();
    }
  });
}

function openImageZoom(src){
  if(!src) return;
  const modal = document.getElementById('image-zoom-modal');
  const img = document.getElementById('image-zoom-img');
  if(!modal || !img) return;
  setupImageZoomGestures();
  resetImageZoomTransform();
  img.src = src;
  modal.style.display = 'flex';
}
function closeImageZoom(){
  const modal = document.getElementById('image-zoom-modal');
  const img = document.getElementById('image-zoom-img');
  if(!modal || !img) return;
  modal.style.display = 'none';
  resetImageZoomTransform();
  img.removeAttribute('src');
}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(meds)); }
function isOnline(){ return navigator.onLine !== false; }
function getPendingDeleteMap(){
  try {
    return JSON.parse(localStorage.getItem(PENDING_DELETE_KEY)) || {};
  } catch(e) {
    return {};
  }
}
function setPendingDeleteMap(map){
  localStorage.setItem(PENDING_DELETE_KEY, JSON.stringify(map || {}));
}
function markPendingDelete(key){
  const map = getPendingDeleteMap();
  map[key] = Date.now();
  setPendingDeleteMap(map);
}
function clearPendingDelete(key){
  const map = getPendingDeleteMap();
  if(map[key]){
    delete map[key];
    setPendingDeleteMap(map);
  }
}
function cleanupPendingDeletes(cloudKeys){
  const map = getPendingDeleteMap();
  let changed = false;
  Object.keys(map).forEach(k => {
    if(!cloudKeys[k]){
      delete map[k];
      changed = true;
    }
  });
  if(changed) setPendingDeleteMap(map);
}

function getPendingToBuyDeleteMap(){
  try {
    return JSON.parse(localStorage.getItem(PENDING_TOBUY_DELETE_KEY)) || {};
  } catch(e) {
    return {};
  }
}
function setPendingToBuyDeleteMap(map){
  localStorage.setItem(PENDING_TOBUY_DELETE_KEY, JSON.stringify(map || {}));
}
function toBuyDeleteKey(id, name){
  if(id) return `id:${id}`;
  return `name:${String(name || '').toLowerCase().trim()}`;
}
function markPendingToBuyDelete(id, name){
  const map = getPendingToBuyDeleteMap();
  map[toBuyDeleteKey(id, name)] = Date.now();
  setPendingToBuyDeleteMap(map);
}
function clearPendingToBuyDelete(id, name){
  const map = getPendingToBuyDeleteMap();
  const key = toBuyDeleteKey(id, name);
  if(map[key]){
    delete map[key];
    setPendingToBuyDeleteMap(map);
  }
}
function cleanupPendingToBuyDeletes(cloudItems){
  const map = getPendingToBuyDeleteMap();
  const cloudKeys = {};
  cloudItems.forEach(a => {
    cloudKeys[toBuyDeleteKey(a.id, a.name)] = true;
  });
  let changed = false;
  Object.keys(map).forEach(k => {
    if(!cloudKeys[k]){
      delete map[k];
      changed = true;
    }
  });
  if(changed) setPendingToBuyDeleteMap(map);
}

function normalizeName(str){
  return String(str || "").trim().replace(/\s+/g, " ");
}
function keyOf(name, dosage){
  return (normalizeName(name) + "||" + normalizeName(dosage)).toLowerCase();
}
function safeSlug(str){
  return String(str || '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/(^-|-$)/g,'');
}
function buildImagePath(name, dosage, file){
  const ext = (file && file.name && file.name.includes('.'))
    ? file.name.split('.').pop()
    : (file && file.type ? file.type.split('/').pop() : 'jpg');
  const base = `${safeSlug(name)}_${safeSlug(dosage)}_${Date.now()}`;
  return `meds/${base}.${ext}`;
}
async function uploadMedImageIfAny(file, name, dosage){
  if(!file) return '';
  if(!window.uploadMedImage) return '';
  const path = buildImagePath(name, dosage, file);
  const res = await uploadMedImage(file, path);
  if(res && res.error){
    console.warn('Erreur upload image:', res.error);
    alert('Image non envoyee. Le medicament sera enregistre sans image.');
    return '';
  }
  return res && res.url ? res.url : '';
}

function fmtMMAAFromISO(iso){
  const dt = new Date(iso);
  if (isNaN(dt.getTime())) return "-";
  return `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getFullYear()).slice(-2)}`;
}
function fmtMMAA(d){ return fmtMMAAFromISO(d); }

function parseMMAAtoISO(mmaa){
  const raw = String(mmaa || "").trim();
  const compact = raw.replaceAll("/","").replace(/\D/g,'').slice(0,4);
  if(/^\d{4}$/.test(compact)){
    mmaa = compact.slice(0,2) + "/" + compact.slice(2,4);
  } else {
    mmaa = raw;
  }

  if(!/^\d{2}\/\d{2}$/.test(mmaa)) return null;

  const mm = parseInt(mmaa.slice(0,2), 10);
  const aa = parseInt(mmaa.slice(3,5), 10);
  if(mm < 1 || mm > 12) return null;

  const yyyy = (aa <= 79) ? (2000 + aa) : (1900 + aa);
  const iso = `${yyyy}-${String(mm).padStart(2,'0')}-01`;
  const dt = new Date(iso);
  if(isNaN(dt.getTime())) return null;
  return iso;
}

function expClass(iso){
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(iso); exp.setHours(0,0,0,0);
  const diff = Math.ceil((exp - today) / (1000*60*60*24));
  if(diff < 0) return "expired";
  if(diff <= 30) return "expiring-soon";
  return "valid";
}
function stockClass(q){ return (Number(q) === 0) ? "stock-zero" : ""; }

function mergeNotes(a,b){
  const n1 = (a||'').trim();
  const n2 = (b||'').trim();
  if(!n1) return n2;
  if(!n2) return n1;
  if(n1.toLowerCase() === n2.toLowerCase()) return n1;
  return n1 + " | " + n2;
}
function earliestExpiry(aISO, bISO){
  if(!aISO) return bISO;
  if(!bISO) return aISO;
  const da = new Date(aISO);
  const db = new Date(bISO);
  return (db < da) ? bISO : aISO;
}

/* =========================
   AUTH
========================= */
function setAppVisible(isVisible){
  document.getElementById('pwd-modal').style.display = isVisible ? 'none' : 'flex';
  document.getElementById('main-nav').style.display = isVisible ? 'block' : 'none';
  document.getElementById('main').style.display = isVisible ? 'block' : 'none';
}
function checkPwd(){
  const val = document.getElementById('pwd-input').value;
  if(val === PASSWORD){
    auth = true;
    document.getElementById('pwd-error').style.display = 'none';
    setAppVisible(true);
    show('inventory');
    updateStats();
    renderAll();
  } else {
    document.getElementById('pwd-error').style.display = 'block';
  }
}
function logout(){
  auth = false;
  setAppVisible(false);
  document.getElementById('pwd-input').value = '';
  document.getElementById('pwd-error').style.display = 'none';
}

/* =========================
   BIOMETRIE (WebAuthn local)
========================= */
const BIO_KEY = 'biometric_credential_id';

function bufferToBase64Url(buffer){
  const bytes = new Uint8Array(buffer);
  let str = '';
  bytes.forEach(b => str += String.fromCharCode(b));
  return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
}
function base64UrlToBuffer(base64url){
  const pad = '='.repeat((4 - (base64url.length % 4)) % 4);
  const base64 = (base64url + pad).replace(/-/g, '+').replace(/_/g, '/');
  const raw = atob(base64);
  const buffer = new ArrayBuffer(raw.length);
  const bytes = new Uint8Array(buffer);
  for(let i=0;i<raw.length;i++) bytes[i] = raw.charCodeAt(i);
  return buffer;
}

async function biometricRegister(){
  const challenge = crypto.getRandomValues(new Uint8Array(32));
  const userId = crypto.getRandomValues(new Uint8Array(16));
  const publicKey = {
    challenge,
    rp: { name: 'Pharmacie Domicile' },
    user: {
      id: userId,
      name: 'local-user',
      displayName: 'Utilisateur'
    },
    pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
    authenticatorSelection: {
      authenticatorAttachment: 'platform',
      userVerification: 'required'
    },
    timeout: 60000,
    attestation: 'none'
  };
  const cred = await navigator.credentials.create({ publicKey });
  if(!cred) throw new Error('CrAation empreinte AchouAe');
  const id = bufferToBase64Url(cred.rawId);
  localStorage.setItem(BIO_KEY, id);
  return id;
}

async function biometricVerify(){
  const storedId = localStorage.getItem(BIO_KEY);
  if(!storedId){
    await biometricRegister();
  }
  const allowId = localStorage.getItem(BIO_KEY);
  if(!allowId) throw new Error('Aucune empreinte enregistrAe');
  const challenge = crypto.getRandomValues(new Uint8Array(32));
  const publicKey = {
    challenge,
    allowCredentials: [{
      type: 'public-key',
      id: base64UrlToBuffer(allowId),
      transports: ['internal']
    }],
    userVerification: 'required',
    timeout: 60000
  };
  const assertion = await navigator.credentials.get({ publicKey });
  if(!assertion) throw new Error('VArification AchouAe');
  return true;
}

/* =========================
   NAVIGATION
========================= */
function show(id){
  if(!auth) return;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  renderAll();
  if(id === 'to-buy') renderToBuy();
  if(id === 'alerts') renderAlertsSection();
  if(id === 'genre-search') renderGenreSection();
}

/* =========================
   STATS + LISTE ATTENTION
========================= */
function updateStats(){
  const today = new Date(); today.setHours(0,0,0,0);
  const limit = new Date(today); limit.setDate(today.getDate() + 30);

  let exp=0, pre=0, zer=0;
  let listHtml = '';

  meds.forEach(m=>{
    const e = new Date(m.expiry); e.setHours(0,0,0,0);
    const isExp = e < today;
    const isPre = !isExp && e <= limit;
    const isZero = Number(m.quantity) === 0;

    if(isExp) exp++;
    if(isPre) pre++;
    if(isZero) zer++;

    if(isExp || isPre || isZero){
      let status = '';
      if(isExp) status = 'EXPIRE';
      else if(isPre) status = 'PRE-EXPIRATION';
      else status = 'STOCK NUL';

      listHtml += `
        <div style="background:#fff;padding:1rem;margin:.5rem 0;border-radius:var(--radius);box-shadow:0 1px 4px var(--shadow);"><strong>${escapeHtml(m.name)}</strong> (${escapeHtml(m.dosage)}) - ${status}
          <br><small>Qte : ${Number(m.quantity)||0}, Exp : ${fmtMMAA(m.expiry)}</small></div>`;
    }
  });

  document.getElementById('total-meds').textContent = meds.length;
  document.getElementById('expired-count').textContent = exp;
  document.getElementById('preexp-count').textContent = pre;
  document.getElementById('zerostock-count').textContent = zer;

  document.getElementById('attention-list').innerHTML =
    listHtml || '<p style="color:#2e7d32;">Aucun probleme detecte</p>';
}

function getAlertFlags(m){
  const today = new Date(); today.setHours(0,0,0,0);
  const limit = new Date(today); limit.setDate(today.getDate() + 30);
  const exp = new Date(m.expiry); exp.setHours(0,0,0,0);
  const qty = Number(m.quantity) || 0;
  const expired = exp < today;
  const pre = !expired && exp <= limit;
  const zero = qty === 0;
  const low = qty > 0 && qty <= 5;
  return { expired, pre, zero, low };
}

function renderAlertsSection(){
  const tbody = document.querySelector('#alerts-table tbody');
  if(!tbody) return;
  const list = meds
    .filter(m => {
      const a = getAlertFlags(m);
      return a.expired || a.pre || a.zero || a.low;
    })
    .sort((a,b) => keyOf(a.name,a.dosage).localeCompare(keyOf(b.name,b.dosage)));

  if(list.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" class="empty-msg">Aucune alerte</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(m => {
    const a = getAlertFlags(m);
    const tags = [];
    if(a.expired) tags.push('EXPIRE');
    if(a.pre) tags.push('PRE-EXPIRATION');
    if(a.zero) tags.push('STOCK NUL');
    if(a.low) tags.push('STOCK FAIBLE');
    const idx = meds.indexOf(m);
    return `<tr>
      <td class="med-name-cell" style="color:#1976d2;font-weight:bold;cursor:pointer;text-decoration:underline;" onclick="openDetails(${idx})">${escapeHtml(m.name)}</td>
      <td>${escapeHtml(m.genre || '-')}</td>
      <td>${escapeHtml(m.dosage || '-')}</td>
      <td style="color:#d32f2f;font-weight:bold;">${Number(m.quantity)||0}</td>
      <td>${fmtMMAA(m.expiry)}</td>
      <td>${tags.join(' | ')}</td>
    </tr>`;
  }).join('');
}

function renderGenreSection(){
  const select = document.getElementById('genre-filter');
  const tbody = document.querySelector('#genre-table tbody');
  if(!select || !tbody) return;

  const genres = [...new Set(meds.map(m => String(m.genre || '').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const current = select.value || 'ALL';
  select.innerHTML = `<option value="ALL">Tous les genres</option>` + genres.map(g=>`<option value="${escapeAttr(g)}">${escapeHtml(g)}</option>`).join('');
  if([...select.options].some(o => o.value === current)) select.value = current;

  const list = meds
    .filter(m => select.value === 'ALL' ? true : String(m.genre || '') === select.value)
    .sort((a,b) => keyOf(a.name,a.dosage).localeCompare(keyOf(b.name,b.dosage)));

  if(list.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" class="empty-msg">Aucun resultat</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(m => {
    const idx = meds.indexOf(m);
    return `<tr>
      <td class="med-name-cell" style="color:#1976d2;font-weight:bold;cursor:pointer;text-decoration:underline;" onclick="openDetails(${idx})">${escapeHtml(m.name)}</td>
      <td>${escapeHtml(m.genre || '-')}</td>
      <td>${escapeHtml(m.dosage || '-')}</td>
      <td style="color:#d32f2f;font-weight:bold;">${Number(m.quantity)||0}</td>
      <td>${fmtMMAA(m.expiry)}</td>
    </tr>`;
  }).join('');
}

function setupExtraMenus(){
  const navUl = document.querySelector('#main-nav ul');
  const main = document.getElementById('main');
  if(!navUl || !main) return;

  if(!document.querySelector('nav a[data-target="alerts"]')){
    const li = document.createElement('li');
    li.innerHTML = '<a href="#" data-target="alerts">Alertes</a>';
    navUl.insertBefore(li, document.getElementById('logout-link')?.parentElement || null);
  }
  if(!document.getElementById('alerts')){
    main.insertAdjacentHTML('beforeend', `
      <section id="alerts" class="section">
        <h2>Alertes</h2>
        <table id="alerts-table">
          <thead><tr><th>Nom</th><th>Genre</th><th>Dosage</th><th>Qte</th><th>Peremption</th><th>Alerte</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    `);
  }

  if(!document.querySelector('nav a[data-target="genre-search"]')){
    const li = document.createElement('li');
    li.innerHTML = '<a href="#" data-target="genre-search">Recherche genre</a>';
    navUl.insertBefore(li, document.getElementById('logout-link')?.parentElement || null);
  }
  if(!document.getElementById('genre-search')){
    main.insertAdjacentHTML('beforeend', `
      <section id="genre-search" class="section">
        <h2>Recherche par genre</h2>
        <div class="form-group" style="max-width:420px;margin-top:1rem;">
          <label for="genre-filter">Genre</label>
          <select id="genre-filter"></select>
        </div>
        <table id="genre-table">
          <thead><tr><th>Nom</th><th>Genre</th><th>Dosage</th><th>Qte</th><th>Peremption</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    `);
  }
}

function collapseHiddenNavItems(){
  document.querySelectorAll('#main-nav li').forEach(li => {
    const a = li.querySelector('a.nav-hidden');
    if(a) li.style.display = 'none';
  });
}

/* =========================
   RECHERCHE PAR SECTION
========================= */
function getActiveSearchValue(){
  const activeSection = document.querySelector('.section.active');
  if(!activeSection) return '';
  const input = activeSection.querySelector('input[id^="search"]');
  return input ? (input.value || '').toLowerCase() : '';
}

/* =========================
   RENDU TABLEAUX
========================= */
function renderAll(){
  if(!auth) return;

  const filter = getActiveSearchValue();

  const filtered = filter ? meds.filter(m => {
    const n = (m.name || '').toLowerCase();
    const d = (m.dosage || '').toLowerCase();
    const no = (m.notes || '').toLowerCase();
    return n.includes(filter) || d.includes(filter) || no.includes(filter);
  }) : meds;
  const filteredSorted = [...filtered].sort((a, b) => {
    const n1 = (a.name || '').toLowerCase();
    const n2 = (b.name || '').toLowerCase();
    if (n1 !== n2) return n1.localeCompare(n2);
    const d1 = (a.dosage || '').toLowerCase();
    const d2 = (b.dosage || '').toLowerCase();
    return d1.localeCompare(d2);
  });

  function renderTable(tableId){
    const tbody = document.querySelector(`#${tableId} tbody`);
    if(!tbody) return;

    tbody.innerHTML = '';

    if(filteredSorted.length === 0){
      const colCount =
        tableId === 'med-table' ? 7 :
        tableId === 'med-table-edit' ? 6 :
        tableId === 'med-table-delete' ? 6 :
        tableId === 'med-table-use' ? 6 : 7;

      tbody.innerHTML = `<tr><td colspan="${colCount}" class="empty-msg">Aucun mAdicament trouvA</td></tr>`;
      return;
    }

    filteredSorted.forEach(m=>{
      const idx = meds.indexOf(m);
      const expCls = expClass(m.expiry);
      const stkCls = stockClass(Number(m.quantity));
      const q = Number(m.quantity) || 0;
      const imgUrl = m.imageUrl ? escapeAttr(m.imageUrl) : '';
      const imgHtml = imgUrl ? `<img class="med-thumb" src="${imgUrl}" alt="">` : `<span class="med-thumb"></span>`;

      // Calcul des alertes
      let alertMsgs = [];
      if (q < 5) alertMsgs.push('<span style="color:#d32f2f;font-weight:bold;">stock < 5</span>');
      
      const today = new Date(); today.setHours(0,0,0,0);
      const exp = new Date(m.expiry); exp.setHours(0,0,0,0);
      const diffDays = Math.ceil((exp - today) / (1000*60*60*24));
      if (diffDays <= 30) alertMsgs.push('<span style="color:#f57c00;font-weight:bold;">date < 1mois</span>');

      let alertHtml = alertMsgs.length > 0 ? alertMsgs.join('<br>') : '-';

      let row = `
        <tr class="${stkCls}"><td class="med-name-cell" style="color:#1976d2;font-weight:bold;cursor:pointer;text-decoration:underline;" title="Voir dAtails" onclick="openDetails(${idx})">${imgHtml}<span>${escapeHtml(m.name)}</span></td>
      `;
      if(tableId === 'med-table'){
        row += `<td>${escapeHtml(m.genre || '-')}</td>`;
      }
      row += `
          <td>${escapeHtml(m.dosage)}</td><td style="color:#d32f2f;font-weight:bold;font-size:1.1em;">${q}</td><td class="${expCls}">${fmtMMAA(m.expiry)}</td><td>${alertHtml}</td>
      `;

      if(tableId === 'med-table'){
        row += `
          <td><button class="action-btn edit" title="Modifier" onclick="openEdit(${idx})">&#9998;</button><button class="action-btn delete" title="Supprimer" onclick="removeMed(${idx})">&#128465;</button><button class="action-btn use" title="Utiliser" onclick="useMed(${idx})">&#128138;</button></td>
        `;
      } else if(tableId === 'med-table-edit'){
        row += `
          <td><button class="action-btn edit" title="Modifier" onclick="openEdit(${idx})">&#9998;</button></td>
        `;
      } else if(tableId === 'med-table-delete'){
        row += `
          <td><button class="action-btn delete" title="Supprimer" onclick="removeMed(${idx})">&#128465;</button></td>
        `;
      } else if(tableId === 'med-table-use'){
        row += `
          <td><button class="action-btn use" title="Utiliser" onclick="useMed(${idx})">&#128138;</button></td>
        `;
      }

      row += `</tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  renderTable('med-table');
  renderTable('med-table-edit');
  renderTable('med-table-delete');
  renderTable('med-table-use');
  if(document.getElementById('alerts')?.classList.contains('active')) renderAlertsSection();
  if(document.getElementById('genre-search')?.classList.contains('active')) renderGenreSection();

  // Valeur totale supprimAe (prix non affichA)
}

/* =========================
   AJOUT (avec alerte + cumul)
========================= */
document.getElementById('add-form').addEventListener('submit', async function(e){
  e.preventDefault();

  const name = normalizeName(document.getElementById('name').value);
  const dosage = normalizeName(document.getElementById('dosage').value);
  const genre = document.getElementById('genre').value;
  const purchaseDateEl = document.getElementById('purchase-date');
  const purchaseDateCustomEl = document.getElementById('purchase-date-custom');
  let purchaseDate = purchaseDateEl ? purchaseDateEl.value : '';
  if(!purchaseDateCustomEl || !purchaseDateCustomEl.checked){
    purchaseDate = getTodayISODate();
  }
  if(!purchaseDate) purchaseDate = getTodayISODate();

  const initialStock = parseInt(document.getElementById('initial-stock').value, 10) || 0;
  const quantity = parseInt(document.getElementById('quantity').value, 10) || 0;

  const priceVal = parseFloat(document.getElementById('price').value);
  const price = Number.isFinite(priceVal) ? priceVal : 0;

  const nbBoxes = parseInt(document.getElementById('nb-boxes').value, 10) || 1;

  const expiryMMAA = document.getElementById('expiry-mmaa').value;
  const expiryISO = parseMMAAtoISO(expiryMMAA);
  if(!expiryISO){
    alert("a Date invalide. Utilise MM/AA (ex : 02/26).");
    return;
  }

  const notes = document.getElementById('notes').value.trim();
  const now = new Date().toISOString();
  const imageFile = document.getElementById('image-file') ? document.getElementById('image-file').files[0] : null;
  const imageUrl = await uploadMedImageIfAny(imageFile, name, dosage);

  const k = keyOf(name, dosage);
  const existingIndex = meds.findIndex(m => keyOf(m.name, m.dosage) === k);

  if(existingIndex === -1){
    const newMed = {
      name, dosage, genre, initialStock, quantity, price, nbBoxes,
      expiry: expiryISO, notes, purchaseDate, imageUrl,
      created_at: now,
      updated_at: now,
      _localModified: true
    };
    meds.push(newMed);
    save();

    // Sauvegarder vers cloud IMMADIATEMENT
    if(window.addMedicament){
      addMedicament({
        name, dosage, genre, initialStock, quantity, price, nbBoxes,
        expiry: expiryISO, notes, purchaseDate, imageUrl
      }).then(result => {
        if(result.error){
          console.error('Erreur ajout cloud:', result.error);
        } else {
          console.log('a... Ajout cloud rAussi');
          // Assigner l'ID retournA au mAdicament local
          if(result.data && result.data[0] && result.data[0].id){
            meds[meds.length - 1].id = result.data[0].id;
            meds[meds.length - 1].updated_at = new Date().toISOString();
            save();
            console.log('ID cloud assignA:', result.data[0].id);
          }
        }
      });
    }

    e.target.reset();
    if(purchaseDateEl && purchaseDateCustomEl){
      purchaseDateCustomEl.checked = false;
      purchaseDateEl.disabled = true;
      purchaseDateEl.value = getTodayISODate();
    }
    if(document.getElementById('image-file')) document.getElementById('image-file').value = '';
    show('inventory');
    renderAll();
    updateStats();
    return;
  }

  const ex = meds[existingIndex];

  const msg =
`as i  Ce mAdicament existe dAjA  :
- ${ex.name} (${ex.dosage})

Stock actuel :
- QuantitA actuelle : ${ex.quantity}
- Stock initial : ${ex.initialStock}
- Prix : ${Number(ex.price||0).toFixed(2)} DH
- Peremption : ${fmtMMAA(ex.expiry)}

Nouvelle saisie :
- +Qte : ${quantity}
- +Stock init. : ${initialStock}
- Nouveau prix : ${price.toFixed(2)} DH (remplace l'ancien)
- Peremption : ${fmtMMAA(expiryISO)}

a... Voulez-vous ACTUALISER (cumuler les stocks) `;

  if(!confirm(msg)) return;

  ex.quantity = (Number(ex.quantity)||0) + quantity;
  ex.initialStock = (Number(ex.initialStock)||0) + initialStock;
  ex.price = price; // dernier prix remplace
  ex.nbBoxes = nbBoxes;
  ex.genre = genre;
  ex.expiry = earliestExpiry(ex.expiry, expiryISO);
  ex.notes = mergeNotes(ex.notes, notes);
  ex.purchaseDate = purchaseDate;
  if(imageUrl) ex.imageUrl = imageUrl;
  ex._localModified = true; // Marquer comme modifiA localement

  meds[existingIndex] = ex;
  save();
  
  // Mettre A  jour le cloud IMMADIATEMENT
  if(window.updateMedicament && ex.id){
    updateMedicament(ex.id, ex).then(result => {
      if(result.error){
        console.error('Erreur update cloud:', result.error);
      } else {
        console.log('a... Update cloud rAussi');
      }
    });
  }
  
  e.target.reset();
  show('inventory');
  renderAll();
  updateStats();
});

/* =========================
   EDITION (MM/AA)
========================= */
function openEdit(idx){
  const m = meds[idx];
  if(!m) return;

  document.getElementById('edit-index').value = idx;
  document.getElementById('edit-name').value = m.name || '';
  document.getElementById('edit-dosage').value = m.dosage || '';
  document.getElementById('edit-genre').value = m.genre || '';
  document.getElementById('edit-quantity').value = Number(m.quantity) || 0;
  document.getElementById('edit-initial').value = Number(m.initialStock) || 0;
  document.getElementById('edit-price').value = Number(m.price) || 0;
  document.getElementById('edit-nb-boxes').value = Number(m.nbBoxes) || 1;
  document.getElementById('edit-expiry-mmaa').value = fmtMMAA(m.expiry);
  document.getElementById('edit-notes').value = m.notes || '';
  const editPurchaseDate = document.getElementById('edit-purchase-date');
  const editPurchaseCustom = document.getElementById('edit-purchase-date-custom');
  if(editPurchaseDate && editPurchaseCustom){
    const today = getTodayISODate();
    const val = m.purchaseDate || today;
    editPurchaseDate.value = val;
    const isCustom = val !== today;
    editPurchaseCustom.checked = isCustom;
    editPurchaseDate.disabled = !isCustom;
  }

  document.getElementById('edit-modal').style.display = 'flex';
}
function closeEdit(){ document.getElementById('edit-modal').style.display = 'none'; }
document.getElementById('edit-cancel').addEventListener('click', closeEdit);

document.getElementById('edit-form').addEventListener('submit', async function(e){
  e.preventDefault();

  const idx = parseInt(document.getElementById('edit-index').value, 10);
  if(Number.isNaN(idx) || !meds[idx]) return;

  const name = normalizeName(document.getElementById('edit-name').value);
  const dosage = normalizeName(document.getElementById('edit-dosage').value);
  const genre = document.getElementById('edit-genre').value;
  const editPurchaseDate = document.getElementById('edit-purchase-date');
  const editPurchaseCustom = document.getElementById('edit-purchase-date-custom');
  let purchaseDate = editPurchaseDate ? editPurchaseDate.value : '';
  if(!editPurchaseCustom || !editPurchaseCustom.checked){
    purchaseDate = (meds[idx] && meds[idx].purchaseDate) ? meds[idx].purchaseDate : getTodayISODate();
  }
  if(!purchaseDate) purchaseDate = getTodayISODate();

  const initialStock = parseInt(document.getElementById('edit-initial').value, 10) || 0;
  const quantity = parseInt(document.getElementById('edit-quantity').value, 10) || 0;

  const priceVal = parseFloat(document.getElementById('edit-price').value);
  const price = Number.isFinite(priceVal) ? priceVal : 0;

  const nbBoxes = parseInt(document.getElementById('edit-nb-boxes').value, 10) || 1;

  const expiryMMAA = document.getElementById('edit-expiry-mmaa').value;
  const expiryISO = parseMMAAtoISO(expiryMMAA);
  if(!expiryISO){
    alert("a Date invalide. Utilise MM/AA (ex : 02/26).");
    return;
  }

  const notes = document.getElementById('edit-notes').value.trim();
  const editImageFile = document.getElementById('edit-image-file') ? document.getElementById('edit-image-file').files[0] : null;
  const imageUrl = await uploadMedImageIfAny(editImageFile, name, dosage);

  // si modifie vers un existant => proposer fusion
  const newKey = keyOf(name, dosage);
  const otherIndex = meds.findIndex((m, i) => i !== idx && keyOf(m.name, m.dosage) === newKey);

  if(otherIndex !== -1){
    const target = meds[otherIndex];
    const msg =
`as i  Un autre mAdicament existe dAjA  avec le mAame Nom+Dosage :
- ${target.name} (${target.dosage})

Voulez-vous FUSIONNER (cumuler) ce mAdicament modifiA avec l'existant `;

    if(confirm(msg)){
      const oldId = meds[idx].id;
      target.quantity = (Number(target.quantity)||0) + quantity;
      target.initialStock = (Number(target.initialStock)||0) + initialStock;
      target.price = price; // dernier prix remplace
      target.nbBoxes = nbBoxes;
      target.genre = genre;
      target.expiry = earliestExpiry(target.expiry, expiryISO);
      target.notes = mergeNotes(target.notes, notes);
      if(!target.purchaseDate) target.purchaseDate = purchaseDate;
      if(imageUrl) target.imageUrl = imageUrl;
      target._localModified = true; // Marquer comme modifiA localement

      meds[otherIndex] = target;
      meds.splice(idx, 1);

      save();
      
      // Mettre A  jour le cloud IMMADIATEMENT
      if(window.updateMedicament && target.id){
        updateMedicament(target.id, target).then(result => {
          if(result.error){
            console.error('Erreur update cloud:', result.error);
          } else {
            console.log('a... Update cloud rAussi (fusion)');
          }
        });
      }
      // Supprimer l'ancien en cloud si nAcessaire
      if(window.deleteMedicament && oldId && oldId !== target.id){
        deleteMedicament(oldId).then(result => {
          if(result && result.error){
            console.error('Erreur suppression cloud (ancien):', result.error);
          }
        });
      }
      
      closeEdit();
      renderAll();
      updateStats();
      return;
    }
  }

  const keepId = meds[idx].id;
  meds[idx] = { name, dosage, genre, quantity, initialStock, price, nbBoxes, expiry: expiryISO, notes, purchaseDate, imageUrl: (imageUrl || meds[idx].imageUrl || '') };
  if(keepId) meds[idx].id = keepId;
  meds[idx]._localModified = true; // Marquer comme modifiA localement
  save();

  // Mettre A  jour le cloud IMMADIATEMENT
  if(window.updateMedicament && meds[idx].id){
    updateMedicament(meds[idx].id, { name, dosage, genre, quantity, initialStock, price, nbBoxes, expiry: expiryISO, notes, purchaseDate, imageUrl: (imageUrl || meds[idx].imageUrl || '') }).then(result => {
      if(result.error){
        console.error('Erreur update cloud:', result.error);
      } else {
        console.log('a... Update cloud rAussi');
      }
    });
  }
  
  closeEdit();
  renderAll();
  updateStats();
  if(document.getElementById('edit-image-file')) document.getElementById('edit-image-file').value = '';
});

/* =========================
   SUPPRESSION / UTILISATION
========================= */
function removeMed(idx){
  const m = meds[idx];
  if(!m) return;
  if(confirm(`Supprimer "${m.name} (${m.dosage})" `)){
    const key = keyOf(m.name, m.dosage);
    markPendingDelete(key);

    // Supprimer du cloud IMMADIATEMENT (avec fallback nom+dosage)
    if(window.deleteMedicament){
      deleteMedicament(m.id, m.name, m.dosage).then(result => {
        if(result && result.error){
          console.error('a Erreur suppression cloud:', result.error);
        } else {
          clearPendingDelete(key);
          console.log('a... Suppression cloud rAussie');
        }
      });
    }

    meds.splice(idx, 1);
    save();
    renderAll();
    updateStats();
  }
}

function useMed(idx){
  const m = meds[idx];
  if(!m) return;

  const qty = parseInt(document.getElementById('use-qty').value, 10) || 1;
  if(qty <= 0){ alert("a QuantitA invalide."); return; }

  if(Number(m.quantity) >= qty){
    const oldQty = Number(m.quantity);
    m.quantity = Number(m.quantity) - qty;
    m._localModified = true; // Marquer comme modifiA localement
    save();
    
    logDebug('YS UTILISER: ' + m.name + ' -' + qty + ' (Atait:' + oldQty + ', maintenant:' + m.quantity + ')');
    
    // Si stock ApuisA, supprimer localement seulement (pas de sync)
    if(m.quantity === 0){
      logInfo('Yi  Stock ApuisA - suppression locale de ' + m.name);
      const key = keyOf(m.name, m.dosage);
      markPendingDelete(key);
      if(window.deleteMedicament){
        deleteMedicament(m.id, m.name, m.dosage).then(result => {
          if(result && result.error){
            logError('a Erreur suppression cloud: ' + result.error);
          } else {
            clearPendingDelete(key);
            logSuccess('a... Suppression cloud: ' + m.name);
          }
        });
      }

      // Supprimer de la liste locale seulement
      setTimeout(() => {
        const medIdx = meds.findIndex(x => x.id === m.id);
        if(medIdx !== -1){
          meds.splice(medIdx, 1);
          save();
          renderAll();
          updateStats();
        }
      }, 100);

      alert(`a1i  DerniA re unitA de ${m.name} utilisAe a stock ApuisA.`);
    } else {
      // Mettre A  jour le cloud IMMADIATEMENT avec nouvelle quantitA
      if(window.updateMedicament && m.id){
        updateMedicament(m.id, m).then(result => {
          if(result.error){
            logError('Erreur sync cloud: ' + result.error);
          } else {
            logSuccess('a... Sync: ' + m.name + ' = ' + m.quantity);
          }
        });
      }
      
      renderAll();
      updateStats();
      
      if(m.quantity <= 5){
        alert(`as i  Stock faible : il ne reste plus que ${m.quantity} unitA(s) de ${m.name}.`);
      }
    }
  } else {
    alert(`a Stock insuffisant ! ${m.name} possA de seulement ${m.quantity} unitA(s).`);
  }
}

/* =========================
   A acheter (Liste de courses)
========================= */
function renderToBuy(){
  const tbody = document.querySelector('#tobuy-table tbody');
  if(!tbody) return;
  
  tbody.innerHTML = '';
  
  // DAdupliquer par nom (prAfArer item avec id)
  const dedupMap = {};
  toBuyList.forEach(item => {
    const key = (item.name || '').toLowerCase().trim();
    if(!key) return;
    if(!dedupMap[key] || (!dedupMap[key].id && item.id)){
      dedupMap[key] = item;
    }
  });
  toBuyList = Object.values(dedupMap);

  if(toBuyList.length === 0){
    tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">Aucun mAdicament dans la liste</td></tr>';
    return;
  }
  
  // Trier par ordre alphabAtique
  const sortedList = [...toBuyList].sort((a, b) => 
    a.name.toLowerCase().localeCompare(b.name.toLowerCase())
  );
  
  sortedList.forEach((item)=>{
    const idAttr = item.id ? String(item.id) : '';
    const nameAttr = String(item.name || '');
    tbody.innerHTML += `
      <tr><td style="color:#1976d2;font-weight:bold;">${escapeHtml(item.name)}</td><td style="color:#d32f2f;font-weight:bold;font-size:1.1em;">${item.qty}</td><td>${escapeHtml(item.notes || '-')}</td><td><button class="action-btn delete tobuy-delete" data-id="${escapeAttr(idAttr)}" data-name="${escapeAttr(nameAttr)}">&#128465;</button></td></tr>
    `;
  });
}

// Supprimer par id si possible (fallback nom)
function removeToBuyItem(id, name){
  if(!confirm('Supprimer "' + name + '" de la liste ')) return;
  markPendingToBuyDelete(id, name);
  
  // Trouver l'index
  const idStr = id ? String(id) : '';
  const nameStr = String(name || '');
  const idx = toBuyList.findIndex(item => 
    (idStr && String(item.id || '') === idStr) ||
    String(item.name || '').toLowerCase() === nameStr.toLowerCase()
  );
  
  if(idx === -1) {
    console.log('as i  Article non trouvA:', name);
    return;
  }
  
  toBuyList.splice(idx, 1);
  localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
  renderToBuy();

  // Sync vers cloud - suppression activAe avec confirmation
  if(window.deleteAchatById && idStr){
    console.log('a i  Suppression cloud (id):', idStr);
    deleteAchatById(idStr).then((result) => {
      if(result && result.error){
        throw new Error((result.status ? ('HTTP ' + result.status + ' ') : '') + result.error);
      }
      clearPendingToBuyDelete(idStr, nameStr);
      console.log('a... Suppression cloud confirmAe pour id:', idStr);
      setTimeout(() => {
        loadToBuyFromCloud();
      }, 500);
    }).catch(e => {
      console.error('a Erreur suppression cloud:', e);
      if(window.deleteAchatByName){
        console.log('a i  Fallback suppression cloud (nom):', nameStr);
        deleteAchatByName(nameStr).then((r) => {
          if(r && r.error){
            throw new Error((r.status ? ('HTTP ' + r.status + ' ') : '') + r.error);
          }
          clearPendingToBuyDelete(idStr, nameStr);
          loadToBuyFromCloud();
        }).catch(err => {
          console.error('a Erreur suppression cloud (nom):', err);
          alert('a Suppression cloud refusAe: ' + err.message);
          loadToBuyFromCloud();
        });
      } else {
        alert('a Suppression cloud refusAe.');
        loadToBuyFromCloud();
      }
    });
  } else if(window.deleteAchatByName){
    console.log('a i  Suppression cloud (nom):', nameStr);
    deleteAchatByName(nameStr).then((result) => {
      if(result && result.error){
        throw new Error((result.status ? ('HTTP ' + result.status + ' ') : '') + result.error);
      }
      clearPendingToBuyDelete(idStr, nameStr);
      loadToBuyFromCloud();
    }).catch(e => {
      console.error('a Erreur suppression cloud:', e);
      alert('a Suppression cloud refusAe: ' + e.message);
      loadToBuyFromCloud();
    });
  }
}

function removeToBuy(idx){
  if(confirm('Supprimer ce mAdicament de la liste ')){
    var deletedItem = toBuyList[idx];
    var deletedName = deletedItem.name;
    var deletedId = deletedItem.id;
    
    toBuyList.splice(idx, 1);
    localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
    renderToBuy();
    
    // Sync IMMADIAT vers cloud - suppression directe
    if(window.deleteAchatById && deletedId){
      console.log('a i  Suppression immAdiate id', deletedId, 'du cloud');
      deleteAchatById(deletedId);
    } else if(window.deleteAchatByName){
      console.log('a i  Suppression immAdiate de', deletedName, 'du cloud');
      deleteAchatByName(deletedName);
    }
  }
}

document.getElementById('tobuy-form').addEventListener('submit', function(e){
  e.preventDefault();

  const name = normalizeName(document.getElementById('tobuy-name').value);
  const qty = parseInt(document.getElementById('tobuy-qty').value, 10) || 1;
  const notes = document.getElementById('tobuy-notes').value.trim();

  if(!name) return;

  // VArifier si l'article existe dAjA 
  const existingIndex = toBuyList.findIndex(item =>
    item.name.toLowerCase() === name.toLowerCase()
  );

  let shouldInsert = false;
  let targetIndex = -1;

  if(existingIndex !== -1){
    // Cumuler les quantitAs
    toBuyList[existingIndex].qty += qty;
    toBuyList[existingIndex].notes = mergeNotes(toBuyList[existingIndex].notes, notes);
    targetIndex = existingIndex;

    const existingId = toBuyList[existingIndex].id;
    if(window.updateAchatById && existingId){
      updateAchatById(existingId, {
        name,
        qty: toBuyList[existingIndex].qty,
        notes: toBuyList[existingIndex].notes
      }).then(() => {
        loadToBuyFromCloud();
      });
    } else {
      shouldInsert = true;
    }
  } else {
    // Ajouter nouveau
    toBuyList.push({ name, qty, notes });
    shouldInsert = true;
    targetIndex = toBuyList.length - 1;
  }

  localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));

  // Sync vers cloud immAdiatement (uniquement si nouvel enregistrement)
  if(shouldInsert){
    if(window.addAchat){
      console.log('a i  Sync ajout achat vers cloud:', { name, qty, notes });
      addAchat({ name, qty, notes }).then((res) => {
        if(res && res.data && res.data[0] && res.data[0].id){
          const newId = res.data[0].id;
          if(targetIndex !== -1 && toBuyList[targetIndex]){
            toBuyList[targetIndex].id = newId;
            localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
            renderToBuy();
          }
        }
        loadToBuyFromCloud();
      });
    } else {
      console.warn('as i  addAchat non disponible');
    }
  }

  e.target.reset();
  document.getElementById('tobuy-qty').value = 1;
  renderToBuy();
});

/* =========================
   SAUVEGARDE / RESTAURATION / VIDAGE
========================= */
function downloadJSON(filename, dataObj){
  const json = JSON.stringify(dataObj, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function saveBackup(){
  if(!auth) return;
  const payload = {
    app: "pharmacie_domicile",
    version: 1,
    exportedAt: new Date().toISOString(),
    medicines: meds
  };
  downloadJSON("pharmacie-stock.json", payload);
  alert("a... Sauvegarde tAlAchargAe : pharmacie-stock.json");
}

function restoreBackupFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);

      // accepter 2 formats:
      // - { medicines: [...] }
      // - [...] (liste directe)
      const list = Array.isArray(obj) ? obj : (obj && Array.isArray(obj.medicines) ? obj.medicines : null);
      if(!list) throw new Error("Format invalide");

      // validation minimale
      const cleaned = list.map(x => ({
        name: normalizeName(x.name),
        dosage: normalizeName(x.dosage),
        genre: x.genre || '',
        quantity: Number(x.quantity)||0,
        initialStock: Number(x.initialStock)||0,
        price: Number(x.price)||0,
        nbBoxes: Number(x.nbBoxes)||1,
        expiry: x.expiry,
        notes: (x.notes||"").toString(),
        imageUrl: x.imageUrl || x.image_url || ''
      }));

      meds = cleaned;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
      localStorage.setItem(SEEDED_KEY, "1");

      renderAll();
      updateStats();
      alert("a... Restauration terminAe !");
    }catch(err){
      alert("a Impossible de restaurer : fichier JSON invalide.");
    }
  };
  reader.readAsText(file);
}

function restoreBackup(){
  if(!auth) return;
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json,.json";
  input.onchange = () => {
    if(input.files && input.files[0]){
      const ok = confirm("as i  Restaurer va remplacer ton stock actuel. Continuer ");
      if(!ok) return;
      restoreBackupFromFile(input.files[0]);
    }
  };
  input.click();
}

function clearAllStock(){
  if(!auth) return;
  const ok = confirm("Y1 Voulez-vous VRAIMENT vider tout le stock  Cette action est irrAversible.");
  if(!ok) return;

  meds = [];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
  localStorage.setItem(SEEDED_KEY, "1");

  // Effacer aussi le cloud
  if(window.clearAllCloudMeds){
    clearAllCloudMeds().then(() => {
      alert('a... Stock local ET cloud effacAs.');
    }).catch(e => {
      console.error('Erreur effacement cloud:', e);
      alert('a... Stock local effacA. Le cloud n\'a pas pu Aatre effacA.');
    });
  } else {
    alert('a... Stock local effacA.');
  }

  renderAll();
  updateStats();
}

/* =========================
   AVANEMENTS UI
========================= */
document.getElementById('pwd-btn').addEventListener('click', checkPwd);
document.getElementById('bio-btn').addEventListener('click', async ()=>{
  if(!window.PublicKeyCredential || !navigator.credentials){
    alert("a Empreinte non supportAe sur cet appareil.");
    return;
  }
  try{
    await biometricVerify();
    auth = true;
    document.getElementById('pwd-error').style.display = 'none';
    setAppVisible(true);
    show('inventory');
    updateStats();
    renderAll();
  } catch(e){
    alert('a Empreinte refusAe ou indisponible.');
  }
});
document.getElementById('logout-link').addEventListener('click', (e)=>{ e.preventDefault(); logout(); });
document.getElementById('details-close-btn').addEventListener('click', closeDetails);
document.getElementById('details-modal').addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'details-modal') closeDetails();
});
document.getElementById('image-zoom-modal').addEventListener('click', closeImageZoom);
const appVersionEl = document.getElementById('app-version');
if(appVersionEl) appVersionEl.textContent = APP_VERSION;
if(DEBUG_LOGS) console.log('App version:', APP_VERSION);

const purchaseDateInput = document.getElementById('purchase-date');
const purchaseDateCustom = document.getElementById('purchase-date-custom');
if(purchaseDateInput && purchaseDateCustom){
  purchaseDateInput.value = getTodayISODate();
  purchaseDateCustom.addEventListener('change', ()=>{
    purchaseDateInput.disabled = !purchaseDateCustom.checked;
    if(!purchaseDateCustom.checked){
      purchaseDateInput.value = getTodayISODate();
    }
  });
}
const editPurchaseDateInput = document.getElementById('edit-purchase-date');
const editPurchaseDateCustom = document.getElementById('edit-purchase-date-custom');
if(editPurchaseDateInput && editPurchaseDateCustom){
  editPurchaseDateCustom.addEventListener('change', ()=>{
    editPurchaseDateInput.disabled = !editPurchaseDateCustom.checked;
    if(!editPurchaseDateCustom.checked){
      editPurchaseDateInput.value = getTodayISODate();
    }
  });
}

// Dark mode toggle
const themeToggle = document.getElementById('theme-toggle');
if(themeToggle) {
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  });
}

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if(savedTheme === 'dark') {
  document.body.classList.add('dark-mode');
}

setupExtraMenus();
collapseHiddenNavItems();

document.addEventListener('change', (e)=>{
  if(e.target && e.target.id === 'genre-filter'){
    renderGenreSection();
  }
});

document.querySelectorAll('nav a[data-target]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    show(a.getAttribute('data-target'));
  });
});

// Suppression "A acheter" via dAlAgation (Avite les onclick cassAs)
document.addEventListener('click', (e)=>{
  const btn = e.target && e.target.closest ? e.target.closest('.tobuy-delete') : null;
  if(!btn) return;
  e.preventDefault();
  const id = btn.getAttribute('data-id') || '';
  const name = btn.getAttribute('data-name') || '';
  removeToBuyItem(id || null, name || '');
});

// actions backup
document.getElementById('btn-save').addEventListener('click', (e)=>{ e.preventDefault(); saveBackup(); });
document.getElementById('btn-restore').addEventListener('click', (e)=>{ e.preventDefault(); restoreBackup(); });
document.getElementById('btn-clear').addEventListener('click', (e)=>{ e.preventDefault(); clearAllStock(); });
document.getElementById('btn-clean-dup').addEventListener('click', (e)=>{ e.preventDefault(); clearLocalDuplicates(); });
document.getElementById('btn-reset-all').addEventListener('click', async (e)=>{
  e.preventDefault();
  if(!confirm('Tout effacer (local + cloud) ? Cette action est irreversible.')) return;

  // Effacer cloud
  try {
    if(window.clearAllCloudMeds) await clearAllCloudMeds();
    if(window.clearAchats) await clearAchats();
  } catch(e) {
    console.warn('Erreur effacement cloud:', e);
  }

  // Effacer local
  meds = [];
  toBuyList = [];
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(TOBUY_KEY);
  localStorage.removeItem(SEEDED_KEY);
  localStorage.removeItem(PENDING_DELETE_KEY);

  renderAll();
  renderToBuy();
  updateStats();
  alert('a... DonnAes locales et cloud effacAes.');
});
document.getElementById('btn-clear-local').addEventListener('click', (e)=>{
  e.preventDefault();
  if(!confirm('as i  Vider uniquement les donnAes locales ')) return;
  meds = [];
  toBuyList = [];
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(TOBUY_KEY);
  localStorage.removeItem(SEEDED_KEY);
  localStorage.removeItem(PENDING_DELETE_KEY);
  localStorage.removeItem(PENDING_TOBUY_DELETE_KEY);
  renderAll();
  renderToBuy();
  updateStats();
  alert('a... DonnAes locales effacAes.');
});

const toBuyToggle = document.getElementById('tobuy-toggle');
const toBuyForm = document.getElementById('tobuy-form');
if(toBuyToggle && toBuyForm){
  toBuyToggle.addEventListener('click', (e)=>{
    e.preventDefault();
    const isHidden = toBuyForm.style.display === 'none' || toBuyForm.style.display === '';
    toBuyForm.style.display = isHidden ? 'block' : 'none';
    toBuyToggle.textContent = isHidden ? 'Fermer' : 'Ajouter';
  });
}

// recherches live
['search','search-edit','search-delete','search-use'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', renderAll);
});

// auto-format MM/AA
function attachMMAAFormatter(inputId){
  const el = document.getElementById(inputId);
  if(!el) return;
  el.addEventListener('input', ()=>{
    let v = el.value.replaceAll("/","").replace(/\D/g,'').slice(0,4);
    if(v.length >= 3) v = v.slice(0,2) + "/" + v.slice(2);
    el.value = v;
  });
}
attachMMAAFormatter('expiry-mmaa');
attachMMAAFormatter('edit-expiry-mmaa');

// clavier : Enter login, Escape edit
document.addEventListener('keydown', e=>{
  if(e.key === "Enter" && document.getElementById('pwd-modal').style.display !== 'none'){
    checkPwd();
  }
  if(e.key === "Escape" && document.getElementById('edit-modal').style.display === 'flex'){
    closeEdit();
  }
});

/* =========================
   DEBUG LOG SYNC
========================= */
function logDebug(msg, type){
  const debugDiv = document.getElementById('debug-sync');
  if(!debugDiv) return;
  
  debugDiv.style.display = 'block';
  const time = new Date().toLocaleTimeString();
  const cssClass = type === 'success' ? 'log-success' : (type === 'error' ? 'log-error' : 'log-info');
  
  const entry = document.createElement('div');
  entry.className = 'log-entry ' + cssClass;
  entry.textContent = '[' + time + '] ' + msg;
  
  debugDiv.appendChild(entry);
  debugDiv.scrollTop = debugDiv.scrollHeight;
  
  // Garder que les 20 derniA res lignes
  while(debugDiv.children.length > 20){
    debugDiv.removeChild(debugDiv.firstChild);
  }
}
function logSuccess(msg){ logDebug(msg, 'success'); }
function logError(msg){ logDebug(msg, 'error'); }
function logInfo(msg){ logDebug(msg, 'info'); }

/* =========================
   INITIALISATION
========================= */
let autoSyncTimer = null;
let cloudSubUnsubscribe = null;
let achatsSubUnsubscribe = null;
document.addEventListener('DOMContentLoaded', ()=>{
  renderToBuy();

  // Initialiser le cloud
  function tryInitCloud(){
    if(typeof initCloud === 'function'){
      logInfo('Y Connexion cloud...');
      console.log('Y Tentative de connexion cloud...');
      initCloud().then(function(enabled){
        if(enabled){
          logSuccess('a... Cloud Supabase ACTIVA');
          console.log('a... Cloud Supabase ACTIVA');
          window.cloudReady = true;

          // Charger donnAes cloud initiales
          loadFromCloud();
          loadToBuyFromCloud();

          // Sync automatique rapide
          if(autoSyncTimer) clearInterval(autoSyncTimer);
          autoSyncTimer = setInterval(() => {
            if(window.cloudReady){
              autoSyncFromCloud();
            }
          }, FAST_SYNC_INTERVAL_MS);

          // Abonnement (polling) pour dAtection rapide des changements
          if(cloudSubUnsubscribe) cloudSubUnsubscribe();
          cloudSubUnsubscribe = subscribeToCloudChanges();

          if(achatsSubUnsubscribe) achatsSubUnsubscribe();
          achatsSubUnsubscribe = subscribeToAchatsChanges();
        } else {
          logInfo('a Cloud Supabase NON activA');
          console.log('a Cloud Supabase NON activA');
        }
      }).catch(function(e){
        logError('a Erreur initCloud: ' + e);
        console.error('a Erreur initCloud:', e);
      });
    } else {
      logInfo('a3 Attente de cloud.js...');
      console.warn('a3 Attente de cloud.js...');
      setTimeout(tryInitCloud, 100);
    }
  }
  tryInitCloud();
});

// Sync rapide au retour sur l'onglet
document.addEventListener('visibilitychange', () => {
  if(document.visibilityState === 'visible' && window.cloudReady){
    autoSyncFromCloud();
  }
});

window.addEventListener('focus', () => {
  if(window.cloudReady){
    autoSyncFromCloud();
  }
});

// PWA service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}

// Pas d'auto-sync - sync manuel uniquement
// Les modifications sont syncAes immAdiatement vers le cloud

// Sync manuel via bouton

// Sync automatique depuis cloud - VERSION AMALIORAE AVEC CONFLITS
async function autoSyncFromCloud(){
  if(autoSyncFromCloud._running) return;
  autoSyncFromCloud._running = true;
  if(!window.getMedicaments) {
    console.warn('a3 getMedicaments non disponible - sync retardA');
    autoSyncFromCloud._running = false;
    return;
  }

  if(DEBUG_LOGS) console.log('Y DAmarrage autoSyncFromCloud amAliorA...');

  try {
    var result = await getMedicaments();
    var cloudMeds = [];

    if(!result || result.length === 0) {
      if(DEBUG_LOGS) console.log('a1i  Aucun mAdicament dans le cloud');
      if(isOnline()){
        meds = [];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
        renderAll();
        updateStats();
        if(DEBUG_LOGS) console.log('Y1 Local stock effacA (cloud vide)');
      }
    } else {
      cloudMeds = result.map(function(m){
        return {
          id: m.id,
          name: m.nom,
          dosage: m.dosage,
          genre: m.genre,
          quantity: m.quantite,
          initialStock: m.stock_initial,
          price: m.prix,
          nbBoxes: m.nb_boites,
          expiry: m.date_peremption,
          notes: m.notes || '',
          purchaseDate: m.date_achat || '',
          imageUrl: m.image_url || '',
          updated_at: m.updated_at || m.created_at
        };
      });

      if(DEBUG_LOGS) console.log('a i  Cloud meds reAus:', cloudMeds.length);
    }

    if(cloudMeds.length > 0){
      // Nettoyer les suppressions en attente
      var cloudKeys = {};
      cloudMeds.forEach(function(cm){
        cloudKeys[keyOf(cm.name, cm.dosage)] = true;
      });
      cleanupPendingDeletes(cloudKeys);
      var pendingDeleteMap = getPendingDeleteMap();
      cloudMeds = cloudMeds.filter(function(cm){
        return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
      });

      // PROTECTION ANTI-DOUBLONS : CrAer une map unique par clA
      var uniqueCloudMeds = {};
      cloudMeds.forEach(function(cm){
        var key = keyOf(cm.name, cm.dosage);
        if(!uniqueCloudMeds[key]){
          uniqueCloudMeds[key] = cm;
        } else {
          console.warn('as i  Doublon cloud ignorA:', cm.name, cm.dosage);
        }
      });

      // Convertir en tableau unique
      cloudMeds = Object.values(uniqueCloudMeds);

      var localChanged = false;
      var addedCount = 0;
      var updatedCount = 0;
      var deletedCount = 0;

      // CrAer une map des mAdicaments locaux par clA
      var localMap = {};
      meds.forEach(function(m, index){
        var key = keyOf(m.name, m.dosage);
        localMap[key] = { med: m, index: index };
      });

      cloudMeds.forEach(function(cm){
        var key = keyOf(cm.name, cm.dosage);
        var localEntry = localMap[key];

      if(!localEntry){
        // NOUVEAU mAdicament du cloud, l'ajouter
        console.log('az Nouveau du cloud:', cm.name);

        var validMed = {
          id: cm.id,
          name: cm.name,
          dosage: cm.dosage,
          genre: cm.genre || '',
          quantity: Math.max(0, Number(cm.quantity) || 0),
          initialStock: Math.max(0, Number(cm.initialStock) || 0),
          price: Math.max(0, Number(cm.price) || 0),
          nbBoxes: Math.max(1, Number(cm.nbBoxes) || 1),
          expiry: cm.expiry || null,
          notes: cm.notes || '',
          imageUrl: cm.imageUrl || '',
          updated_at: cm.updated_at
        };

        meds.push(validMed);
        localChanged = true;
        addedCount++;
        console.log('a... MAdicament ajoutA:', cm.name, 'qty:', validMed.quantity, 'price:', validMed.price);
      } else {
        // MAdicament existe dAjA , vArifier si mise A  jour nAcessaire
        var localMed = localEntry.med;
        var cloudTime = new Date(cm.updated_at || 0);
        var localTime = new Date(localMed.updated_at || 0);

        // Si cloud plus rAcent OU si local n'a pas de timestamp
        if(cloudTime > localTime || !localMed.updated_at){
          console.log('Y Mise A  jour depuis cloud:', cm.name, 'ancien qty:', localMed.quantity, 'nouveau:', cm.quantity);

          // Mettre A  jour les donnAes locales avec celles du cloud
          localMed.id = cm.id;
          localMed.quantity = Math.max(0, Number(cm.quantity) || 0);
          localMed.initialStock = Math.max(0, Number(cm.initialStock) || 0);
          localMed.price = Math.max(0, Number(cm.price) || 0);
          localMed.nbBoxes = Math.max(1, Number(cm.nbBoxes) || 1);
          localMed.expiry = cm.expiry || localMed.expiry;
          localMed.notes = cm.notes || localMed.notes;
          localMed.genre = cm.genre || localMed.genre;
          localMed.imageUrl = cm.imageUrl || localMed.imageUrl || '';
          localMed.updated_at = cm.updated_at;

          meds[localEntry.index] = localMed;
          localChanged = true;
          updatedCount++;
          console.log('a... MAdicament mis A  jour:', cm.name, 'qty:', localMed.quantity, 'price:', localMed.price);
        }
      }
      });

      // IMPORTANT: le cloud est source de verite.
      // Si un medicament n'existe plus dans le cloud (supprime depuis telephone),
      // il doit aussi etre supprime en local (PC).
      var cloudKeySet = {};
      cloudMeds.forEach(function(cm){
        cloudKeySet[keyOf(cm.name, cm.dosage)] = true;
      });
      var beforeCount = meds.length;
      meds = meds.filter(function(localMed){
        return !!cloudKeySet[keyOf(localMed.name, localMed.dosage)];
      });
      deletedCount = beforeCount - meds.length;
      if(deletedCount > 0){
        localChanged = true;
      }

      if(localChanged){
        save();
        console.log('Y34 Sync terminA: +' + addedCount + ' ajoutAs, -' + deletedCount + ' supprimAs, ~' + updatedCount + ' mis A  jour');
        if(typeof renderAll === 'function') renderAll();
        if(typeof updateStats === 'function') updateStats();
      } else {
        if(DEBUG_LOGS) console.log('a1i  Aucune modification nAcessaire');
      }
    }

    // Sync achats (A acheter) avec validation stricte
    if(window.getAchats){
      try {
        var achatsResult = await getAchats();
        if(achatsResult && achatsResult.length > 0){
            if(DEBUG_LOGS) console.log('Y Sync achats: cloud=' + achatsResult.length + ', local=' + toBuyList.length);

            var uniqueCloudAchats = {};
            achatsResult.forEach(function(a){
              var key = (a.nom || '').toLowerCase().trim();
              if(key && a.nom){
                uniqueCloudAchats[key] = {
                  id: a.id,
                  name: a.nom.trim(),
                  qty: Math.max(1, Number(a.quantite) || 1),
                  notes: (a.notes || '').trim()
                };
              }
            });

            const cloudList = Object.values(uniqueCloudAchats);
            cleanupPendingToBuyDeletes(cloudList);

            var changed = false;

            // Mettre A  jour les achats existants
            toBuyList.forEach(function(localItem, index){
              var key = localItem.name.toLowerCase().trim();
              var cloudItem = uniqueCloudAchats[key];

              if(cloudItem){
                var newQty = Math.max(1, Number(cloudItem.qty) || 1);
                var newNotes = cloudItem.notes || '';

                if(localItem.qty !== newQty || localItem.notes !== newNotes || !localItem.id){
                  toBuyList[index].qty = newQty;
                  toBuyList[index].notes = newNotes;
                  if(!toBuyList[index].id) toBuyList[index].id = cloudItem.id;
                  changed = true;
                if(DEBUG_LOGS) console.log('Y Achat mis A  jour:', localItem.name, 'qty:', newQty);
                }
                delete uniqueCloudAchats[key];
              }
            });

          // Ajouter les nouveaux achats
            Object.values(uniqueCloudAchats).forEach(function(newItem){
              var exists = toBuyList.some(function(local){
                return local.name.toLowerCase().trim() === newItem.name.toLowerCase().trim();
              });

              if(!exists){
                toBuyList.push(newItem);
                changed = true;
                if(DEBUG_LOGS) console.log('az Nouvel achat du cloud:', newItem.name);
              }
            });

          if(changed){
            localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
            if(typeof renderToBuy === 'function') renderToBuy();
          }
        } else if(isOnline()){
          toBuyList = [];
          localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
          if(typeof renderToBuy === 'function') renderToBuy();
          if(DEBUG_LOGS) console.log('Y1 Liste "A acheter" effacAe (cloud vide)');
        }
      } catch(e) {
        console.warn('Sync achats AchouA:', e);
      }
    }

    window.cloudReady = true;
    if(DEBUG_LOGS) console.log('a... Auto-sync amAliorA terminA');
  } catch(e) {
    console.warn('Sync auto AchouA:', e);
  } finally {
    autoSyncFromCloud._running = false;
  }
}

// Subscription temps rAel - Acouter les changements cloud
function subscribeToCloudChanges(){
  if(!window.subscribeToMedicaments) return null;
  
  return subscribeToMedicaments(function(payload){
    console.log('Cloud change detected:', payload);
    
    // Recharger depuis cloud quand un changement est dAtectA
    refreshFromCloud();
  }, { intervalMs: FAST_SYNC_INTERVAL_MS });
}

function subscribeToAchatsChanges(){
  if(!window.subscribeToAchats) return null;

  return subscribeToAchats(function(payload){
    console.log('Achats change detected:', payload);
    loadToBuyFromCloud();
  }, { intervalMs: FAST_SYNC_INTERVAL_MS });
}

// RafraAchir depuis cloud (pour sync temps rAel)
function refreshFromCloud(){
  if(!window.getMedicaments) return;
  
  getMedicaments().then(function(result){
    if(!result || result.length === 0) return;
    
    let cloudMeds = result.map(function(m){
      return {
        id: m.id,
        name: m.nom,
        dosage: m.dosage,
        genre: m.genre,
        quantity: m.quantite,
        initialStock: m.stock_initial,
        price: m.prix,
        nbBoxes: m.nb_boites,
        expiry: m.date_peremption,
        notes: m.notes || '',
        purchaseDate: m.date_achat || '',
        imageUrl: m.image_url || ''
      };
    });

    // Nettoyer les suppressions en attente
    var cloudKeys = {};
    cloudMeds.forEach(function(cm){
      cloudKeys[keyOf(cm.name, cm.dosage)] = true;
    });
    cleanupPendingDeletes(cloudKeys);
    var pendingDeleteMap = getPendingDeleteMap();
    cloudMeds = cloudMeds.filter(function(cm){
      return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
    });

    // Nettoyer les suppressions en attente
    var cloudKeys = {};
    cloudMeds.forEach(function(cm){
      cloudKeys[keyOf(cm.name, cm.dosage)] = true;
    });
    cleanupPendingDeletes(cloudKeys);
    var pendingDeleteMap = getPendingDeleteMap();
    cloudMeds = cloudMeds.filter(function(cm){
      return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
    });
    
    // Fusion cloud + local (AJOUTER + METTRE A JOUR + SUPPRIMER)
    // CrAer map cloud par clA
    var cloudByKey = {};
    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      cloudByKey[key] = cm;
    });
    
    var deletedCount = 0;
    var updatedCount = 0;
    
    // Pour chaque med local, vArifier s'il existe dans cloud
    meds.forEach(function(lm){
      var key = keyOf(lm.name, lm.dosage);
      var cm = cloudByKey[key];
      
      if(!cm){
        // N'existe pas dans cloud a supprimer local
        console.log('Yi  Supprimer local (pas dans cloud):', lm.name);
        lm._toDelete = true;
        deletedCount++;
      } else {
        // Existe dans cloud a vArifier si modifiA
        if(lm._localModified && !cm._localModified){
          // Local modifiA plus rAcemment a garder local
          console.log('ai  Skip update (local plus rAcent):', lm.name);
        } else if(lm.quantity !== cm.quantity || lm.price !== cm.price || lm.expiry !== cm.expiry || (lm.imageUrl || '') !== (cm.imageUrl || '')){
          // Cloud plus rAcent a prendre les donnAes cloud
          console.log('a... Update depuis cloud:', lm.name, 'qty:', lm.quantity, 'a', cm.quantity);
          lm.id = cm.id;
          lm.quantity = cm.quantity;
          lm.price = cm.price;
          lm.expiry = cm.expiry;
          lm.notes = cm.notes || '';
          lm.imageUrl = cm.imageUrl || '';
          updatedCount++;
        }
      }
    });
    
    // Supprimer les meds marquAs
    meds = meds.filter(function(m){ return !m._toDelete; });
    
    // Ajouter les nouveaux du cloud
    var addedCount = 0;
    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      var exists = meds.some(function(m){ return keyOf(m.name, m.dosage) === key; });
      console.log('Y Check cloud med:', cm.name, '| key:', key, '| exists:', exists);
      if(!exists){
        meds.push(cm);
        addedCount++;
        console.log('az AJOUTA:', cm.name);
      }
    });
    
    save();
    renderAll();
    updateStats();
    
    console.log('YS Final meds count:', meds.length);
    if(addedCount > 0 || deletedCount > 0 || updatedCount > 0){
      console.log('a... Sync terminAe: +' + addedCount + ' ajoutAs, -' + deletedCount + ' supprimAs, ~' + updatedCount + ' mis A  jour');
    } else {
      console.log('a1i  Sync: pas de changements');
    }
  });
}

// Charger depuis cloud vers local (FUSION intelligente)
function loadFromCloud(){
  if(!window.getMedicaments) return;
  
  console.log('Y loadFromCloud: rAcupAration donnAes cloud...');
  
  getMedicaments().then(function(result){
    if(!result || result.length === 0){
      console.log('a1i  Aucune donnAe cloud ou erreur');
      loadToBuyFromCloud();
      return;
    }
    
    // Convertir cloud meds vers format local (avec 'name' au lieu de 'nom')
    var cloudMeds = result.map(function(m){
      return {
        id: m.id,
        name: m.nom,
        dosage: m.dosage,
        genre: m.genre,
        quantity: m.quantite,
        initialStock: m.stock_initial,
        price: m.prix,
        nbBoxes: m.nb_boites,
        expiry: m.date_peremption,
        notes: m.notes || '',
        purchaseDate: m.date_achat || '',
        imageUrl: m.image_url || ''
      };
    });
    
    // Nettoyer les suppressions en attente
    var cloudKeys = {};
    cloudMeds.forEach(function(cm){
      cloudKeys[keyOf(cm.name, cm.dosage)] = true;
    });
    cleanupPendingDeletes(cloudKeys);
    var pendingDeleteMap = getPendingDeleteMap();
    cloudMeds = cloudMeds.filter(function(cm){
      return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
    });

    console.log('Y Cloud meds:', cloudMeds.length);
    
    if(cloudMeds.length > 0){
      // FUSION intelligente : ajouter nouveaux meds du cloud
      var localByKey = {};
      meds.forEach(function(m){
        localByKey[keyOf(m.name, m.dosage)] = m;
      });
      
      // Ajouter les meds du cloud qui n'existent pas en local
      var addedCount = 0;
      cloudMeds.forEach(function(cm){
        var key = keyOf(cm.name, cm.dosage);
        if(!localByKey[key]){
          meds.push(cm);
          addedCount++;
        }
      });
      
      if(addedCount > 0){
        save();
        renderAll();
        updateStats();
        console.log('a... Fusion cloud: ' + addedCount + ' nouveaux mAdicaments ajoutAs');
      } else {
        console.log('a1i  Aucune nouvelle donnAe cloud');
      }
    }
    
    // Charger aussi la liste A  acheter
    loadToBuyFromCloud();
  });
}

// Charger liste A  acheter depuis cloud (FUSION)
function loadToBuyFromCloud(){
  if(!window.getAchats) return;
  
  console.log('Y loadToBuyFromCloud...');
  
  getAchats().then(function(result){
    if(!result || result.length === 0){
      console.log('a1i  Aucune donnAe achats cloud');
      if(isOnline()){
        toBuyList = [];
        localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
        renderToBuy();
        console.log('Y1 Liste "A acheter" effacAe (cloud vide)');
      }
      return;
    }
    
    // Remplacer la liste locale par le cloud (source de vAritA)
    const cloudList = result.map(a => ({ id: a.id, name: a.nom }));
    cleanupPendingToBuyDeletes(cloudList);
    toBuyList = result.map(a => ({
      id: a.id,
      name: a.nom,
      qty: a.quantite,
      notes: a.notes || ''
    }));

    localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
    renderToBuy();
    console.log('a... Sync achats terminAe:', toBuyList.length, 'articles');
  });
}

// Charger depuis cloud ET afficher un message
async function loadAndShowFromCloud(){
  if(typeof getMedicaments !== 'function') {
    alert('as i  Cloud non activA');
    return;
  }
  
  var result = await getMedicaments();
  
  if(result.error){
    alert('a Erreur cloud: ' + result.error);
    return;
  }
  
  if(!result || result.length === 0){
    alert('as i  Aucune donnAe dans le cloud');
    return;
  }
  
  var cloudMeds = result.map(function(m){
    return {
      id: m.id,
      name: m.nom,
      dosage: m.dosage,
      genre: m.genre,
      quantity: m.quantite,
      initialStock: m.stock_initial,
      price: m.prix,
      nbBoxes: m.nb_boites,
      expiry: m.date_peremption,
      notes: m.notes || '',
      purchaseDate: m.date_achat || '',
      imageUrl: m.image_url || ''
    };
  });

  // Nettoyer les suppressions en attente
  var cloudKeys = {};
  cloudMeds.forEach(function(cm){
    cloudKeys[keyOf(cm.name, cm.dosage)] = true;
  });
  cleanupPendingDeletes(cloudKeys);
  var pendingDeleteMap = getPendingDeleteMap();
  cloudMeds = cloudMeds.filter(function(cm){
    return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
  });
  
  // Fusionner : ajouter les mAdicaments cloud qui n'existent pas en local
  var localMap = {};
  meds.forEach(function(m){
    var key = (m.name + '_' + m.dosage).toLowerCase();
    localMap[key] = true;
  });
  
  var added = 0;
  cloudMeds.forEach(function(cm){
    var key = (cm.name + '_' + cm.dosage).toLowerCase();
    if(!localMap[key]){
      meds.push(cm);
      added++;
    }
  });
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
  localStorage.setItem(SEEDED_KEY, "1");
  
  renderAll();
  updateStats();
  
  console.log('Fusion terminAe:', added, 'nouveaux');
  alert('a... ' + added + ' mAdicaments ajoutAs depuis cloud !');
}

// Sauvegarder TOUTES les donnAes locales vers cloud
// Sauvegarder VERS cloud (mode FUSION - pas d'Acrasement)
async function saveAllToCloud(callback){
  if(typeof addMedicament !== 'function') {
    if(callback) callback();
    return;
  }
  
  console.log('DAbut sync fusion vers cloud, meds count:', meds.length);
  
  // RAcupArer les donnAes cloud actuelles
  var cloudData = await getMedicaments();
  var cloudMeds = cloudData || [];
  
  console.log('Cloud a:', cloudMeds.length, 'mAdicaments');
  
  // CrAer une map pour les mAdicaments cloud par nom+dosage
  var cloudMap = {};
  cloudMeds.forEach(function(m){
    var key = keyOf(m.name, m.dosage);
    cloudMap[key] = m;
  });
  
  // Pour chaque mAdicament local, fusionner avec cloud
  for(var j = 0; j < meds.length; j++){
    var m = meds[j];
    var key = (m.name + '_' + m.dosage).toLowerCase();
    
    var medData = {
      name: m.name,
      dosage: m.dosage,
      genre: m.genre,
      quantity: m.quantity,
      initialStock: m.initialStock,
      price: m.price,
      nbBoxes: m.nbBoxes,
      expiry: m.expiry,
      notes: m.notes || '',
      purchaseDate: m.purchaseDate || '',
      imageUrl: m.imageUrl || ''
    };
    
    if(cloudMap[key]){
      // Existe dAjA  dans cloud, mettre A  jour
      console.log('Mise A  jour:', medData.name);
      await updateMedicament(cloudMap[key].id, medData);
    } else {
      // N'existe pas, crAer
      console.log('CrAation:', medData.name);
      await addMedicament(medData);
    }
  }
  
  console.log('Sync fusion terminAe');
  if(callback) callback();
}

// Debug sync
async function forceDebugSync(){
  var localCount = meds.length;
  document.getElementById('debug-local-count').textContent = localCount;
  document.getElementById('debug-status').textContent = 'VArification...';
  if(!window.getMedicaments) return;
  try {
    var result = await getMedicaments();
    var cloudCount = result ? result.length : 0;
    document.getElementById('debug-cloud-count').textContent = cloudCount;
    if(cloudCount === 0 && localCount > 0){
      document.getElementById('debug-status').textContent = 'Sync...';
      var synced = 0;
      for(var m of meds){
        var addResult = await addMedicament(m);
        if(!addResult.error) synced++;
      }
      document.getElementById('debug-status').textContent = 'TerminA! ' + synced;
    } else if(cloudCount > 0){
      document.getElementById('debug-status').textContent = 'Sync OK';
    }
  } catch(e){
    document.getElementById('debug-status').textContent = 'Erreur';
  }
}

// Clear local duplicates and sync with cloud
async function clearLocalDuplicates(){
  if(!auth) return;
  if(!confirm('as i  Voulez-vous supprimer les doublons locaux et synchroniser avec le cloud ')) return;

  console.log('Y1 Suppression des doublons locaux...');

  // CrAer une map pour dAtecter les doublons
  var uniqueMeds = {};
  var duplicatesRemoved = 0;

  meds.forEach(function(m, index){
    var key = keyOf(m.name, m.dosage);
    if(uniqueMeds[key]){
      // Doublon trouvA, supprimer
      duplicatesRemoved++;
      console.log('Yi  Doublon supprimA:', m.name, m.dosage);
    } else {
      uniqueMeds[key] = m;
    }
  });

  // Convertir la map en tableau
  meds = Object.values(uniqueMeds);

  console.log('a... Doublons supprimAs:', duplicatesRemoved);
  console.log('YS MAdicaments uniques restants:', meds.length);

  save();
  renderAll();
  updateStats();

  // Synchroniser avec le cloud
  if(window.getMedicaments){
    console.log('Y Synchronisation avec le cloud...');
    loadFromCloud();
  }

  alert('a... Nettoyage terminA ! ' + duplicatesRemoved + ' doublons supprimAs.');
}

// Improved sync for "A acheter" deletions
async function syncToBuyDeletions(){
  if(!window.getAchats) return;

  try {
    var cloudResult = await getAchats();
    if(!cloudResult || cloudResult.length === 0){
      // Si cloud vide, vider local aussi
      toBuyList = [];
      localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
      renderToBuy();
      console.log('Yi  Liste "A acheter" vidAe (cloud vide)');
      return;
    }

    // CrAer map des noms cloud
    var cloudNames = {};
    cloudResult.forEach(function(a){
      cloudNames[a.nom.toLowerCase()] = {
        qty: a.quantite,
        notes: a.notes || ''
      };
    });

    var changed = false;

    // Supprimer les locaux qui n'existent plus dans cloud
    for(var i = toBuyList.length - 1; i >= 0; i--){
      var localName = toBuyList[i].name.toLowerCase();
      if(!cloudNames[localName]){
        console.log('Yi  Suppression locale (pas dans cloud):', toBuyList[i].name);
        toBuyList.splice(i, 1);
        changed = true;
      } else {
        // Mettre A  jour quantitA si diffArente
        var cloudItem = cloudNames[localName];
        if(toBuyList[i].qty !== cloudItem.qty || toBuyList[i].notes !== cloudItem.notes){
          toBuyList[i].qty = cloudItem.qty;
          toBuyList[i].notes = cloudItem.notes;
          changed = true;
          console.log('Y QuantitA mise A  jour:', toBuyList[i].name);
        }
      }
    }

    if(changed){
      localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
      renderToBuy();
      console.log('a... Sync "A acheter" terminA');
    }

  } catch(e) {
    console.warn('Erreur sync "A acheter":', e);
  }
}

</script><!-- Supabase Realtime SDK --><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><!-- Cloud Integration (REST API) --><script src="cloud.js?v=20260210d"></script></body></html>










