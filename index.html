<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion de la Pharmacie √† Domicile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --primary-color: #667eea;
      --accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-color: #f093fb;
      --text: #2c3e50;
      --text-light: #ecf0f1;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #3498db;
      --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
      --radius: 15px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="60" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
      animation: float 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(180deg); }
    }

    nav{
      background: var(--primary);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow-light);
    }

    nav ul{
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      list-style: none;
      align-items: center;
      justify-content: center;
    }

    nav a{
      color: var(--text-light);
      text-decoration: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    nav a:hover::before {
      left: 100%;
    }

    nav a:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .container{
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    section{
      display: none;
      animation: slideIn 0.4s ease-out;
    }

    section.active{display: block}

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      animation: tableSlideIn 0.5s ease-out;
    }

    @keyframes tableSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    th, td{
      padding: 1rem;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      text-align: left;
      vertical-align: top;
    }

    th{
      background: var(--accent);
      color: white;
      font-weight: 600;
      position: relative;
    }

    th::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    }

    tr:hover{
      background: rgba(102, 126, 234, 0.05);
      transform: scale(1.01);
      transition: var(--transition);
    }

    .expired{color: var(--danger) !important; font-weight: bold; animation: pulse 2s infinite;}
    .expiring-soon{color: var(--warning) !important; font-weight: bold; animation: pulse 2s infinite;}
    .valid{color: var(--success) !important;}
    .stock-zero{color: var(--danger) !important; font-weight: bold; background: rgba(231, 76, 60, 0.1); animation: shake 0.5s;}

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }

    .action-btn{
      background: none;
      border: none;
      cursor: pointer;
      margin: 0 0.25rem;
      font-size: 1.1rem;
      padding: 0.5rem;
      border-radius: var(--radius);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    .action-btn:hover::before {
      width: 100%;
      height: 100%;
    }

    .action-btn:hover{transform: scale(1.1) rotate(5deg);}
    .edit{color: var(--success);}
    .delete{color: var(--danger);}
    .use{color: var(--warning);}

    form{
      max-width: 520px;
      margin-top: 1rem;
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      animation: formSlideIn 0.5s ease-out;
    }

    @keyframes formSlideIn {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .form-group{margin-bottom: 1.5rem}
    label{
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, textarea, select{
      width: 100%;
      padding: 1rem;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: var(--transition);
      background: rgba(255,255,255,0.8);
    }

    input:focus, textarea:focus, select:focus{
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.2);
      transform: translateY(-2px);
    }

    textarea{resize: vertical; min-height: 100px;}

    button[type=submit]{
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      width: 100%;
    }

    button[type=submit]::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    button[type=submit]:hover::before {
      left: 100%;
    }

    button[type=submit]:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    #search, #search-edit, #search-delete, #search-use{
      width: 100%;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: var(--radius);
      font-size: 1rem;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }

    #search:focus, #search-edit:focus, #search-delete:focus, #search-use:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.2);
    }

    .notes-cell{max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}

    /* Debug sync */
    #debug-sync{
      background: rgba(26, 26, 46, 0.9);
      color: #00ff00;
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      max-height: 120px;
      overflow-y: auto;
      border-bottom: 2px solid #00ff00;
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
    }

    #debug-sync .log-entry{margin: 2px 0; animation: logEntry 0.3s ease-out;}
    @keyframes logEntry {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    #debug-sync .log-success{color: #00ff00;}
    #debug-sync .log-error{color: #ff5555;}
    #debug-sync .log-info{color: #ffff00;}

    .notes-cell:hover{white-space: normal; overflow: visible;}

    .stats-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .stat-card{
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      animation: cardBounce 0.6s ease-out;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--accent);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    @keyframes cardBounce {
      0% { opacity: 0; transform: scale(0.8) translateY(20px); }
      50% { transform: scale(1.05) translateY(-5px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    .stat-number{
      font-size: 3rem;
      font-weight: bold;
      margin: 0.5rem 0;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: numberCount 1s ease-out;
    }

    @keyframes numberCount {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }

    .password-modal{
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .password-content{
      background: var(--card-bg);
      padding: 3rem;
      border-radius: var(--radius);
      text-align: center;
      width: 90%;
      max-width: 450px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      animation: modalSlideIn 0.4s ease-out;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.8) translateY(-20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .empty-msg{
      text-align: center;
      padding: 3rem;
      color: #666;
      font-style: italic;
      animation: fadeIn 0.5s ease-out;
    }

    .nav-btn{
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }

    .nav-btn:hover{
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }

    /* SVG Icons */
    .icon { width: 20px; height: 20px; fill: currentColor; }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      /* Navigation mobile - menu compact en grille */
      nav{padding:.3rem}
      nav ul{
        display:grid;
        grid-template-columns:repeat(3,1fr);
        gap:.3rem;
        align-items:center
      }
      nav a{
        padding:.3rem .4rem;
        font-size:.75rem;
        text-align:center
      }

      /* Container - plus compact */
      .container{padding:.5rem}

      /* Titres r√©duits */
      h1{font-size:1rem}
      h2{font-size:.95rem}
      h3{font-size:.9rem}

      /* Stats grid - compact */
      .stats-grid{
        grid-template-columns:repeat(2,1fr);
        gap:.4rem;
        margin:.5rem 0
      }
      .stat-card{
        padding:.5rem
      }
      .stat-number{font-size:1.1rem}

      /* Forms - compact */
      form{
        padding:.5rem;
        margin-top:.3rem
      }
      .form-group{margin-bottom:.5rem}
      label{font-size:.9rem;margin-bottom:.3rem}

      /* Inputs plus compacts */
      input,textarea,select{
        padding:.4rem;
        font-size:.85rem
      }

      /* Buttons */
      button[type=submit]{
        padding:.4rem .75rem;
        font-size:.85rem
      }

      /* Search + value row */
      #inventory>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }
      #inventory>div[style*="display:flex"]>div{
        justify-content:center
      }

      /* Use mode quantity */
      #use-mode>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }

      /* Tables responsive avec scroll horizontal */
      table{
        font-size:.75rem;
        display:block;
        overflow-x:auto;
        white-space:nowrap;
        -webkit-overflow-scrolling: touch;
        max-width: 100vw;
        margin: 0 -0.5rem;
      }
      th,td{
        padding:.3rem .25rem;
        min-width:50px
      }
      .notes-cell{max-width:60px}

      /* Modal edit */
      #edit-modal{padding:.2rem}
      #edit-modal>div{
        padding:.5rem;
        max-width:98vw
      }

      /* Modal password */
      .password-content{
        padding:.75rem;
        max-width:90vw
      }

      /* Buttons row in modal */
      #edit-modal>div>form>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }

      /* Liste d'attention - responsive */
      .attention-list-item {
        font-size: 0.85rem;
        padding: 0.75rem;
      }

      /* Debug sync - plus compact */
      #debug-sync {
        font-size: 0.7rem;
        padding: 0.5rem;
      }
    }

    @media (max-width: 480px) {
      /* Navigation mobile - 7 boutons visibles en grille */
      nav ul{
        grid-template-columns:repeat(4,1fr);
        gap:.2rem
      }
      nav a{
        padding:.25rem .3rem;
        font-size:.7rem
      }
      .stats-grid{grid-template-columns:repeat(2,1fr)}

      /* Masquer les boutons secondaires sur tr√®s petit √©cran */
      #btn-save,
      #btn-restore,
      #btn-sync,
      #btn-load-cloud,
      #btn-clear{
        display:none
      }

      /* Garder les boutons essentiels - montrer plus sur mobile */
      nav ul li:nth-child(-n+9){
        display:block
      }

      /* Always show Quitter button */
      #logout-link{
        display:block !important
      }

      /* Cacher la colonne Actions (colonne 10) */
      #med-table th:nth-child(10),
      #med-table td:nth-child(10),
      #med-table-edit th:nth-child(4),
      #med-table-edit td:nth-child(4),
      #med-table-edit th:nth-child(5),
      #med-table-edit td:nth-child(5),
      #med-table-delete th:nth-child(4),
      #med-table-delete td:nth-child(4),
      #med-table-delete th:nth-child(5),
      #med-table-delete td:nth-child(5),
      #med-table-use th:nth-child(4),
      #med-table-use td:nth-child(4),
      #med-table-use th:nth-child(5),
      #med-table-use td:nth-child(5){
        display:none
      }

      /* Colonnes visibles sur mobile */
      #med-table th:nth-child(1),
      #med-table td:nth-child(1){
        min-width:80px
      }
      #med-table th:nth-child(2),
      #med-table td:nth-child(2){
        min-width:60px
      }
      #med-table th:nth-child(3),
      #med-table td:nth-child(3){
        min-width:50px
      }
      #med-table th:nth-child(4),
      #med-table td:nth-child(4){
        min-width:40px
      }
      #med-table th:nth-child(5),
      #med-table td:nth-child(5){
        min-width:50px
      }
      #med-table th:nth-child(6),
      #med-table td:nth-child(6){
        min-width:50px
      }
      #med-table th:nth-child(7),
      #med-table td:nth-child(7){
        min-width:60px
      }
      #med-table th:nth-child(8),
      #med-table td:nth-child(8){
        min-width:50px
      }
      #med-table th:nth-child(9),
      #med-table td:nth-child(9){
        min-width:70px
      }

      /* Liste attention - tr√®s compact */
      .attention-list-item {
        font-size: 0.8rem;
        padding: 0.5rem;
        margin: 0.25rem 0;
      }

      /* Table "√Ä acheter" - responsive */
      #tobuy-table {
        font-size: 0.7rem;
      }
      #tobuy-table th, #tobuy-table td {
        padding: 0.25rem 0.15rem;
      }
    }
  </style>
</head>

<body>

  <!-- Modal de connexion -->
  <div id="pwd-modal" class="password-modal">
    <div class="password-content">
      <h2>üîê Acc√®s s√©curis√©</h2>
      <p style="margin-top:.5rem;">Entrez le mot de passe pour acc√©der √† l'application</p>

      <input type="password" id="pwd-input" placeholder="Mot de passe"
             style="width:100%;padding:.75rem;margin:1rem 0;border:1px solid #ddd;border-radius:var(--radius);font-size:1.1rem;" />

      <button id="pwd-btn"
              style="background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;font-weight:600;">
        Acc√©der
      </button>

      <p id="pwd-error" style="color:#d32f2f;margin-top:1rem;display:none;">Mot de passe incorrect</p>
      <p style="margin-top:1rem;font-size:.9rem;color:#666;">Astuce : Entr√©e = valider</p>
    </div>
  </div>

  <!-- Navigation -->
  <nav id="main-nav" style="display:none;">
    <ul>
      <li><a href="#" data-target="home">üè† Accueil</a></li>
      <li><a href="#" data-target="inventory">üì¶ Inventaire</a></li>
      <li><a href="#" data-target="add">‚ûï Saisie</a></li>
      <li><a href="#" data-target="edit-mode">‚úèÔ∏è Modifier</a></li>
      <li><a href="#" data-target="delete-mode">üóëÔ∏è Supprimer</a></li>
      <li><a href="#" data-target="use-mode">üíä Utiliser</a></li>
      <li><a href="#" data-target="to-buy">üõí √Ä acheter</a></li>
      <li><a href="Sposnor.html" target="_blank">ü§ù Sponsors</a></li>

      <!-- NOUVEAU : Sauvegarder / Restaurer / Vider / Sync -->
      <li><a href="#" id="btn-save" class="nav-btn">üíæ Sauvegarder</a></li>
      <li><a href="#" id="btn-restore" class="nav-btn">üìÇ Restaurer</a></li>
      <li><a href="#" id="btn-sync" class="nav-btn">üîÑ Sync</a></li>
      <li><a href="#" id="btn-load-cloud" class="nav-btn">üì• Charger</a></li>
      <li><a href="#" id="btn-clean-dup" class="nav-btn">üßπ Nettoyer</a></li>
      <li><a href="#" id="btn-force-sync" class="nav-btn">üîÑ Force Sync</a></li>
      <li><a href="#" id="btn-clear" class="nav-btn">üóëÔ∏è Vider</a></li>

      <li><a href="#" id="logout-link">üö™ Quitter</a></li>
    </ul>
  </nav>

  <!-- Debug Sync Status - cach√© par d√©faut -->
  <!-- <div id="debug-sync" style="display:none;"> -->
  <!--   <div class="log-info">üíª Debug Sync Cloud</div> -->
  <!-- </div> -->

  <div class="container" id="main" style="display:none;">

    <!-- Accueil -->
    <section id="home" class="section active">
      <h1>üè• Gestionnaire de Pharmacie √† Domicile</h1>

      <div class="stats-grid">
        <div class="stat-card"><h3>üìä Stock total</h3><div class="stat-number" id="total-meds">0</div></div>
        <div class="stat-card"><h3>‚ùå Expir√©s</h3><div class="stat-number" id="expired-count">0</div></div>
        <div class="stat-card"><h3>‚ö†Ô∏è Pr√©‚Äëexpiration</h3><div class="stat-number" id="preexp-count">0</div></div>
        <div class="stat-card"><h3>üì¶ Stock nul</h3><div class="stat-number" id="zerostock-count">0</div></div>
      </div>

      <h3>üìã M√©dicaments n√©cessitant une attention</h3>
      <div id="attention-list" style="margin-top:.75rem;"></div>
      
      <!-- Debug sync status -->
      <div style="background:#f0f0f0;padding:1rem;margin-top:1rem;border-radius:8px;font-size:0.9rem;">
        <h4>üîÑ √âtat Sync Cloud</h4>
        <p>üì± Locaux: <strong id="debug-local-count">0</strong></p>
        <p>‚òÅÔ∏è Cloud: <strong id="debug-cloud-count">0</strong></p>
        <p>üîó Statut: <strong id="debug-status">En attente...</strong></p>
        <button onclick="forceDebugSync()" style="margin-top:0.5rem;padding:0.5rem 1rem;background:#2196F3;color:#fff;border:none;border-radius:4px;cursor:pointer;">üîÑ Tester Sync</button>
      </div>
    </section>

    <!-- Inventaire -->
    <section id="inventory" class="section">
      <h2>üì¶ Inventaire complet</h2>

      <div style="display:flex;gap:1rem;margin:1rem 0;align-items:center;flex-wrap:wrap;">
        <input type="text" id="search" placeholder="üîé Rechercher (nom, dosage, notes)‚Ä¶" style="flex:1;">
        <div style="background:#e8f5e8;padding:.6rem 1rem;border-radius:var(--radius);font-size:.95rem;">
          üí∞ Valeur totale : <strong id="total-value">0.00 DH</strong>
        </div>
      </div>

      <table id="med-table">
        <thead>
          <tr>
            <th>Nom</th><th>Genre</th><th>Dosage</th><th>Qt√©</th><th>Stock init.</th><th>Prix (DH)</th>
            <th>P√©remption</th><th>Alerte</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ajout -->
    <section id="add" class="section">
      <h2>‚ûï Ajouter un m√©dicament</h2>

      <form id="add-form">
        <div class="form-group"><label>Nom *</label><input type="text" id="name" required></div>
        <div class="form-group"><label>Dosage *</label><input type="text" id="dosage" placeholder="ex : 500mg, 10ml" required></div>
        <div class="form-group"><label>Genre *</label>
          <select id="genre" required style="width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem;">
            <option value="">S√©lectionner...</option>
            <option value="Comprim√©s">Comprim√©s</option>
            <option value="G√©lules">G√©lules</option>
            <option value="Suppositoires">Suppositoires</option>
            <option value="Sachets">Sachets</option>
            <option value="Gel">Gel</option>
            <option value="Flacon">Flacon</option>
            <option value="Sirop">Sirop</option>
            <option value="Solution">Solution</option>
            <option value="Pommade">Pommade</option>
            <option value="Lotion">Lotion</option>
            <option value="Cr√®me">Cr√®me</option>
            <option value="Poudre">Poudre</option>
            <option value="Gouttes">Gouttes</option>
            <option value="Inhalation">Inhalation</option>
            <option value="Patch">Patch</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <!-- Stock initial AVANT quantit√© actuelle -->
        <div class="form-group"><label>Stock initial *</label><input type="number" id="initial-stock" min="0" required></div>
        <div class="form-group"><label>Quantit√© actuelle *</label><input type="number" id="quantity" min="0" required></div>

        <div class="form-group"><label>Prix (DH) *</label><input type="number" id="price" min="0" step="0.01" required></div>
        <div class="form-group"><label>Nombre de bo√Ætes *</label><input type="number" id="nb-boxes" min="1" value="1" required></div>

        <div class="form-group">
          <label>Date de p√©remption (MM/AA) *</label>
          <input type="text" id="expiry-mmaa" inputmode="numeric" placeholder="ex : 02/26" maxlength="5" required>
          <small style="display:block;margin-top:.5rem;color:#666;">Format : MM/AA</small>
        </div>

        <div class="form-group"><label>Notes</label><textarea id="notes" placeholder="Optionnel"></textarea></div>

        <button type="submit">üíä Ajouter</button>
      </form>
    </section>

    <!-- Modifier -->
    <section id="edit-mode" class="section">
      <h2>‚úèÔ∏è Modifier</h2>
      <input type="text" id="search-edit" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-edit">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>Stock init.</th><th>Prix (DH)</th>
            <th>P√©remption</th><th>Notes</th><th>Modifier</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Supprimer -->
    <section id="delete-mode" class="section">
      <h2>üóëÔ∏è Supprimer</h2>
      <input type="text" id="search-delete" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-delete">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>Stock init.</th><th>Prix (DH)</th>
            <th>P√©remption</th><th>Supprimer</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Utiliser -->
    <section id="use-mode" class="section">
      <h2>üíä Utiliser</h2>

      <div class="form-group" style="max-width:420px;">
        <label for="use-qty">Quantit√© √† utiliser :</label>
        <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
          <input type="number" id="use-qty" min="1" value="1" style="width:120px;">
          <span class="chip">Alerte stock faible ‚â§ 5</span>
        </div>
      </div>

      <input type="text" id="search-use" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-use">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>Stock init.</th><th>Prix (DH)</th>
            <th>P√©remption</th><th>Utiliser</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- √Ä acheter -->
    <section id="to-buy" class="section">
      <h2>üõí M√©dicaments √† acheter</h2>

      <form id="tobuy-form" style="max-width:420px;">
        <div class="form-group"><label>Nom du m√©dicament *</label><input type="text" id="tobuy-name" required></div>
        <div class="form-group"><label>Quantit√© *</label><input type="number" id="tobuy-qty" min="1" value="1" required></div>
        <div class="form-group"><label>Genre / Notes</label><input type="text" id="tobuy-notes" placeholder="ex : comprim√©, sirop, cr√®me..."></div>
        <button type="submit">‚ûï Ajouter √† la liste</button>
      </form>

      <table id="tobuy-table" style="margin-top:1.5rem;">
        <thead>
          <tr>
            <th>Nom</th><th>Quantit√©</th><th>Genre</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </div>

  <!-- Modal d'√©dition -->
  <div id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000;overflow-y:auto;padding:1rem;">
    <div style="background:#fff;padding:2rem;border-radius:8px;width:100%;max-width:540px;box-shadow:0 4px 20px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto;">
      <h3 style="color:var(--primary);margin-bottom:1.2rem;">‚úèÔ∏è Modifier le m√©dicament</h3>

      <form id="edit-form">
        <input type="hidden" id="edit-index">

        <div class="form-group"><label>Nom *</label><input type="text" id="edit-name" required></div>
        <div class="form-group"><label>Dosage *</label><input type="text" id="edit-dosage" required></div>
        <div class="form-group"><label>Genre *</label>
          <select id="edit-genre" required style="width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem;">
            <option value="">S√©lectionner...</option>
            <option value="Comprim√©s">Comprim√©s</option>
            <option value="G√©lules">G√©lules</option>
            <option value="Suppositoires">Suppositoires</option>
            <option value="Sachets">Sachets</option>
            <option value="Gel">Gel</option>
            <option value="Flacon">Flacon</option>
            <option value="Sirop">Sirop</option>
            <option value="Solution">Solution</option>
            <option value="Pommade">Pommade</option>
            <option value="Lotion">Lotion</option>
            <option value="Cr√®me">Cr√®me</option>
            <option value="Poudre">Poudre</option>
            <option value="Gouttes">Gouttes</option>
            <option value="Inhalation">Inhalation</option>
            <option value="Patch">Patch</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div class="form-group"><label>Stock initial *</label><input type="number" id="edit-initial" min="0" required></div>
        <div class="form-group"><label>Quantit√© actuelle *</label><input type="number" id="edit-quantity" min="0" required></div>

        <div class="form-group"><label>Prix (DH) *</label><input type="number" id="edit-price" min="0" step="0.01" required></div>
        <div class="form-group"><label>Nombre de bo√Ætes *</label><input type="number" id="edit-nb-boxes" min="1" value="1" required></div>

        <div class="form-group">
          <label>P√©remption (MM/AA) *</label>
          <input type="text" id="edit-expiry-mmaa" inputmode="numeric" maxlength="5" placeholder="ex : 02/26" required>
        </div>

        <div class="form-group"><label>Notes</label><textarea id="edit-notes"></textarea></div>

        <div style="display:flex;gap:1rem;flex-wrap:wrap;">
          <button type="submit" style="flex:1;">üíæ Enregistrer</button>
          <button type="button" id="edit-cancel" style="flex:1;background:#6c757d;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;font-weight:600;">‚ùå Annuler</button>
        </div>
      </form>

      <p style="margin-top:1rem;font-size:.9rem;color:#666;">Astuce : √âchap = fermer</p>
    </div>
  </div>

<script>
/* =========================
   CONFIG / STOCKAGE
========================= */
const PASSWORD = "mohamed1964";
const STORAGE_KEY = "medicines";
const TOBUY_KEY = "medicines_to_buy";

// (optionnel) cl√© si tu veux g√©rer des exemples une seule fois
const SEEDED_KEY = "medicines_seeded_once";

let auth = false;
let meds = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let toBuyList = JSON.parse(localStorage.getItem(TOBUY_KEY)) || [];

/* =========================
   UTILITAIRES
========================= */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(meds)); }

function normalizeName(str){
  return String(str || "").trim().replace(/\s+/g, " ");
}
function keyOf(name, dosage){
  return (normalizeName(name) + "||" + normalizeName(dosage)).toLowerCase();
}

function fmtMMAAFromISO(iso){
  const dt = new Date(iso);
  if (isNaN(dt.getTime())) return "-";
  return `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getFullYear()).slice(-2)}`;
}
function fmtMMAA(d){ return fmtMMAAFromISO(d); }

function parseMMAAtoISO(mmaa){
  const raw = String(mmaa || "").trim();
  const compact = raw.replaceAll("/","").replace(/\D/g,'').slice(0,4);
  if(/^\d{4}$/.test(compact)){
    mmaa = compact.slice(0,2) + "/" + compact.slice(2,4);
  } else {
    mmaa = raw;
  }

  if(!/^\d{2}\/\d{2}$/.test(mmaa)) return null;

  const mm = parseInt(mmaa.slice(0,2), 10);
  const aa = parseInt(mmaa.slice(3,5), 10);
  if(mm < 1 || mm > 12) return null;

  const yyyy = (aa <= 79) ? (2000 + aa) : (1900 + aa);
  const iso = `${yyyy}-${String(mm).padStart(2,'0')}-01`;
  const dt = new Date(iso);
  if(isNaN(dt.getTime())) return null;
  return iso;
}

function expClass(iso){
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(iso); exp.setHours(0,0,0,0);
  const diff = Math.ceil((exp - today) / (1000*60*60*24));
  if(diff < 0) return "expired";
  if(diff <= 30) return "expiring-soon";
  return "valid";
}
function stockClass(q){ return (Number(q) === 0) ? "stock-zero" : ""; }

function mergeNotes(a,b){
  const n1 = (a||'').trim();
  const n2 = (b||'').trim();
  if(!n1) return n2;
  if(!n2) return n1;
  if(n1.toLowerCase() === n2.toLowerCase()) return n1;
  return n1 + " | " + n2;
}
function earliestExpiry(aISO, bISO){
  if(!aISO) return bISO;
  if(!bISO) return aISO;
  const da = new Date(aISO);
  const db = new Date(bISO);
  return (db < da) ? bISO : aISO;
}

/* =========================
   AUTH
========================= */
function setAppVisible(isVisible){
  document.getElementById('pwd-modal').style.display = isVisible ? 'none' : 'flex';
  document.getElementById('main-nav').style.display = isVisible ? 'block' : 'none';
  document.getElementById('main').style.display = isVisible ? 'block' : 'none';
}
function checkPwd(){
  const val = document.getElementById('pwd-input').value;
  if(val === PASSWORD){
    auth = true;
    document.getElementById('pwd-error').style.display = 'none';
    setAppVisible(true);
    show('inventory');
    updateStats();
    renderAll();
  } else {
    document.getElementById('pwd-error').style.display = 'block';
  }
}
function logout(){
  auth = false;
  setAppVisible(false);
  document.getElementById('pwd-input').value = '';
  document.getElementById('pwd-error').style.display = 'none';
}

/* =========================
   NAVIGATION
========================= */
function show(id){
  if(!auth) return;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  renderAll();
  if(id === 'to-buy') renderToBuy();
}

/* =========================
   STATS + LISTE ATTENTION
========================= */
function updateStats(){
  const today = new Date(); today.setHours(0,0,0,0);
  const limit = new Date(today); limit.setDate(today.getDate() + 30);

  let exp=0, pre=0, zer=0;
  let listHtml = '';

  meds.forEach(m=>{
    const e = new Date(m.expiry); e.setHours(0,0,0,0);
    const isExp = e < today;
    const isPre = !isExp && e <= limit;
    const isZero = Number(m.quantity) === 0;

    if(isExp) exp++;
    if(isPre) pre++;
    if(isZero) zer++;

    if(isExp || isPre || isZero){
      let status = '';
      if(isExp) status = '‚ùå EXPIR√â';
      else if(isPre) status = '‚ö†Ô∏è PR√â‚ÄëEXPIRATION';
      else status = 'üì¶ STOCK NUL';

      listHtml += `
        <div style="background:#fff;padding:1rem;margin:.5rem 0;border-radius:var(--radius);box-shadow:0 1px 4px var(--shadow);">
          <strong>${escapeHtml(m.name)}</strong> (${escapeHtml(m.dosage)}) ‚Äì ${status}
          <br><small>Qt√© : ${Number(m.quantity)||0}, Exp : ${fmtMMAA(m.expiry)}</small>
        </div>`;
    }
  });

  document.getElementById('total-meds').textContent = meds.length;
  document.getElementById('expired-count').textContent = exp;
  document.getElementById('preexp-count').textContent = pre;
  document.getElementById('zerostock-count').textContent = zer;

  document.getElementById('attention-list').innerHTML =
    listHtml || '<p style="color:#2e7d32;">‚úÖ Aucun probl√®me d√©tect√©</p>';
}

/* =========================
   RECHERCHE PAR SECTION
========================= */
function getActiveSearchValue(){
  const activeSection = document.querySelector('.section.active');
  if(!activeSection) return '';
  const input = activeSection.querySelector('input[id^="search"]');
  return input ? (input.value || '').toLowerCase() : '';
}

/* =========================
   RENDU TABLEAUX
========================= */
function renderAll(){
  if(!auth) return;

  const filter = getActiveSearchValue();

  const filtered = filter ? meds.filter(m => {
    const n = (m.name || '').toLowerCase();
    const d = (m.dosage || '').toLowerCase();
    const no = (m.notes || '').toLowerCase();
    return n.includes(filter) || d.includes(filter) || no.includes(filter);
  }) : meds;

  function renderTable(tableId){
    const tbody = document.querySelector(`#${tableId} tbody`);
    if(!tbody) return;

    tbody.innerHTML = '';

    if(filtered.length === 0){
      const colCount =
        tableId === 'med-table' ? 10 :
        tableId === 'med-table-edit' ? 8 :
        tableId === 'med-table-delete' ? 7 :
        tableId === 'med-table-use' ? 7 : 10;

      tbody.innerHTML = `<tr><td colspan="${colCount}" class="empty-msg">Aucun m√©dicament trouv√©</td></tr>`;
      return;
    }

    filtered.forEach(m=>{
      const idx = meds.indexOf(m);
      const expCls = expClass(m.expiry);
      const stkCls = stockClass(Number(m.quantity));
      const q = Number(m.quantity) || 0;
      const p = Number(m.price) || 0;

      // Calcul des alertes
      let alertMsgs = [];
      if (q < 5) alertMsgs.push('<span style="color:#d32f2f;font-weight:bold;">stock < 5</span>');
      
      const today = new Date(); today.setHours(0,0,0,0);
      const exp = new Date(m.expiry); exp.setHours(0,0,0,0);
      const diffDays = Math.ceil((exp - today) / (1000*60*60*24));
      if (diffDays <= 30) alertMsgs.push('<span style="color:#f57c00;font-weight:bold;">date < 1mois</span>');

      let alertHtml = alertMsgs.length > 0 ? alertMsgs.join('<br>') : '-';

      let row = `
        <tr class="${stkCls}">
          <td style="color:#1976d2;font-weight:bold;">${escapeHtml(m.name)}</td>
          <td>${escapeHtml(m.genre || '-')}</td>
          <td>${escapeHtml(m.dosage)}</td>
          <td style="color:#d32f2f;font-weight:bold;font-size:1.1em;">${q}</td>
          <td>${Number(m.initialStock) || 0}</td>
          <td>${p.toFixed(2)} DH</td>
          <td class="${expCls}">${fmtMMAA(m.expiry)}</td>
          <td>${alertHtml}</td>
      `;

      if(tableId === 'med-table'){
        row += `
          <td class="notes-cell" title="${escapeAttr(m.notes || '')}">${escapeHtml(m.notes || '-')}</td>
          <td>
            <button class="action-btn edit" title="Modifier" onclick="openEdit(${idx})">‚úèÔ∏è</button>
            <button class="action-btn delete" title="Supprimer" onclick="removeMed(${idx})">üóëÔ∏è</button>
            <button class="action-btn use" title="Utiliser" onclick="useMed(${idx})">üíä</button>
          </td>
        `;
      } else if(tableId === 'med-table-edit'){
        row += `
          <td class="notes-cell" title="${escapeAttr(m.notes || '')}">${escapeHtml(m.notes || '-')}</td>
          <td><button class="action-btn edit" title="Modifier" onclick="openEdit(${idx})">‚úèÔ∏è</button></td>
        `;
      } else if(tableId === 'med-table-delete'){
        row += `
          <td><button class="action-btn delete" title="Supprimer" onclick="removeMed(${idx})">üóëÔ∏è</button></td>
        `;
      } else if(tableId === 'med-table-use'){
        row += `
          <td><button class="action-btn use" title="Utiliser" onclick="useMed(${idx})">üíä</button></td>
        `;
      }

      row += `</tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  renderTable('med-table');
  renderTable('med-table-edit');
  renderTable('med-table-delete');
  renderTable('med-table-use');

  const total = filtered.reduce((sum, m) => {
    const p = Number(m.price) || 0;
    const nb = Number(m.nbBoxes) || 1;
    return sum + (p * nb);
  }, 0);

  const totalEl = document.getElementById('total-value');
  if (totalEl) totalEl.textContent = total.toFixed(2) + " DH";
}

/* =========================
   AJOUT (avec alerte + cumul)
========================= */
document.getElementById('add-form').addEventListener('submit', function(e){
  e.preventDefault();

  const name = normalizeName(document.getElementById('name').value);
  const dosage = normalizeName(document.getElementById('dosage').value);
  const genre = document.getElementById('genre').value;

  const initialStock = parseInt(document.getElementById('initial-stock').value, 10) || 0;
  const quantity = parseInt(document.getElementById('quantity').value, 10) || 0;

  const priceVal = parseFloat(document.getElementById('price').value);
  const price = Number.isFinite(priceVal) ? priceVal : 0;

  const nbBoxes = parseInt(document.getElementById('nb-boxes').value, 10) || 1;

  const expiryMMAA = document.getElementById('expiry-mmaa').value;
  const expiryISO = parseMMAAtoISO(expiryMMAA);
  if(!expiryISO){
    alert("‚ùå Date invalide. Utilise MM/AA (ex : 02/26).");
    return;
  }

  const notes = document.getElementById('notes').value.trim();

  const k = keyOf(name, dosage);
  const existingIndex = meds.findIndex(m => keyOf(m.name, m.dosage) === k);

  if(existingIndex === -1){
    meds.push({ name, dosage, genre, initialStock, quantity, price, nbBoxes, expiry: expiryISO, notes, _localModified: true });
    save();
    
    // Sauvegarder vers cloud IMM√âDIATEMENT
    if(window.addMedicament){
      addMedicament({ name, dosage, genre, initialStock, quantity, price, nbBoxes, expiry: expiryISO, notes }).then(result => {
        if(result.error){
          console.error('Erreur ajout cloud:', result.error);
        } else {
          console.log('‚úÖ Ajout cloud r√©ussi');
          // Assigner l'ID retourn√© au m√©dicament local
          if(result.data && result.data[0] && result.data[0].id){
            meds[meds.length - 1].id = result.data[0].id;
            save();
            console.log('ID cloud assign√©:', result.data[0].id);
          }
        }
      });
    }
    
    e.target.reset();
    show('inventory');
    renderAll();
    updateStats();
    return;
  }

  const ex = meds[existingIndex];

  const msg =
`‚ö†Ô∏è Ce m√©dicament existe d√©j√† :
- ${ex.name} (${ex.dosage})

Stock actuel :
- Quantit√© actuelle : ${ex.quantity}
- Stock initial : ${ex.initialStock}
- Prix : ${Number(ex.price||0).toFixed(2)} DH
- P√©remption : ${fmtMMAA(ex.expiry)}

Nouvelle saisie :
- +Qt√© : ${quantity}
- +Stock init. : ${initialStock}
- Nouveau prix : ${price.toFixed(2)} DH (remplace l'ancien)
- P√©remption : ${fmtMMAA(expiryISO)}

‚úÖ Voulez-vous ACTUALISER (cumuler les stocks) ?`;

  if(!confirm(msg)) return;

  ex.quantity = (Number(ex.quantity)||0) + quantity;
  ex.initialStock = (Number(ex.initialStock)||0) + initialStock;
  ex.price = price; // dernier prix remplace
  ex.nbBoxes = nbBoxes;
  ex.genre = genre;
  ex.expiry = earliestExpiry(ex.expiry, expiryISO);
  ex.notes = mergeNotes(ex.notes, notes);
  ex._localModified = true; // Marquer comme modifi√© localement

  meds[existingIndex] = ex;
  save();
  
  // Mettre √† jour le cloud IMM√âDIATEMENT
  if(window.updateMedicament && ex.id){
    updateMedicament(ex.id, ex).then(result => {
      if(result.error){
        console.error('Erreur update cloud:', result.error);
      } else {
        console.log('‚úÖ Update cloud r√©ussi');
      }
    });
  }
  
  e.target.reset();
  show('inventory');
  renderAll();
  updateStats();
});

/* =========================
   EDITION (MM/AA)
========================= */
function openEdit(idx){
  const m = meds[idx];
  if(!m) return;

  document.getElementById('edit-index').value = idx;
  document.getElementById('edit-name').value = m.name || '';
  document.getElementById('edit-dosage').value = m.dosage || '';
  document.getElementById('edit-genre').value = m.genre || '';
  document.getElementById('edit-quantity').value = Number(m.quantity) || 0;
  document.getElementById('edit-initial').value = Number(m.initialStock) || 0;
  document.getElementById('edit-price').value = Number(m.price) || 0;
  document.getElementById('edit-nb-boxes').value = Number(m.nbBoxes) || 1;
  document.getElementById('edit-expiry-mmaa').value = fmtMMAA(m.expiry);
  document.getElementById('edit-notes').value = m.notes || '';

  document.getElementById('edit-modal').style.display = 'flex';
}
function closeEdit(){ document.getElementById('edit-modal').style.display = 'none'; }
document.getElementById('edit-cancel').addEventListener('click', closeEdit);

document.getElementById('edit-form').addEventListener('submit', function(e){
  e.preventDefault();

  const idx = parseInt(document.getElementById('edit-index').value, 10);
  if(Number.isNaN(idx) || !meds[idx]) return;

  const name = normalizeName(document.getElementById('edit-name').value);
  const dosage = normalizeName(document.getElementById('edit-dosage').value);
  const genre = document.getElementById('edit-genre').value;

  const initialStock = parseInt(document.getElementById('edit-initial').value, 10) || 0;
  const quantity = parseInt(document.getElementById('edit-quantity').value, 10) || 0;

  const priceVal = parseFloat(document.getElementById('edit-price').value);
  const price = Number.isFinite(priceVal) ? priceVal : 0;

  const nbBoxes = parseInt(document.getElementById('edit-nb-boxes').value, 10) || 1;

  const expiryMMAA = document.getElementById('edit-expiry-mmaa').value;
  const expiryISO = parseMMAAtoISO(expiryMMAA);
  if(!expiryISO){
    alert("‚ùå Date invalide. Utilise MM/AA (ex : 02/26).");
    return;
  }

  const notes = document.getElementById('edit-notes').value.trim();

  // si modifie vers un existant => proposer fusion
  const newKey = keyOf(name, dosage);
  const otherIndex = meds.findIndex((m, i) => i !== idx && keyOf(m.name, m.dosage) === newKey);

  if(otherIndex !== -1){
    const target = meds[otherIndex];
    const msg =
`‚ö†Ô∏è Un autre m√©dicament existe d√©j√† avec le m√™me Nom+Dosage :
- ${target.name} (${target.dosage})

Voulez-vous FUSIONNER (cumuler) ce m√©dicament modifi√© avec l'existant ?`;

    if(confirm(msg)){
      target.quantity = (Number(target.quantity)||0) + quantity;
      target.initialStock = (Number(target.initialStock)||0) + initialStock;
      target.price = price; // dernier prix remplace
      target.nbBoxes = nbBoxes;
      target.genre = genre;
      target.expiry = earliestExpiry(target.expiry, expiryISO);
      target.notes = mergeNotes(target.notes, notes);
      target._localModified = true; // Marquer comme modifi√© localement

      meds[otherIndex] = target;
      meds.splice(idx, 1);

      save();
      
      // Mettre √† jour le cloud IMM√âDIATEMENT
      if(window.updateMedicament && target.id){
        updateMedicament(target.id, target).then(result => {
          if(result.error){
            console.error('Erreur update cloud:', result.error);
          } else {
            console.log('‚úÖ Update cloud r√©ussi (fusion)');
          }
        });
      }
      
      closeEdit();
      renderAll();
      updateStats();
      return;
    }
  }

  meds[idx] = { name, dosage, genre, quantity, initialStock, price, nbBoxes, expiry: expiryISO, notes };
  meds[idx]._localModified = true; // Marquer comme modifi√© localement
  save();

  // Sync d√©sactiv√© pour les modifications
  /*
  // Mettre √† jour le cloud IMM√âDIATEMENT
  if(window.updateMedicament && meds[idx].id){
    updateMedicament(meds[idx].id, { name, dosage, genre, quantity, initialStock, price, nbBoxes, expiry: expiryISO, notes }).then(result => {
      if(result.error){
        console.error('Erreur update cloud:', result.error);
      } else {
        console.log('‚úÖ Update cloud r√©ussi');
      }
    });
  }
  */
  
  closeEdit();
  renderAll();
  updateStats();
});

/* =========================
   SUPPRESSION / UTILISATION
========================= */
function removeMed(idx){
  const m = meds[idx];
  if(!m) return;
  if(confirm(`Supprimer "${m.name} (${m.dosage})" ?`)){
    // Sync d√©sactiv√© pour les suppressions
    /*
    // Supprimer du cloud IMM√âDIATEMENT (avec fallback nom+dosage)
    if(window.deleteMedicament){
      deleteMedicament(m.id, m.name, m.dosage).then(result => {
        if(result.error){
          console.error('‚ùå Erreur suppression cloud:', result.error);
        } else {
          console.log('‚úÖ Suppression cloud r√©ussie');
        }
      });
    }
    */

    meds.splice(idx, 1);
    save();
    renderAll();
    updateStats();
  }
}

function useMed(idx){
  const m = meds[idx];
  if(!m) return;

  const qty = parseInt(document.getElementById('use-qty').value, 10) || 1;
  if(qty <= 0){ alert("‚ùå Quantit√© invalide."); return; }

  if(Number(m.quantity) >= qty){
    const oldQty = Number(m.quantity);
    m.quantity = Number(m.quantity) - qty;
    m._localModified = true; // Marquer comme modifi√© localement
    save();
    
    logDebug('üíä UTILISER: ' + m.name + ' -' + qty + ' (√©tait:' + oldQty + ', maintenant:' + m.quantity + ')');
    
    // Si stock √©puis√©, supprimer localement seulement (pas de sync)
    if(m.quantity === 0){
      logInfo('üóëÔ∏è Stock √©puis√© - suppression locale de ' + m.name);

      // Supprimer de la liste locale seulement
      setTimeout(() => {
        const medIdx = meds.findIndex(x => x.id === m.id);
        if(medIdx !== -1){
          meds.splice(medIdx, 1);
          save();
          renderAll();
          updateStats();
        }
      }, 100);

      alert(`‚ÑπÔ∏è Derni√®re unit√© de ${m.name} utilis√©e ‚Äì stock √©puis√©.`);
    } else {
      // Mettre √† jour le cloud IMM√âDIATEMENT avec nouvelle quantit√©
      if(window.updateMedicament && m.id){
        updateMedicament(m.id, m).then(result => {
          if(result.error){
            logError('Erreur sync cloud: ' + result.error);
          } else {
            logSuccess('‚úÖ Sync: ' + m.name + ' = ' + m.quantity);
          }
        });
      }
      
      renderAll();
      updateStats();
      
      if(m.quantity <= 5){
        alert(`‚ö†Ô∏è Stock faible : il ne reste plus que ${m.quantity} unit√©(s) de ${m.name}.`);
      }
    }
  } else {
    alert(`‚ùå Stock insuffisant ! ${m.name} poss√®de seulement ${m.quantity} unit√©(s).`);
  }
}

/* =========================
   √Ä ACHETER (Liste de courses)
========================= */
function renderToBuy(){
  const tbody = document.querySelector('#tobuy-table tbody');
  if(!tbody) return;
  
  tbody.innerHTML = '';
  
  if(toBuyList.length === 0){
    tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">Aucun m√©dicament dans la liste</td></tr>';
    return;
  }
  
  // Trier par ordre alphab√©tique
  const sortedList = [...toBuyList].sort((a, b) => 
    a.name.toLowerCase().localeCompare(b.name.toLowerCase())
  );
  
  sortedList.forEach((item, idx)=>{
    tbody.innerHTML += `
      <tr>
        <td style="color:#1976d2;font-weight:bold;">${escapeHtml(item.name)}</td>
        <td style="color:#d32f2f;font-weight:bold;font-size:1.1em;">${item.qty}</td>
        <td>${escapeHtml(item.notes || '-')}</td>
        <td><button class="action-btn delete" onclick="removeToBuyByName('${escapeHtml(item.name)}')">üóëÔ∏è</button></td>
      </tr>
    `;
  });
}

// Supprimer par nom (pour supporter le tri)
function removeToBuyByName(name){
  if(!confirm('Supprimer "' + name + '" de la liste ?')) return;
  
  // Trouver l'index
  const idx = toBuyList.findIndex(item => 
    item.name.toLowerCase() === name.toLowerCase()
  );
  
  if(idx === -1) {
    console.log('‚ö†Ô∏è Article non trouv√©:', name);
    return;
  }
  
  toBuyList.splice(idx, 1);
  localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
  renderToBuy();
  
  // Sync vers cloud
  if(window.deleteAchatByName){
    console.log('‚òÅÔ∏è Suppression cloud:', name);
    deleteAchatByName(name);
  }
}

function removeToBuy(idx){
  if(confirm('Supprimer ce m√©dicament de la liste ?')){
    var deletedItem = toBuyList[idx];
    var deletedName = deletedItem.name;
    
    toBuyList.splice(idx, 1);
    localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
    renderToBuy();
    
    // Sync IMM√âDIAT vers cloud - suppression directe
    if(window.deleteAchatByName){
      console.log('‚òÅÔ∏è Suppression imm√©diate de', deletedName, 'du cloud');
      deleteAchatByName(deletedName);
    }
  }
}

document.getElementById('tobuy-form').addEventListener('submit', function(e){
  e.preventDefault();

  const name = normalizeName(document.getElementById('tobuy-name').value);
  const qty = parseInt(document.getElementById('tobuy-qty').value, 10) || 1;
  const notes = document.getElementById('tobuy-notes').value.trim();

  if(!name) return;

  // V√©rifier si l'article existe d√©j√†
  const existingIndex = toBuyList.findIndex(item =>
    item.name.toLowerCase() === name.toLowerCase()
  );

  if(existingIndex !== -1){
    // Cumuler les quantit√©s
    toBuyList[existingIndex].qty += qty;
    toBuyList[existingIndex].notes = mergeNotes(toBuyList[existingIndex].notes, notes);
  } else {
    // Ajouter nouveau
    toBuyList.push({ name, qty, notes });
  }

  localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));

  // Sync vers cloud imm√©diatement
  if(window.addAchat){
    console.log('‚òÅÔ∏è Sync ajout achat vers cloud:', { name, qty, notes });
    addAchat({ name, qty, notes }).then(() => {
      // Recharger depuis cloud pour √©viter les duplications
      if(window.getAchats){
        getAchats().then(result => {
          if(result && result.length > 0){
            const cloudNames = result.map(a => a.nom.toLowerCase());
            // Synchroniser la liste locale avec le cloud
            toBuyList = result.map(a => ({
              name: a.nom,
              qty: a.quantite,
              notes: a.notes || ''
            }));
            localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
            renderToBuy();
          }
        });
      }
    });
  } else {
    console.warn('‚ö†Ô∏è addAchat non disponible');
  }

  e.target.reset();
  document.getElementById('tobuy-qty').value = 1;
  renderToBuy();
});

/* =========================
   SAUVEGARDE / RESTAURATION / VIDAGE
========================= */
function downloadJSON(filename, dataObj){
  const json = JSON.stringify(dataObj, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function saveBackup(){
  if(!auth) return;
  const payload = {
    app: "pharmacie_domicile",
    version: 1,
    exportedAt: new Date().toISOString(),
    medicines: meds
  };
  downloadJSON("pharmacie-stock.json", payload);
  alert("‚úÖ Sauvegarde t√©l√©charg√©e : pharmacie-stock.json");
}

function restoreBackupFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);

      // accepter 2 formats:
      // - { medicines: [...] }
      // - [...] (liste directe)
      const list = Array.isArray(obj) ? obj : (obj && Array.isArray(obj.medicines) ? obj.medicines : null);
      if(!list) throw new Error("Format invalide");

      // validation minimale
      const cleaned = list.map(x => ({
        name: normalizeName(x.name),
        dosage: normalizeName(x.dosage),
        genre: x.genre || '',
        quantity: Number(x.quantity)||0,
        initialStock: Number(x.initialStock)||0,
        price: Number(x.price)||0,
        nbBoxes: Number(x.nbBoxes)||1,
        expiry: x.expiry,
        notes: (x.notes||"").toString()
      }));

      meds = cleaned;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
      localStorage.setItem(SEEDED_KEY, "1");

      renderAll();
      updateStats();
      alert("‚úÖ Restauration termin√©e !");
    }catch(err){
      alert("‚ùå Impossible de restaurer : fichier JSON invalide.");
    }
  };
  reader.readAsText(file);
}

function restoreBackup(){
  if(!auth) return;
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json,.json";
  input.onchange = () => {
    if(input.files && input.files[0]){
      const ok = confirm("‚ö†Ô∏è Restaurer va remplacer ton stock actuel. Continuer ?");
      if(!ok) return;
      restoreBackupFromFile(input.files[0]);
    }
  };
  input.click();
}

function clearAllStock(){
  if(!auth) return;
  const ok = confirm("üßπ Voulez-vous VRAIMENT vider tout le stock ? Cette action est irr√©versible.");
  if(!ok) return;

  meds = [];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
  localStorage.setItem(SEEDED_KEY, "1");

  // Effacer aussi le cloud
  if(window.clearAllCloudMeds){
    clearAllCloudMeds().then(() => {
      alert('‚úÖ Stock local ET cloud effac√©s.');
    }).catch(e => {
      console.error('Erreur effacement cloud:', e);
      alert('‚úÖ Stock local effac√©. Le cloud n\'a pas pu √™tre effac√©.');
    });
  } else {
    alert('‚úÖ Stock local effac√©.');
  }

  renderAll();
  updateStats();
}

/* =========================
   √âV√âNEMENTS UI
========================= */
document.getElementById('pwd-btn').addEventListener('click', checkPwd);
document.getElementById('logout-link').addEventListener('click', (e)=>{ e.preventDefault(); logout(); });

document.querySelectorAll('nav a[data-target]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    show(a.getAttribute('data-target'));
  });
});

// actions backup
document.getElementById('btn-save').addEventListener('click', (e)=>{ e.preventDefault(); saveBackup(); });
document.getElementById('btn-restore').addEventListener('click', (e)=>{ e.preventDefault(); restoreBackup(); });
document.getElementById('btn-sync').addEventListener('click', async (e)=>{ 
  e.preventDefault();
  
  if(!window.addMedicament || !window.getMedicaments){
    alert('Cloud non activ√©');
    return;
  }
  
  // D'abord pousser les donn√©es locales vers cloud
  if(meds.length > 0){
    console.log('üîÑ D√©but sync local‚Üícloud, meds count:', meds.length);
    logInfo('üì§ Push vers cloud...');
    
    try {
      // R√©cup√©rer les donn√©es cloud actuelles
      var cloudResult = await getMedicaments();
      var cloudMeds = cloudResult || [];
      
      console.log('Cloud a:', cloudMeds.length, 'm√©dicaments');
      
      // Cr√©er une map pour les m√©dicaments cloud par nom+dosage
      var cloudMap = {};
      cloudMeds.forEach(function(m){
        var key = keyOf(m.name, m.dosage);
        cloudMap[key] = m;
      });
      
      var synced = 0;
      
      // Pour chaque m√©dicament local, sync vers cloud
      for(var j = 0; j < meds.length; j++){
        var m = meds[j];
        var key = keyOf(m.name, m.dosage);
        
        var medData = {
          name: m.name,
          dosage: m.dosage,
          genre: m.genre,
          quantity: m.quantity,
          initialStock: m.initialStock,
          price: m.price,
          nbBoxes: m.nbBoxes,
          expiry: m.expiry,
          notes: m.notes || ''
        };
        
        if(cloudMap[key]){
          // Existe d√©j√† dans cloud, mettre √† jour
          console.log('Mise √† jour:', medData.name);
          await updateMedicament(cloudMap[key].id, medData);
          synced++;
        } else {
          // N'existe pas, cr√©er
          console.log('Cr√©ation:', medData.name);
          await addMedicament(medData);
          synced++;
        }
      }
      
      console.log('Push termin√©:', synced, 'm√©dicaments sync√©s');
      logSuccess('‚úÖ ' + synced + ' m√©dicaments push√©s');
      
    } catch(e) {
      console.error('Erreur push:', e);
      logError('‚ùå Erreur push: ' + e.message);
    }
  }
  
  // Puis charger les donn√©es cloud (pull)
  logInfo('üì• Pull depuis cloud...');
  loadFromCloud();
  
  alert('‚úÖ Sync termin√© ! Donn√©es synchronis√©es avec le cloud.');
});

// Bouton charger depuis cloud
document.getElementById('btn-load-cloud').addEventListener('click', (e)=>{ 
  e.preventDefault();
  if(!window.getMedicaments){
    alert('Cloud non activ√©');
    return;
  }
  logInfo('üì• Chargement donn√©es cloud...');
  loadFromCloud();
});

document.getElementById('btn-clear').addEventListener('click', (e)=>{ e.preventDefault(); clearAllStock(); });
document.getElementById('btn-clean-dup').addEventListener('click', (e)=>{ e.preventDefault(); clearLocalDuplicates(); });

// recherches live
['search','search-edit','search-delete','search-use'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', renderAll);
});

// auto-format MM/AA
function attachMMAAFormatter(inputId){
  const el = document.getElementById(inputId);
  if(!el) return;
  el.addEventListener('input', ()=>{
    let v = el.value.replaceAll("/","").replace(/\D/g,'').slice(0,4);
    if(v.length >= 3) v = v.slice(0,2) + "/" + v.slice(2);
    el.value = v;
  });
}
attachMMAAFormatter('expiry-mmaa');
attachMMAAFormatter('edit-expiry-mmaa');

// clavier : Enter login, Escape edit
document.addEventListener('keydown', e=>{
  if(e.key === "Enter" && document.getElementById('pwd-modal').style.display !== 'none'){
    checkPwd();
  }
  if(e.key === "Escape" && document.getElementById('edit-modal').style.display === 'flex'){
    closeEdit();
  }
});

/* =========================
   DEBUG LOG SYNC
========================= */
function logDebug(msg, type){
  const debugDiv = document.getElementById('debug-sync');
  if(!debugDiv) return;
  
  debugDiv.style.display = 'block';
  const time = new Date().toLocaleTimeString();
  const cssClass = type === 'success' ? 'log-success' : (type === 'error' ? 'log-error' : 'log-info');
  
  const entry = document.createElement('div');
  entry.className = 'log-entry ' + cssClass;
  entry.textContent = '[' + time + '] ' + msg;
  
  debugDiv.appendChild(entry);
  debugDiv.scrollTop = debugDiv.scrollHeight;
  
  // Garder que les 20 derni√®res lignes
  while(debugDiv.children.length > 20){
    debugDiv.removeChild(debugDiv.firstChild);
  }
}
function logSuccess(msg){ logDebug(msg, 'success'); }
function logError(msg){ logDebug(msg, 'error'); }
function logInfo(msg){ logDebug(msg, 'info'); }

/* =========================
   INITIALISATION
========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  renderToBuy();

  // Initialiser le cloud
  function tryInitCloud(){
    if(typeof initCloud === 'function'){
      logInfo('üîÑ Connexion cloud...');
      console.log('üîÑ Tentative de connexion cloud...');
      initCloud().then(function(enabled){
        if(enabled){
          logSuccess('‚úÖ Cloud Supabase ACTIV√â');
          console.log('‚úÖ Cloud Supabase ACTIV√â');
          window.cloudReady = true;

          // Charger donn√©es cloud initiales
          loadFromCloud();

          // Sync automatique toutes les 30 secondes
          setInterval(() => {
            if(window.cloudReady){
              autoSyncFromCloud();
            }
          }, 30000); // 30 secondes
        } else {
          logInfo('‚ùå Cloud Supabase NON activ√©');
          console.log('‚ùå Cloud Supabase NON activ√©');
        }
      }).catch(function(e){
        logError('‚ùå Erreur initCloud: ' + e);
        console.error('‚ùå Erreur initCloud:', e);
      });
    } else {
      logInfo('‚è≥ Attente de cloud.js...');
      console.warn('‚è≥ Attente de cloud.js...');
      setTimeout(tryInitCloud, 100);
    }
  }
  tryInitCloud();
});

// Pas d'auto-sync - sync manuel uniquement
// Les modifications sont sync√©es imm√©diatement vers le cloud

// Sync manuel via bouton

// Sync automatique depuis cloud - VERSION ULTRA-S√âCURIS√âE
async function autoSyncFromCloud(){
  if(!window.getMedicaments) {
    console.warn('‚è≥ getMedicaments non disponible - sync retard√©');
    return;
  }

  console.log('üîÑ D√©marrage autoSyncFromCloud s√©curis√©...');

  try {
    var result = await getMedicaments();

    if(!result || result.length === 0) {
      console.log('‚ÑπÔ∏è Aucun m√©dicament dans le cloud');
      return;
    }

    var cloudMeds = result.map(function(m){
      return {
        id: m.id,
        name: m.nom,
        dosage: m.dosage,
        genre: m.genre,
        quantity: m.quantite,
        initialStock: m.stock_initial,
        price: m.prix,
        nbBoxes: m.nb_boites,
        expiry: m.date_peremption,
        notes: m.notes || ''
      };
    });

    console.log('‚òÅÔ∏è Cloud meds re√ßus:', cloudMeds.length);

    // PROTECTION ANTI-DOUBLONS : Cr√©er une map unique par cl√©
    var uniqueCloudMeds = {};
    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      if(!uniqueCloudMeds[key]){
        uniqueCloudMeds[key] = cm;
      } else {
        console.warn('‚ö†Ô∏è Doublon cloud ignor√©:', cm.name, cm.dosage);
      }
    });

    // Convertir en tableau unique
    cloudMeds = Object.values(uniqueCloudMeds);

    // PROTECTION : Assigner les IDs cloud UNIQUEMENT si ils n'existent pas
    var idsAssigned = false;
    meds.forEach(function(m){
      var key = keyOf(m.name, m.dosage);
      if(!m.id && uniqueCloudMeds[key]){
        m.id = uniqueCloudMeds[key].id;
        idsAssigned = true;
        console.log('‚úÖ ID assign√©:', m.name, m.id);
      }
    });

    if(idsAssigned){
      save();
      console.log('üíæ IDs locaux mis √† jour');
    }

    // PROTECTION ABSOLUE : Sync cloud ‚Üí local UNIQUEMENT pour les NOUVEAUX m√©dicaments
    // JAMAIS modifier ou √©craser les donn√©es locales existantes
    var localChanged = false;
    var addedCount = 0;

    // Cr√©er un Set des cl√©s locales existantes pour une v√©rification rapide
    var localKeys = new Set();
    meds.forEach(function(m){
      localKeys.add(keyOf(m.name, m.dosage));
    });

    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);

      // UNIQUEMENT ajouter si cette cl√© n'existe PAS en local
      if(!localKeys.has(key)){
        // NOUVEAU m√©dicament du cloud, l'ajouter AVEC VALIDATION ULTRA-STRICTE
        console.log('‚ûï Nouveau du cloud (prot√©g√©):', cm.name);

        // VALIDATION ULTRA-STRICTE : donn√©es essentielles ET coh√©rentes
        var name = (cm.name || '').trim();
        var dosage = (cm.dosage || '').trim();

        if(name && dosage && name.length > 0 && dosage.length > 0){
          // VALIDATION suppl√©mentaire : √©viter les donn√©es corrompues
          var quantity = Number(cm.quantity);
          var price = Number(cm.price);

          // Rejeter les donn√©es manifestement invalides
          if(isNaN(quantity) || quantity < 0 || isNaN(price) || price < 0){
            console.warn('‚ö†Ô∏è Donn√©es cloud invalides ignor√©es:', name, 'qty:', cm.quantity, 'price:', cm.price);
            return;
          }

          var validMed = {
            id: cm.id,
            name: name,
            dosage: dosage,
            genre: cm.genre || '',
            quantity: Math.max(0, quantity),
            initialStock: Math.max(0, Number(cm.initialStock) || 0),
            price: Math.max(0, price),
            nbBoxes: Math.max(1, Number(cm.nbBoxes) || 1),
            expiry: cm.expiry || null,
            notes: cm.notes || ''
          };

          meds.push(validMed);
          localChanged = true;
          addedCount++;
          console.log('‚úÖ M√©dicament ajout√© (prot√©g√©):', name, 'qty:', validMed.quantity, 'price:', validMed.price);
        } else {
          console.warn('‚ö†Ô∏è M√©dicament cloud ignor√© (donn√©es incompl√®tes):', cm);
        }
      }
      // PROTECTION TOTALE : Si la cl√© existe d√©j√† en local, NE RIEN FAIRE
    });

    if(localChanged){
      save();
      console.log('üíæ Sync termin√©: +' + addedCount + ' nouveaux m√©dicaments ajout√©s');
      if(typeof renderAll === 'function') renderAll();
      if(typeof updateStats === 'function') updateStats();
    } else {
      console.log('‚ÑπÔ∏è Aucune modification n√©cessaire (donn√©es locales pr√©serv√©es)');
    }

    // PROTECTION : Ne JAMAIS supprimer les m√©dicaments locaux
    // Les suppressions doivent √™tre faites manuellement

    // PROTECTION : Sync achats (√Ä acheter) avec validation stricte
    if(window.getAchats){
      try {
        var achatsResult = await getAchats();
        if(achatsResult && achatsResult.length > 0){
          console.log('üîÑ Sync achats s√©curis√©: cloud=' + achatsResult.length + ', local=' + toBuyList.length);

          // Cr√©er map unique des achats cloud AVEC VALIDATION
          var uniqueCloudAchats = {};
          achatsResult.forEach(function(a){
            var key = (a.nom || '').toLowerCase().trim();
            if(key && a.nom){
              uniqueCloudAchats[key] = {
                name: a.nom.trim(),
                qty: Math.max(1, Number(a.quantite) || 1), // Minimum 1
                notes: (a.notes || '').trim()
              };
            }
          });

          var changed = false;

          // PROTECTION : Mettre √† jour UNIQUEMENT les achats existants
          toBuyList.forEach(function(localItem, index){
            var key = localItem.name.toLowerCase().trim();
            var cloudItem = uniqueCloudAchats[key];

            if(cloudItem){
              // Mettre √† jour quantit√© et notes si diff√©rentes (avec validation)
              var newQty = Math.max(1, Number(cloudItem.qty) || 1);
              var newNotes = cloudItem.notes || '';

              if(localItem.qty !== newQty || localItem.notes !== newNotes){
                toBuyList[index].qty = newQty;
                toBuyList[index].notes = newNotes;
                changed = true;
                console.log('üîÑ Achat mis √† jour:', localItem.name, 'qty:', newQty);
              }
              // Retirer de la map cloud (d√©j√† trait√©)
              delete uniqueCloudAchats[key];
            }
            // NE PAS supprimer les achats locaux qui n'existent plus dans le cloud
          });

          // PROTECTION : N'ajouter les nouveaux QUE s'ils n'existent pas d√©j√†
          Object.values(uniqueCloudAchats).forEach(function(newItem){
            var exists = toBuyList.some(function(local){
              return local.name.toLowerCase().trim() === newItem.name.toLowerCase().trim();
            });

            if(!exists){
              toBuyList.push(newItem);
              changed = true;
              console.log('‚ûï Nouvel achat du cloud:', newItem.name);
            }
          });

          if(changed){
            localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
            if(typeof renderToBuy === 'function') renderToBuy();
          }
        }
      } catch(e) {
        console.warn('Sync achats √©chou√©:', e);
      }
    }

    window.cloudReady = true;
    console.log('‚úÖ Auto-sync s√©curis√© termin√© - donn√©es locales pr√©serv√©es');
  } catch(e) {
    console.warn('Sync auto √©chou√©:', e);
  }
}

// Subscription temps r√©el - √©couter les changements cloud
function subscribeToCloudChanges(){
  if(!window.subscribeToMedicaments) return;
  
  subscribeToMedicaments(function(payload){
    console.log('Cloud change detected:', payload);
    
    // Recharger depuis cloud quand un changement est d√©tect√©
    refreshFromCloud();
  });
}

// Rafra√Æchir depuis cloud (pour sync temps r√©el)
function refreshFromCloud(){
  if(!window.getMedicaments) return;
  
  getMedicaments().then(function(result){
    if(!result || result.length === 0) return;
    
    const cloudMeds = result.map(function(m){
      return {
        id: m.id,
        name: m.nom,
        dosage: m.dosage,
        genre: m.genre,
        quantity: m.quantite,
        initialStock: m.stock_initial,
        price: m.prix,
        nbBoxes: m.nb_boites,
        expiry: m.date_peremption,
        notes: m.notes || ''
      };
    });
    
    // Fusion cloud + local (AJOUTER + METTRE √Ä JOUR + SUPPRIMER)
    // Cr√©er map cloud par cl√©
    var cloudByKey = {};
    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      cloudByKey[key] = cm;
    });
    
    var deletedCount = 0;
    var updatedCount = 0;
    
    // Pour chaque med local, v√©rifier s'il existe dans cloud
    meds.forEach(function(lm){
      var key = keyOf(lm.name, lm.dosage);
      var cm = cloudByKey[key];
      
      if(!cm){
        // N'existe pas dans cloud ‚Üí supprimer local
        console.log('üóëÔ∏è Supprimer local (pas dans cloud):', lm.name);
        lm._toDelete = true;
        deletedCount++;
      } else {
        // Existe dans cloud ‚Üí v√©rifier si modifi√©
        if(lm._localModified && !cm._localModified){
          // Local modifi√© plus r√©cemment ‚Üí garder local
          console.log('‚è≠Ô∏è Skip update (local plus r√©cent):', lm.name);
        } else if(lm.quantity !== cm.quantity || lm.price !== cm.price || lm.expiry !== cm.expiry){
          // Cloud plus r√©cent ‚Üí prendre les donn√©es cloud
          console.log('‚úÖ Update depuis cloud:', lm.name, 'qty:', lm.quantity, '‚Üí', cm.quantity);
          lm.id = cm.id;
          lm.quantity = cm.quantity;
          lm.price = cm.price;
          lm.expiry = cm.expiry;
          lm.notes = cm.notes || '';
          updatedCount++;
        }
      }
    });
    
    // Supprimer les meds marqu√©s
    meds = meds.filter(function(m){ return !m._toDelete; });
    
    // Ajouter les nouveaux du cloud
    var addedCount = 0;
    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      var exists = meds.some(function(m){ return keyOf(m.name, m.dosage) === key; });
      console.log('üîç Check cloud med:', cm.name, '| key:', key, '| exists:', exists);
      if(!exists){
        meds.push(cm);
        addedCount++;
        console.log('‚ûï AJOUT√â:', cm.name);
      }
    });
    
    save();
    renderAll();
    updateStats();
    
    console.log('üìä Final meds count:', meds.length);
    if(addedCount > 0 || deletedCount > 0 || updatedCount > 0){
      console.log('‚úÖ Sync termin√©e: +' + addedCount + ' ajout√©s, -' + deletedCount + ' supprim√©s, ~' + updatedCount + ' mis √† jour');
    } else {
      console.log('‚ÑπÔ∏è Sync: pas de changements');
    }
  });
}

// Charger depuis cloud vers local (FUSION intelligente)
function loadFromCloud(){
  if(!window.getMedicaments) return;
  
  console.log('üîÑ loadFromCloud: r√©cup√©ration donn√©es cloud...');
  
  getMedicaments().then(function(result){
    if(!result || result.length === 0){
      console.log('‚ÑπÔ∏è Aucune donn√©e cloud ou erreur');
      return;
    }
    
    // Convertir cloud meds vers format local (avec 'name' au lieu de 'nom')
    var cloudMeds = result.map(function(m){
      return {
        id: m.id,
        name: m.nom,
        dosage: m.dosage,
        genre: m.genre,
        quantity: m.quantite,
        initialStock: m.stock_initial,
        price: m.prix,
        nbBoxes: m.nb_boites,
        expiry: m.date_peremption,
        notes: m.notes || ''
      };
    });
    
    console.log('üì• Cloud meds:', cloudMeds.length);
    
    if(cloudMeds.length > 0){
      // FUSION intelligente : ajouter nouveaux meds du cloud
      var localByKey = {};
      meds.forEach(function(m){
        localByKey[keyOf(m.name, m.dosage)] = m;
      });
      
      // Ajouter les meds du cloud qui n'existent pas en local
      var addedCount = 0;
      cloudMeds.forEach(function(cm){
        var key = keyOf(cm.name, cm.dosage);
        if(!localByKey[key]){
          meds.push(cm);
          addedCount++;
        }
      });
      
      if(addedCount > 0){
        save();
        renderAll();
        updateStats();
        console.log('‚úÖ Fusion cloud: ' + addedCount + ' nouveaux m√©dicaments ajout√©s');
      } else {
        console.log('‚ÑπÔ∏è Aucune nouvelle donn√©e cloud');
      }
    }
    
    // Charger aussi la liste √† acheter
    loadToBuyFromCloud();
  });
}

// Charger liste √† acheter depuis cloud (FUSION)
function loadToBuyFromCloud(){
  if(!window.getAchats) return;
  
  console.log('üîÑ loadToBuyFromCloud...');
  
  getAchats().then(function(result){
    if(!result || result.length === 0){
      console.log('‚ÑπÔ∏è Aucune donn√©e achats cloud');
      return;
    }
    
    // Fusion cloud + local (sans √©craser)
    const cloudNames = result.map(a => a.nom.toLowerCase());
    
    // Ajouter les nouveaux du cloud
    let changed = false;
    result.forEach(function(a){
      const key = a.nom.toLowerCase();
      const exists = toBuyList.some(lc => lc.name.toLowerCase() === key);
      if(!exists){
        toBuyList.push({
          name: a.nom,
          qty: a.quantite,
          notes: a.notes || ''
        });
        console.log('‚ûï Achat ajout√© depuis cloud:', a.nom);
        changed = true;
      }
    });
    
    // Supprimer les locaux qui n'existent plus dans cloud
    for(let i = toBuyList.length - 1; i >= 0; i--){
      const key = toBuyList[i].name.toLowerCase();
      if(!cloudNames.includes(key)){
        console.log('üóëÔ∏è Achat supprim√© local:', toBuyList[i].name);
        toBuyList.splice(i, 1);
        changed = true;
      }
    }
    
    if(changed){
      localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
      renderToBuy();
      console.log('‚úÖ Sync achats termin√©e:', toBuyList.length, 'articles');
    } else {
      console.log('‚ÑπÔ∏è Aucun changement achats');
    }
  });
}

// Charger depuis cloud ET afficher un message
async function loadAndShowFromCloud(){
  if(typeof getMedicaments !== 'function') {
    alert('‚ö†Ô∏è Cloud non activ√©');
    return;
  }
  
  var result = await getMedicaments();
  
  if(result.error){
    alert('‚ùå Erreur cloud: ' + result.error);
    return;
  }
  
  if(!result || result.length === 0){
    alert('‚ö†Ô∏è Aucune donn√©e dans le cloud');
    return;
  }
  
  var cloudMeds = result.map(function(m){
    return {
      id: m.id,
      name: m.nom,
      dosage: m.dosage,
      genre: m.genre,
      quantity: m.quantite,
      initialStock: m.stock_initial,
      price: m.prix,
      nbBoxes: m.nb_boites,
      expiry: m.date_peremption,
      notes: m.notes || ''
    };
  });
  
  // Fusionner : ajouter les m√©dicaments cloud qui n'existent pas en local
  var localMap = {};
  meds.forEach(function(m){
    var key = (m.name + '_' + m.dosage).toLowerCase();
    localMap[key] = true;
  });
  
  var added = 0;
  cloudMeds.forEach(function(cm){
    var key = (cm.name + '_' + cm.dosage).toLowerCase();
    if(!localMap[key]){
      meds.push(cm);
      added++;
    }
  });
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
  localStorage.setItem(SEEDED_KEY, "1");
  
  renderAll();
  updateStats();
  
  console.log('Fusion termin√©e:', added, 'nouveaux');
  alert('‚úÖ ' + added + ' m√©dicaments ajout√©s depuis cloud !');
}

// Sauvegarder TOUTES les donn√©es locales vers cloud
// Sauvegarder VERS cloud (mode FUSION - pas d'√©crasement)
async function saveAllToCloud(callback){
  if(typeof addMedicament !== 'function') {
    if(callback) callback();
    return;
  }
  
  console.log('D√©but sync fusion vers cloud, meds count:', meds.length);
  
  // R√©cup√©rer les donn√©es cloud actuelles
  var cloudData = await getMedicaments();
  var cloudMeds = cloudData || [];
  
  console.log('Cloud a:', cloudMeds.length, 'm√©dicaments');
  
  // Cr√©er une map pour les m√©dicaments cloud par nom+dosage
  var cloudMap = {};
  cloudMeds.forEach(function(m){
    var key = keyOf(m.name, m.dosage);
    cloudMap[key] = m;
  });
  
  // Pour chaque m√©dicament local, fusionner avec cloud
  for(var j = 0; j < meds.length; j++){
    var m = meds[j];
    var key = (m.name + '_' + m.dosage).toLowerCase();
    
    var medData = {
      name: m.name,
      dosage: m.dosage,
      genre: m.genre,
      quantity: m.quantity,
      initialStock: m.initialStock,
      price: m.price,
      nbBoxes: m.nbBoxes,
      expiry: m.expiry,
      notes: m.notes || ''
    };
    
    if(cloudMap[key]){
      // Existe d√©j√† dans cloud, mettre √† jour
      console.log('Mise √† jour:', medData.name);
      await updateMedicament(cloudMap[key].id, medData);
    } else {
      // N'existe pas, cr√©er
      console.log('Cr√©ation:', medData.name);
      await addMedicament(medData);
    }
  }
  
  console.log('Sync fusion termin√©e');
  if(callback) callback();
}

// Debug sync
async function forceDebugSync(){
  var localCount = meds.length;
  document.getElementById('debug-local-count').textContent = localCount;
  document.getElementById('debug-status').textContent = 'V√©rification...';
  if(!window.getMedicaments) return;
  try {
    var result = await getMedicaments();
    var cloudCount = result ? result.length : 0;
    document.getElementById('debug-cloud-count').textContent = cloudCount;
    if(cloudCount === 0 && localCount > 0){
      document.getElementById('debug-status').textContent = 'Sync...';
      var synced = 0;
      for(var m of meds){
        var addResult = await addMedicament(m);
        if(!addResult.error) synced++;
      }
      document.getElementById('debug-status').textContent = 'Termin√©! ' + synced;
    } else if(cloudCount > 0){
      document.getElementById('debug-status').textContent = 'Sync OK';
    }
  } catch(e){
    document.getElementById('debug-status').textContent = 'Erreur';
  }
}

// Clear local duplicates and sync with cloud
async function clearLocalDuplicates(){
  if(!auth) return;
  if(!confirm('‚ö†Ô∏è Voulez-vous supprimer les doublons locaux et synchroniser avec le cloud ?')) return;

  console.log('üßπ Suppression des doublons locaux...');

  // Cr√©er une map pour d√©tecter les doublons
  var uniqueMeds = {};
  var duplicatesRemoved = 0;

  meds.forEach(function(m, index){
    var key = keyOf(m.name, m.dosage);
    if(uniqueMeds[key]){
      // Doublon trouv√©, supprimer
      duplicatesRemoved++;
      console.log('üóëÔ∏è Doublon supprim√©:', m.name, m.dosage);
    } else {
      uniqueMeds[key] = m;
    }
  });

  // Convertir la map en tableau
  meds = Object.values(uniqueMeds);

  console.log('‚úÖ Doublons supprim√©s:', duplicatesRemoved);
  console.log('üìä M√©dicaments uniques restants:', meds.length);

  save();
  renderAll();
  updateStats();

  // Synchroniser avec le cloud
  if(window.getMedicaments){
    console.log('üîÑ Synchronisation avec le cloud...');
    loadFromCloud();
  }

  alert('‚úÖ Nettoyage termin√© ! ' + duplicatesRemoved + ' doublons supprim√©s.');
}

// Improved sync for "√Ä acheter" deletions
async function syncToBuyDeletions(){
  if(!window.getAchats) return;

  try {
    var cloudResult = await getAchats();
    if(!cloudResult || cloudResult.length === 0){
      // Si cloud vide, vider local aussi
      toBuyList = [];
      localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
      renderToBuy();
      console.log('üóëÔ∏è Liste "√Ä acheter" vid√©e (cloud vide)');
      return;
    }

    // Cr√©er map des noms cloud
    var cloudNames = {};
    cloudResult.forEach(function(a){
      cloudNames[a.nom.toLowerCase()] = {
        qty: a.quantite,
        notes: a.notes || ''
      };
    });

    var changed = false;

    // Supprimer les locaux qui n'existent plus dans cloud
    for(var i = toBuyList.length - 1; i >= 0; i--){
      var localName = toBuyList[i].name.toLowerCase();
      if(!cloudNames[localName]){
        console.log('üóëÔ∏è Suppression locale (pas dans cloud):', toBuyList[i].name);
        toBuyList.splice(i, 1);
        changed = true;
      } else {
        // Mettre √† jour quantit√© si diff√©rente
        var cloudItem = cloudNames[localName];
        if(toBuyList[i].qty !== cloudItem.qty || toBuyList[i].notes !== cloudItem.notes){
          toBuyList[i].qty = cloudItem.qty;
          toBuyList[i].notes = cloudItem.notes;
          changed = true;
          console.log('üîÑ Quantit√© mise √† jour:', toBuyList[i].name);
        }
      }
    }

    if(changed){
      localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
      renderToBuy();
      console.log('‚úÖ Sync "√Ä acheter" termin√©');
    }

  } catch(e) {
    console.warn('Erreur sync "√Ä acheter":', e);
  }
}

</script>

<!-- Cloud Integration (REST API) -->
<script src="cloud.js"></script>

</body>
</html>