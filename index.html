<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion de la Pharmacie √† Domicile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --primary:#ff6f61;
      --accent:#88c0d0;
      --text:#363636;
      --radius:8px;
      --shadow:rgba(0,0,0,0.1);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;background:#fff;color:var(--text);min-height:100vh}
    nav{background:var(--primary);padding:.75rem;position:sticky;top:0;z-index:100}
    nav ul{display:flex;flex-wrap:wrap;gap:1rem;list-style:none;align-items:center}
    nav a{color:#fff;text-decoration:none;padding:.5rem 1rem;border-radius:var(--radius);transition:background .3s;display:inline-block}
    nav a:hover{background:rgba(255,255,255,.2)}
    .container{padding:2rem;max-width:1200px;margin:auto}
    section{display:none}
    section.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:1rem;box-shadow:0 2px 8px var(--shadow);border-radius:var(--radius);overflow:hidden}
    th,td{padding:.75rem;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    th{background:var(--accent);color:#fff;font-weight:600}
    tr:hover{background:#f9f9f9}
    .expired{color:#d32f2f!important;font-weight:bold}
    .expiring-soon{color:#f57c00!important;font-weight:bold}
    .valid{color:#2e7d32!important}
    .stock-zero{color:#d32f2f!important;font-weight:bold;background:#ffebee}
    .action-btn{background:none;border:none;cursor:pointer;margin:0 .25rem;font-size:1.1rem;padding:.3rem;border-radius:var(--radius);transition:transform .2s}
    .action-btn:hover{transform:scale(1.2)}
    .edit{color:#2a9d8f}
    .delete{color:#e76f51}
    .use{color:#ff7f50}
    form{max-width:520px;margin-top:1rem;background:#fff;padding:1.5rem;border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow)}
    .form-group{margin-bottom:1.2rem}
    label{display:block;margin-bottom:.5rem;font-weight:bold;color:var(--primary)}
    input,textarea{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem}
    input:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(136,192,208,.2)}
    textarea{resize:vertical;min-height:80px}
    button[type=submit]{background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;font-weight:600}
    button[type=submit]:hover{background:#e85a50}

    #search,#search-edit,#search-delete,#search-use{
      width:100%;padding:.75rem;margin-bottom:1rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem
    }
    .notes-cell{max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .notes-cell:hover{white-space:normal;overflow:visible}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin:2rem 0}
    .stat-card{background:#fff;padding:1.5rem;border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow);text-align:center}
    .stat-number{font-size:2rem;font-weight:bold;margin:.5rem 0}

    .password-modal{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:10000}
    .password-content{background:#fff;padding:2rem;border-radius:var(--radius);text-align:center;width:90%;max-width:420px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
    .empty-msg{text-align:center;padding:2rem;color:#666;font-style:italic}

    .nav-btn{
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.25);
    }
    .nav-btn:hover{background:rgba(255,255,255,.28)}

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      /* Navigation mobile - menu compact en grille */
      nav{padding:.3rem}
      nav ul{
        display:grid;
        grid-template-columns:repeat(3,1fr);
        gap:.3rem;
        align-items:center
      }
      nav a{
        padding:.3rem .4rem;
        font-size:.75rem;
        text-align:center
      }
      
      /* Container - plus compact */
      .container{padding:.5rem}
      
      /* Titres r√©duits */
      h1{font-size:1rem}
      h2{font-size:.95rem}
      h3{font-size:.9rem}
      
      /* Stats grid - compact */
      .stats-grid{
        grid-template-columns:repeat(2,1fr);
        gap:.4rem;
        margin:.5rem 0
      }
      .stat-card{
        padding:.5rem
      }
      .stat-number{font-size:1.1rem}
      
      /* Forms - compact */
      form{
        padding:.5rem;
        margin-top:.3rem
      }
      .form-group{margin-bottom:.5rem}
      label{font-size:.9rem;margin-bottom:.3rem}
      
      /* Inputs plus compacts */
      input,textarea,select{
        padding:.4rem;
        font-size:.85rem
      }
      
      /* Buttons */
      button[type=submit]{
        padding:.4rem .75rem;
        font-size:.85rem
      }
      
      /* Search + value row */
      #inventory>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }
      #inventory>div[style*="display:flex"]>div{
        justify-content:center
      }
      
      /* Use mode quantity */
      #use-mode>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }
      
      /* Tables responsive avec scroll horizontal */
      table{
        font-size:.75rem;
        display:block;
        overflow-x:auto;
        white-space:nowrap
      }
      th,td{
        padding:.3rem .25rem;
        min-width:50px
      }
      .notes-cell{max-width:60px}
      
      /* Modal edit */
      #edit-modal{padding:.2rem}
      #edit-modal>div{
        padding:.5rem;
        max-width:98vw
      }
      
      /* Modal password */
      .password-content{
        padding:.75rem;
        max-width:90vw
      }
      
      /* Buttons row in modal */
      #edit-modal>div>form>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }
    }

    @media (max-width: 480px) {
      /* Navigation mobile - 7 boutons visibles en grille */
      nav ul{
        grid-template-columns:repeat(4,1fr);
        gap:.2rem
      }
      nav a{
        padding:.25rem .3rem;
        font-size:.7rem
      }
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      
      /* Masquer les boutons secondaires sur tr√®s petit √©cran */
      #btn-save,
      #btn-restore,
      #btn-clear{
        display:none
      }
      
      /* Garder les boutons essentiels */
      nav ul li:nth-child(-n+7){
        display:block
      }
      
      /* Always show Quitter button */
      #logout-link{
        display:block !important
      }
      
      /* Cacher la colonne Actions (colonne 10) */
      #med-table th:nth-child(10),
      #med-table td:nth-child(10),
      #med-table-edit th:nth-child(4),
      #med-table-edit td:nth-child(4),
      #med-table-edit th:nth-child(5),
      #med-table-edit td:nth-child(5),
      #med-table-delete th:nth-child(4),
      #med-table-delete td:nth-child(4),
      #med-table-delete th:nth-child(5),
      #med-table-delete td:nth-child(5),
      #med-table-use th:nth-child(4),
      #med-table-use td:nth-child(4),
      #med-table-use th:nth-child(5),
      #med-table-use td:nth-child(5){
        display:none
      }
      
      /* Colonnes visibles sur mobile */
      #med-table th:nth-child(1),
      #med-table td:nth-child(1){
        min-width:80px
      }
      #med-table th:nth-child(2),
      #med-table td:nth-child(2){
        min-width:60px
      }
      #med-table th:nth-child(3),
      #med-table td:nth-child(3){
        min-width:50px
      }
      #med-table th:nth-child(4),
      #med-table td:nth-child(4){
        min-width:40px
      }
      #med-table th:nth-child(5),
      #med-table td:nth-child(5){
        min-width:50px
      }
      #med-table th:nth-child(6),
      #med-table td:nth-child(6){
        min-width:50px
      }
      #med-table th:nth-child(7),
      #med-table td:nth-child(7){
        min-width:60px
      }
      #med-table th:nth-child(8),
      #med-table td:nth-child(8){
        min-width:50px
      }
      #med-table th:nth-child(9),
      #med-table td:nth-child(9){
        min-width:70px
      }
    }
  </style>
</head>

<body>

  <!-- Modal de connexion -->
  <div id="pwd-modal" class="password-modal">
    <div class="password-content">
      <h2>üîê Acc√®s s√©curis√©</h2>
      <p style="margin-top:.5rem;">Entrez le mot de passe pour acc√©der √† l'application</p>

      <input type="password" id="pwd-input" placeholder="Mot de passe"
             style="width:100%;padding:.75rem;margin:1rem 0;border:1px solid #ddd;border-radius:var(--radius);font-size:1.1rem;" />

      <button id="pwd-btn"
              style="background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;font-weight:600;">
        Acc√©der
      </button>

      <p id="pwd-error" style="color:#d32f2f;margin-top:1rem;display:none;">Mot de passe incorrect</p>
      <p style="margin-top:1rem;font-size:.9rem;color:#666;">Astuce : Entr√©e = valider</p>
    </div>
  </div>

  <!-- Navigation -->
  <nav id="main-nav" style="display:none;">
    <ul>
      <li><a href="#" data-target="home">üè† Accueil</a></li>
      <li><a href="#" data-target="inventory">üì¶ Inventaire</a></li>
      <li><a href="#" data-target="add">‚ûï Saisie</a></li>
      <li><a href="#" data-target="edit-mode">‚úèÔ∏è Modifier</a></li>
      <li><a href="#" data-target="delete-mode">üóëÔ∏è Supprimer</a></li>
      <li><a href="#" data-target="use-mode">üíä Utiliser</a></li>
      <li><a href="#" data-target="to-buy">üõí √Ä acheter</a></li>

      <!-- NOUVEAU : Sauvegarder / Restaurer / Vider -->
      <li><a href="#" id="btn-save" class="nav-btn">üíæ Sauvegarder</a></li>
      <li><a href="#" id="btn-restore" class="nav-btn">üìÇ Restaurer</a></li>
      <li><a href="#" id="btn-clear" class="nav-btn">üßπ Vider tout</a></li>
      <li><a href="#" id="btn-cloud" class="nav-btn">‚òÅÔ∏è Cloud</a></li>

      <li><a href="#" id="logout-link">üö™ Quitter</a></li>
    </ul>
  </nav>

  <div class="container" id="main" style="display:none;">

    <!-- Accueil -->
    <section id="home" class="section active">
      <h1>üè• Gestionnaire de Pharmacie √† Domicile</h1>

      <div class="stats-grid">
        <div class="stat-card"><h3>üìä Stock total</h3><div class="stat-number" id="total-meds">0</div></div>
        <div class="stat-card"><h3>‚ùå Expir√©s</h3><div class="stat-number" id="expired-count">0</div></div>
        <div class="stat-card"><h3>‚ö†Ô∏è Pr√©‚Äëexpiration</h3><div class="stat-number" id="preexp-count">0</div></div>
        <div class="stat-card"><h3>üì¶ Stock nul</h3><div class="stat-number" id="zerostock-count">0</div></div>
      </div>

      <h3>üìã M√©dicaments n√©cessitant une attention</h3>
      <div id="attention-list" style="margin-top:.75rem;"></div>
    </section>

    <!-- Inventaire -->
    <section id="inventory" class="section">
      <h2>üì¶ Inventaire complet</h2>

      <div style="display:flex;gap:1rem;margin:1rem 0;align-items:center;flex-wrap:wrap;">
        <input type="text" id="search" placeholder="üîé Rechercher (nom, dosage, notes)‚Ä¶" style="flex:1;">
        <div style="background:#e8f5e8;padding:.6rem 1rem;border-radius:var(--radius);font-size:.95rem;">
          üí∞ Valeur totale : <strong id="total-value">0.00 DH</strong>
        </div>
      </div>

      <table id="med-table">
        <thead>
          <tr>
            <th>Nom</th><th>Genre</th><th>Dosage</th><th>Qt√©</th><th>Stock init.</th><th>Prix (DH)</th>
            <th>P√©remption</th><th>Alerte</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ajout -->
    <section id="add" class="section">
      <h2>‚ûï Ajouter un m√©dicament</h2>

      <form id="add-form">
        <div class="form-group"><label>Nom *</label><input type="text" id="name" required></div>
        <div class="form-group"><label>Dosage *</label><input type="text" id="dosage" placeholder="ex : 500mg, 10ml" required></div>
        <div class="form-group"><label>Genre *</label>
          <select id="genre" required style="width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem;">
            <option value="">S√©lectionner...</option>
            <option value="Comprim√©s">Comprim√©s</option>
            <option value="G√©lules">G√©lules</option>
            <option value="Suppositoires">Suppositoires</option>
            <option value="Sachets">Sachets</option>
            <option value="Gel">Gel</option>
            <option value="Flacon">Flacon</option>
            <option value="Sirop">Sirop</option>
            <option value="Solution">Solution</option>
            <option value="Pommade">Pommade</option>
            <option value="Lotion">Lotion</option>
            <option value="Cr√®me">Cr√®me</option>
            <option value="Poudre">Poudre</option>
            <option value="Gouttes">Gouttes</option>
            <option value="Inhalation">Inhalation</option>
            <option value="Patch">Patch</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <!-- Stock initial AVANT quantit√© actuelle -->
        <div class="form-group"><label>Stock initial *</label><input type="number" id="initial-stock" min="0" required></div>
        <div class="form-group"><label>Quantit√© actuelle *</label><input type="number" id="quantity" min="0" required></div>

        <div class="form-group"><label>Prix (DH) *</label><input type="number" id="price" min="0" step="0.01" required></div>
        <div class="form-group"><label>Nombre de bo√Ætes *</label><input type="number" id="nb-boxes" min="1" value="1" required></div>

        <div class="form-group">
          <label>Date de p√©remption (MM/AA) *</label>
          <input type="text" id="expiry-mmaa" inputmode="numeric" placeholder="ex : 02/26" maxlength="5" required>
          <small style="display:block;margin-top:.5rem;color:#666;">Format : MM/AA</small>
        </div>

        <div class="form-group"><label>Notes</label><textarea id="notes" placeholder="Optionnel"></textarea></div>

        <button type="submit">üíä Ajouter</button>
      </form>
    </section>

    <!-- Modifier -->
    <section id="edit-mode" class="section">
      <h2>‚úèÔ∏è Modifier</h2>
      <input type="text" id="search-edit" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-edit">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>Stock init.</th><th>Prix (DH)</th>
            <th>P√©remption</th><th>Notes</th><th>Modifier</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Supprimer -->
    <section id="delete-mode" class="section">
      <h2>üóëÔ∏è Supprimer</h2>
      <input type="text" id="search-delete" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-delete">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>Stock init.</th><th>Prix (DH)</th>
            <th>P√©remption</th><th>Supprimer</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Utiliser -->
    <section id="use-mode" class="section">
      <h2>üíä Utiliser</h2>

      <div class="form-group" style="max-width:420px;">
        <label for="use-qty">Quantit√© √† utiliser :</label>
        <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
          <input type="number" id="use-qty" min="1" value="1" style="width:120px;">
          <span class="chip">Alerte stock faible ‚â§ 5</span>
        </div>
      </div>

      <input type="text" id="search-use" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-use">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>Stock init.</th><th>Prix (DH)</th>
            <th>P√©remption</th><th>Utiliser</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- √Ä acheter -->
    <section id="to-buy" class="section">
      <h2>üõí M√©dicaments √† acheter</h2>

      <form id="tobuy-form" style="max-width:420px;">
        <div class="form-group"><label>Nom du m√©dicament *</label><input type="text" id="tobuy-name" required></div>
        <div class="form-group"><label>Quantit√© *</label><input type="number" id="tobuy-qty" min="1" value="1" required></div>
        <div class="form-group"><label>Genre / Notes</label><input type="text" id="tobuy-notes" placeholder="ex : comprim√©, sirop, cr√®me..."></div>
        <button type="submit">‚ûï Ajouter √† la liste</button>
      </form>

      <table id="tobuy-table" style="margin-top:1.5rem;">
        <thead>
          <tr>
            <th>Nom</th><th>Quantit√©</th><th>Genre</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </div>

  <!-- Modal d'√©dition -->
  <div id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000;overflow-y:auto;padding:1rem;">
    <div style="background:#fff;padding:2rem;border-radius:8px;width:100%;max-width:540px;box-shadow:0 4px 20px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto;">
      <h3 style="color:var(--primary);margin-bottom:1.2rem;">‚úèÔ∏è Modifier le m√©dicament</h3>

      <form id="edit-form">
        <input type="hidden" id="edit-index">

        <div class="form-group"><label>Nom *</label><input type="text" id="edit-name" required></div>
        <div class="form-group"><label>Dosage *</label><input type="text" id="edit-dosage" required></div>
        <div class="form-group"><label>Genre *</label>
          <select id="edit-genre" required style="width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem;">
            <option value="">S√©lectionner...</option>
            <option value="Comprim√©s">Comprim√©s</option>
            <option value="G√©lules">G√©lules</option>
            <option value="Suppositoires">Suppositoires</option>
            <option value="Sachets">Sachets</option>
            <option value="Gel">Gel</option>
            <option value="Flacon">Flacon</option>
            <option value="Sirop">Sirop</option>
            <option value="Solution">Solution</option>
            <option value="Pommade">Pommade</option>
            <option value="Lotion">Lotion</option>
            <option value="Cr√®me">Cr√®me</option>
            <option value="Poudre">Poudre</option>
            <option value="Gouttes">Gouttes</option>
            <option value="Inhalation">Inhalation</option>
            <option value="Patch">Patch</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div class="form-group"><label>Stock initial *</label><input type="number" id="edit-initial" min="0" required></div>
        <div class="form-group"><label>Quantit√© actuelle *</label><input type="number" id="edit-quantity" min="0" required></div>

        <div class="form-group"><label>Prix (DH) *</label><input type="number" id="edit-price" min="0" step="0.01" required></div>
        <div class="form-group"><label>Nombre de bo√Ætes *</label><input type="number" id="edit-nb-boxes" min="1" value="1" required></div>

        <div class="form-group">
          <label>P√©remption (MM/AA) *</label>
          <input type="text" id="edit-expiry-mmaa" inputmode="numeric" maxlength="5" placeholder="ex : 02/26" required>
        </div>

        <div class="form-group"><label>Notes</label><textarea id="edit-notes"></textarea></div>

        <div style="display:flex;gap:1rem;flex-wrap:wrap;">
          <button type="submit" style="flex:1;">üíæ Enregistrer</button>
          <button type="button" id="edit-cancel" style="flex:1;background:#6c757d;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;font-weight:600;">‚ùå Annuler</button>
        </div>
      </form>

      <p style="margin-top:1rem;font-size:.9rem;color:#666;">Astuce : √âchap = fermer</p>
    </div>
  </div>

<script>
/* =========================
   CONFIG / STOCKAGE
========================= */
const PASSWORD = "mohamed1964";
const STORAGE_KEY = "medicines";
const TOBUY_KEY = "medicines_to_buy";

// (optionnel) cl√© si tu veux g√©rer des exemples une seule fois
const SEEDED_KEY = "medicines_seeded_once";

let auth = false;
let meds = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let toBuyList = JSON.parse(localStorage.getItem(TOBUY_KEY)) || [];

/* =========================
   UTILITAIRES
========================= */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(meds)); }

function normalizeName(str){
  return String(str || "").trim().replace(/\s+/g, " ");
}
function keyOf(name, dosage){
  return (normalizeName(name) + "||" + normalizeName(dosage)).toLowerCase();
}

function fmtMMAAFromISO(iso){
  const dt = new Date(iso);
  if (isNaN(dt.getTime())) return "-";
  return `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getFullYear()).slice(-2)}`;
}
function fmtMMAA(d){ return fmtMMAAFromISO(d); }

function parseMMAAtoISO(mmaa){
  const raw = String(mmaa || "").trim();
  const compact = raw.replaceAll("/","").replace(/\D/g,'').slice(0,4);
  if(/^\d{4}$/.test(compact)){
    mmaa = compact.slice(0,2) + "/" + compact.slice(2,4);
  } else {
    mmaa = raw;
  }

  if(!/^\d{2}\/\d{2}$/.test(mmaa)) return null;

  const mm = parseInt(mmaa.slice(0,2), 10);
  const aa = parseInt(mmaa.slice(3,5), 10);
  if(mm < 1 || mm > 12) return null;

  const yyyy = (aa <= 79) ? (2000 + aa) : (1900 + aa);
  const iso = `${yyyy}-${String(mm).padStart(2,'0')}-01`;
  const dt = new Date(iso);
  if(isNaN(dt.getTime())) return null;
  return iso;
}

function expClass(iso){
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(iso); exp.setHours(0,0,0,0);
  const diff = Math.ceil((exp - today) / (1000*60*60*24));
  if(diff < 0) return "expired";
  if(diff <= 30) return "expiring-soon";
  return "valid";
}
function stockClass(q){ return (Number(q) === 0) ? "stock-zero" : ""; }

function mergeNotes(a,b){
  const n1 = (a||'').trim();
  const n2 = (b||'').trim();
  if(!n1) return n2;
  if(!n2) return n1;
  if(n1.toLowerCase() === n2.toLowerCase()) return n1;
  return n1 + " | " + n2;
}
function earliestExpiry(aISO, bISO){
  if(!aISO) return bISO;
  if(!bISO) return aISO;
  const da = new Date(aISO);
  const db = new Date(bISO);
  return (db < da) ? bISO : aISO;
}

/* =========================
   AUTH
========================= */
function setAppVisible(isVisible){
  document.getElementById('pwd-modal').style.display = isVisible ? 'none' : 'flex';
  document.getElementById('main-nav').style.display = isVisible ? 'block' : 'none';
  document.getElementById('main').style.display = isVisible ? 'block' : 'none';
}
function checkPwd(){
  const val = document.getElementById('pwd-input').value;
  if(val === PASSWORD){
    auth = true;
    document.getElementById('pwd-error').style.display = 'none';
    setAppVisible(true);
    show('inventory');
    updateStats();
    renderAll();
  } else {
    document.getElementById('pwd-error').style.display = 'block';
  }
}
function logout(){
  auth = false;
  setAppVisible(false);
  document.getElementById('pwd-input').value = '';
  document.getElementById('pwd-error').style.display = 'none';
}

/* =========================
   NAVIGATION
========================= */
function show(id){
  if(!auth) return;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  renderAll();
  if(id === 'to-buy') renderToBuy();
}

/* =========================
   STATS + LISTE ATTENTION
========================= */
function updateStats(){
  const today = new Date(); today.setHours(0,0,0,0);
  const limit = new Date(today); limit.setDate(today.getDate() + 30);

  let exp=0, pre=0, zer=0;
  let listHtml = '';

  meds.forEach(m=>{
    const e = new Date(m.expiry); e.setHours(0,0,0,0);
    const isExp = e < today;
    const isPre = !isExp && e <= limit;
    const isZero = Number(m.quantity) === 0;

    if(isExp) exp++;
    if(isPre) pre++;
    if(isZero) zer++;

    if(isExp || isPre || isZero){
      let status = '';
      if(isExp) status = '‚ùå EXPIR√â';
      else if(isPre) status = '‚ö†Ô∏è PR√â‚ÄëEXPIRATION';
      else status = 'üì¶ STOCK NUL';

      listHtml += `
        <div style="background:#fff;padding:1rem;margin:.5rem 0;border-radius:var(--radius);box-shadow:0 1px 4px var(--shadow);">
          <strong>${escapeHtml(m.name)}</strong> (${escapeHtml(m.dosage)}) ‚Äì ${status}
          <br><small>Qt√© : ${Number(m.quantity)||0}, Exp : ${fmtMMAA(m.expiry)}</small>
        </div>`;
    }
  });

  document.getElementById('total-meds').textContent = meds.length;
  document.getElementById('expired-count').textContent = exp;
  document.getElementById('preexp-count').textContent = pre;
  document.getElementById('zerostock-count').textContent = zer;

  document.getElementById('attention-list').innerHTML =
    listHtml || '<p style="color:#2e7d32;">‚úÖ Aucun probl√®me d√©tect√©</p>';
}

/* =========================
   RECHERCHE PAR SECTION
========================= */
function getActiveSearchValue(){
  const activeSection = document.querySelector('.section.active');
  if(!activeSection) return '';
  const input = activeSection.querySelector('input[id^="search"]');
  return input ? (input.value || '').toLowerCase() : '';
}

/* =========================
   RENDU TABLEAUX
========================= */
function renderAll(){
  if(!auth) return;

  const filter = getActiveSearchValue();

  const filtered = filter ? meds.filter(m => {
    const n = (m.name || '').toLowerCase();
    const d = (m.dosage || '').toLowerCase();
    const no = (m.notes || '').toLowerCase();
    return n.includes(filter) || d.includes(filter) || no.includes(filter);
  }) : meds;

  function renderTable(tableId){
    const tbody = document.querySelector(`#${tableId} tbody`);
    if(!tbody) return;

    tbody.innerHTML = '';

    if(filtered.length === 0){
      const colCount =
        tableId === 'med-table' ? 10 :
        tableId === 'med-table-edit' ? 8 :
        tableId === 'med-table-delete' ? 7 :
        tableId === 'med-table-use' ? 7 : 10;

      tbody.innerHTML = `<tr><td colspan="${colCount}" class="empty-msg">Aucun m√©dicament trouv√©</td></tr>`;
      return;
    }

    filtered.forEach(m=>{
      const idx = meds.indexOf(m);
      const expCls = expClass(m.expiry);
      const stkCls = stockClass(Number(m.quantity));
      const q = Number(m.quantity) || 0;
      const p = Number(m.price) || 0;

      // Calcul des alertes
      let alertMsgs = [];
      if (q < 5) alertMsgs.push('<span style="color:#d32f2f;font-weight:bold;">stock < 5</span>');
      
      const today = new Date(); today.setHours(0,0,0,0);
      const exp = new Date(m.expiry); exp.setHours(0,0,0,0);
      const diffDays = Math.ceil((exp - today) / (1000*60*60*24));
      if (diffDays <= 30) alertMsgs.push('<span style="color:#f57c00;font-weight:bold;">date < 1mois</span>');

      let alertHtml = alertMsgs.length > 0 ? alertMsgs.join('<br>') : '-';

      let row = `
        <tr class="${stkCls}">
          <td style="color:#1976d2;font-weight:bold;">${escapeHtml(m.name)}</td>
          <td>${escapeHtml(m.genre || '-')}</td>
          <td>${escapeHtml(m.dosage)}</td>
          <td style="color:#d32f2f;font-weight:bold;font-size:1.1em;">${q}</td>
          <td>${Number(m.initialStock) || 0}</td>
          <td>${p.toFixed(2)} DH</td>
          <td class="${expCls}">${fmtMMAA(m.expiry)}</td>
          <td>${alertHtml}</td>
      `;

      if(tableId === 'med-table'){
        row += `
          <td class="notes-cell" title="${escapeAttr(m.notes || '')}">${escapeHtml(m.notes || '-')}</td>
          <td>
            <button class="action-btn edit" title="Modifier" onclick="openEdit(${idx})">‚úèÔ∏è</button>
            <button class="action-btn delete" title="Supprimer" onclick="removeMed(${idx})">üóëÔ∏è</button>
            <button class="action-btn use" title="Utiliser" onclick="useMed(${idx})">üíä</button>
          </td>
        `;
      } else if(tableId === 'med-table-edit'){
        row += `
          <td class="notes-cell" title="${escapeAttr(m.notes || '')}">${escapeHtml(m.notes || '-')}</td>
          <td><button class="action-btn edit" title="Modifier" onclick="openEdit(${idx})">‚úèÔ∏è</button></td>
        `;
      } else if(tableId === 'med-table-delete'){
        row += `
          <td><button class="action-btn delete" title="Supprimer" onclick="removeMed(${idx})">üóëÔ∏è</button></td>
        `;
      } else if(tableId === 'med-table-use'){
        row += `
          <td><button class="action-btn use" title="Utiliser" onclick="useMed(${idx})">üíä</button></td>
        `;
      }

      row += `</tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  renderTable('med-table');
  renderTable('med-table-edit');
  renderTable('med-table-delete');
  renderTable('med-table-use');

  const total = filtered.reduce((sum, m) => {
    const p = Number(m.price) || 0;
    const nb = Number(m.nbBoxes) || 1;
    return sum + (p * nb);
  }, 0);

  const totalEl = document.getElementById('total-value');
  if (totalEl) totalEl.textContent = total.toFixed(2) + " DH";
}

/* =========================
   AJOUT (avec alerte + cumul)
========================= */
document.getElementById('add-form').addEventListener('submit', function(e){
  e.preventDefault();

  const name = normalizeName(document.getElementById('name').value);
  const dosage = normalizeName(document.getElementById('dosage').value);
  const genre = document.getElementById('genre').value;

  const initialStock = parseInt(document.getElementById('initial-stock').value, 10) || 0;
  const quantity = parseInt(document.getElementById('quantity').value, 10) || 0;

  const priceVal = parseFloat(document.getElementById('price').value);
  const price = Number.isFinite(priceVal) ? priceVal : 0;

  const nbBoxes = parseInt(document.getElementById('nb-boxes').value, 10) || 1;

  const expiryMMAA = document.getElementById('expiry-mmaa').value;
  const expiryISO = parseMMAAtoISO(expiryMMAA);
  if(!expiryISO){
    alert("‚ùå Date invalide. Utilise MM/AA (ex : 02/26).");
    return;
  }

  const notes = document.getElementById('notes').value.trim();

  const k = keyOf(name, dosage);
  const existingIndex = meds.findIndex(m => keyOf(m.name, m.dosage) === k);

  if(existingIndex === -1){
    meds.push({ name, dosage, genre, initialStock, quantity, price, nbBoxes, expiry: expiryISO, notes });
    save();
    e.target.reset();
    show('inventory');
    renderAll();
    updateStats();
    return;
  }

  const ex = meds[existingIndex];

  const msg =
`‚ö†Ô∏è Ce m√©dicament existe d√©j√† :
- ${ex.name} (${ex.dosage})

Stock actuel :
- Quantit√© actuelle : ${ex.quantity}
- Stock initial : ${ex.initialStock}
- Prix : ${Number(ex.price||0).toFixed(2)} DH
- P√©remption : ${fmtMMAA(ex.expiry)}

Nouvelle saisie :
- +Qt√© : ${quantity}
- +Stock init. : ${initialStock}
- Nouveau prix : ${price.toFixed(2)} DH (remplace l'ancien)
- P√©remption : ${fmtMMAA(expiryISO)}

‚úÖ Voulez-vous ACTUALISER (cumuler les stocks) ?`;

  if(!confirm(msg)) return;

  ex.quantity = (Number(ex.quantity)||0) + quantity;
  ex.initialStock = (Number(ex.initialStock)||0) + initialStock;
  ex.price = price; // dernier prix remplace
  ex.nbBoxes = nbBoxes;
  ex.genre = genre;
  ex.expiry = earliestExpiry(ex.expiry, expiryISO);
  ex.notes = mergeNotes(ex.notes, notes);

  meds[existingIndex] = ex;
  save();
  e.target.reset();
  show('inventory');
  renderAll();
  updateStats();
});

/* =========================
   EDITION (MM/AA)
========================= */
function openEdit(idx){
  const m = meds[idx];
  if(!m) return;

  document.getElementById('edit-index').value = idx;
  document.getElementById('edit-name').value = m.name || '';
  document.getElementById('edit-dosage').value = m.dosage || '';
  document.getElementById('edit-genre').value = m.genre || '';
  document.getElementById('edit-quantity').value = Number(m.quantity) || 0;
  document.getElementById('edit-initial').value = Number(m.initialStock) || 0;
  document.getElementById('edit-price').value = Number(m.price) || 0;
  document.getElementById('edit-nb-boxes').value = Number(m.nbBoxes) || 1;
  document.getElementById('edit-expiry-mmaa').value = fmtMMAA(m.expiry);
  document.getElementById('edit-notes').value = m.notes || '';

  document.getElementById('edit-modal').style.display = 'flex';
}
function closeEdit(){ document.getElementById('edit-modal').style.display = 'none'; }
document.getElementById('edit-cancel').addEventListener('click', closeEdit);

document.getElementById('edit-form').addEventListener('submit', function(e){
  e.preventDefault();

  const idx = parseInt(document.getElementById('edit-index').value, 10);
  if(Number.isNaN(idx) || !meds[idx]) return;

  const name = normalizeName(document.getElementById('edit-name').value);
  const dosage = normalizeName(document.getElementById('edit-dosage').value);
  const genre = document.getElementById('edit-genre').value;

  const initialStock = parseInt(document.getElementById('edit-initial').value, 10) || 0;
  const quantity = parseInt(document.getElementById('edit-quantity').value, 10) || 0;

  const priceVal = parseFloat(document.getElementById('edit-price').value);
  const price = Number.isFinite(priceVal) ? priceVal : 0;

  const nbBoxes = parseInt(document.getElementById('edit-nb-boxes').value, 10) || 1;

  const expiryMMAA = document.getElementById('edit-expiry-mmaa').value;
  const expiryISO = parseMMAAtoISO(expiryMMAA);
  if(!expiryISO){
    alert("‚ùå Date invalide. Utilise MM/AA (ex : 02/26).");
    return;
  }

  const notes = document.getElementById('edit-notes').value.trim();

  // si modifie vers un existant => proposer fusion
  const newKey = keyOf(name, dosage);
  const otherIndex = meds.findIndex((m, i) => i !== idx && keyOf(m.name, m.dosage) === newKey);

  if(otherIndex !== -1){
    const target = meds[otherIndex];
    const msg =
`‚ö†Ô∏è Un autre m√©dicament existe d√©j√† avec le m√™me Nom+Dosage :
- ${target.name} (${target.dosage})

Voulez-vous FUSIONNER (cumuler) ce m√©dicament modifi√© avec l'existant ?`;

    if(confirm(msg)){
      target.quantity = (Number(target.quantity)||0) + quantity;
      target.initialStock = (Number(target.initialStock)||0) + initialStock;
      target.price = price; // dernier prix remplace
      target.nbBoxes = nbBoxes;
      target.genre = genre;
      target.expiry = earliestExpiry(target.expiry, expiryISO);
      target.notes = mergeNotes(target.notes, notes);

      meds[otherIndex] = target;
      meds.splice(idx, 1);

      save();
      closeEdit();
      renderAll();
      updateStats();
      return;
    }
  }

  meds[idx] = { name, dosage, genre, quantity, initialStock, price, nbBoxes, expiry: expiryISO, notes };
  save();
  closeEdit();
  renderAll();
  updateStats();
});

/* =========================
   SUPPRESSION / UTILISATION
========================= */
function removeMed(idx){
  const m = meds[idx];
  if(!m) return;
  if(confirm(`Supprimer "${m.name} (${m.dosage})" ?`)){
    meds.splice(idx, 1);
    save();
    renderAll();
    updateStats();
  }
}

function useMed(idx){
  const m = meds[idx];
  if(!m) return;

  const qty = parseInt(document.getElementById('use-qty').value, 10) || 1;
  if(qty <= 0){ alert("‚ùå Quantit√© invalide."); return; }

  if(Number(m.quantity) >= qty){
    m.quantity = Number(m.quantity) - qty;
    save();
    renderAll();
    updateStats();

    if(m.quantity === 0){
      alert(`‚ÑπÔ∏è Derni√®re unit√© de ${m.name} utilis√©e ‚Äì stock √©puis√©.`);
    } else if(m.quantity <= 5){
      alert(`‚ö†Ô∏è Stock faible : il ne reste plus que ${m.quantity} unit√©(s) de ${m.name}.`);
    }
  } else {
    alert(`‚ùå Stock insuffisant ! ${m.name} poss√®de seulement ${m.quantity} unit√©(s).`);
  }
}

/* =========================
   √Ä ACHETER (Liste de courses)
========================= */
function renderToBuy(){
  const tbody = document.querySelector('#tobuy-table tbody');
  if(!tbody) return;
  
  tbody.innerHTML = '';
  
  if(toBuyList.length === 0){
    tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">Aucun m√©dicament dans la liste</td></tr>';
    return;
  }
  
  toBuyList.forEach((item, idx)=>{
    tbody.innerHTML += `
      <tr>
        <td style="color:#1976d2;font-weight:bold;">${escapeHtml(item.name)}</td>
        <td style="color:#d32f2f;font-weight:bold;font-size:1.1em;">${item.qty}</td>
        <td>${escapeHtml(item.notes || '-')}</td>
        <td><button class="action-btn delete" onclick="removeToBuy(${idx})">üóëÔ∏è</button></td>
      </tr>
    `;
  });
}

function removeToBuy(idx){
  if(confirm('Supprimer ce m√©dicament de la liste ?')){
    toBuyList.splice(idx, 1);
    localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
    renderToBuy();
  }
}

document.getElementById('tobuy-form').addEventListener('submit', function(e){
  e.preventDefault();
  
  const name = normalizeName(document.getElementById('tobuy-name').value);
  const qty = parseInt(document.getElementById('tobuy-qty').value, 10) || 1;
  const notes = document.getElementById('tobuy-notes').value.trim();
  
  if(!name) return;
  
  toBuyList.push({ name, qty, notes });
  localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
  
  e.target.reset();
  document.getElementById('tobuy-qty').value = 1;
  renderToBuy();
});

/* =========================
   SAUVEGARDE / RESTAURATION / VIDAGE
========================= */
function downloadJSON(filename, dataObj){
  const json = JSON.stringify(dataObj, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function saveBackup(){
  if(!auth) return;
  const payload = {
    app: "pharmacie_domicile",
    version: 1,
    exportedAt: new Date().toISOString(),
    medicines: meds
  };
  downloadJSON("pharmacie-stock.json", payload);
  alert("‚úÖ Sauvegarde t√©l√©charg√©e : pharmacie-stock.json");
}

function restoreBackupFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);

      // accepter 2 formats:
      // - { medicines: [...] }
      // - [...] (liste directe)
      const list = Array.isArray(obj) ? obj : (obj && Array.isArray(obj.medicines) ? obj.medicines : null);
      if(!list) throw new Error("Format invalide");

      // validation minimale
      const cleaned = list.map(x => ({
        name: normalizeName(x.name),
        dosage: normalizeName(x.dosage),
        genre: x.genre || '',
        quantity: Number(x.quantity)||0,
        initialStock: Number(x.initialStock)||0,
        price: Number(x.price)||0,
        nbBoxes: Number(x.nbBoxes)||1,
        expiry: x.expiry,
        notes: (x.notes||"").toString()
      }));

      meds = cleaned;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
      localStorage.setItem(SEEDED_KEY, "1");

      renderAll();
      updateStats();
      alert("‚úÖ Restauration termin√©e !");
    }catch(err){
      alert("‚ùå Impossible de restaurer : fichier JSON invalide.");
    }
  };
  reader.readAsText(file);
}

function restoreBackup(){
  if(!auth) return;
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json,.json";
  input.onchange = () => {
    if(input.files && input.files[0]){
      const ok = confirm("‚ö†Ô∏è Restaurer va remplacer ton stock actuel. Continuer ?");
      if(!ok) return;
      restoreBackupFromFile(input.files[0]);
    }
  };
  input.click();
}

function clearAllStock(){
  if(!auth) return;
  const ok = confirm("üßπ Voulez-vous VRAIMENT vider tout le stock ? Cette action est irr√©versible.");
  if(!ok) return;

  meds = [];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
  localStorage.setItem(SEEDED_KEY, "1");

  renderAll();
  updateStats();
  alert("‚úÖ Stock vid√©.");
}

/* =========================
   √âV√âNEMENTS UI
========================= */
document.getElementById('pwd-btn').addEventListener('click', checkPwd);
document.getElementById('logout-link').addEventListener('click', (e)=>{ e.preventDefault(); logout(); });

document.querySelectorAll('nav a[data-target]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    show(a.getAttribute('data-target'));
  });
});

// actions backup
document.getElementById('btn-save').addEventListener('click', (e)=>{ e.preventDefault(); saveBackup(); });
document.getElementById('btn-restore').addEventListener('click', (e)=>{ e.preventDefault(); restoreBackup(); });
document.getElementById('btn-clear').addEventListener('click', (e)=>{ e.preventDefault(); clearAllStock(); });

// recherches live
['search','search-edit','search-delete','search-use'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', renderAll);
});

// auto-format MM/AA
function attachMMAAFormatter(inputId){
  const el = document.getElementById(inputId);
  if(!el) return;
  el.addEventListener('input', ()=>{
    let v = el.value.replaceAll("/","").replace(/\D/g,'').slice(0,4);
    if(v.length >= 3) v = v.slice(0,2) + "/" + v.slice(2);
    el.value = v;
  });
}
attachMMAAFormatter('expiry-mmaa');
attachMMAAFormatter('edit-expiry-mmaa');

// clavier : Enter login, Escape edit
document.addEventListener('keydown', e=>{
  if(e.key === "Enter" && document.getElementById('pwd-modal').style.display !== 'none'){
    checkPwd();
  }
  if(e.key === "Escape" && document.getElementById('edit-modal').style.display === 'flex'){
    closeEdit();
  }
});

/* =========================
   CLOUD SYNC (JSONBin.io)
========================= */
const CLOUD_KEY = 'pharmacie_cloud_id';
const CLOUD_URL = 'https://api.jsonbin.io/v3/b/';
const CLOUD_API_KEY = '$2a$10$8gG6qLSqVPLpp8HFdKk5zeoa3K5Z9Q5';

let cloudId = localStorage.getItem(CLOUD_KEY);

function showCloudModal(){
  document.getElementById('cloud-modal').style.display = 'flex';
  document.getElementById('cloud-id').value = cloudId || '';
  document.getElementById('cloud-status').textContent = cloudId ? 'Connecte: ' + cloudId : 'Pas de cloud configure';
}

function hideCloudModal(){
  document.getElementById('cloud-modal').style.display = 'none';
}

async function connectCloud(){
  let id = document.getElementById('cloud-id').value.trim();
  if(!id){
    document.getElementById('cloud-status').textContent = 'Entrez un ID!';
    return;
  }
  document.getElementById('cloud-status').textContent = 'Connexion...';
  cloudId = id;
  localStorage.setItem(CLOUD_KEY, id);
  await syncToCloud();
  document.getElementById('cloud-status').textContent = 'Connecte: ' + id;
  alert('Connecte avec succes! Utilisez le meme ID sur vos autres appareils.');
  hideCloudModal();
}

async function syncToCloud(){
  if(!cloudId) return;
  let data = { meds: meds, toBuyList: toBuyList, timestamp: Date.now() };
  console.log('Sync: Debut, cloudId=' + cloudId);
  try{
    showCloudStatus('Synchronisation...');
    let res = await fetch(CLOUD_URL + cloudId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_API_KEY },
      body: JSON.stringify(data)
    });
    console.log('Sync PUT: status=' + res.status);
    let text = await res.text();
    console.log('Sync PUT: response=' + text);
    if(res.ok || res.status === 200 || res.status === 201){
      console.log('Sync: OK');
      showCloudStatus('Sauvegarde OK!');
    }else if(res.status === 404 || res.status === 400){
      showCloudStatus('Creation du cloud...');
      let createRes = await fetch('https://api.jsonbin.io/v3/b', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_API_KEY },
        body: JSON.stringify(data)
      });
      let createText = await createRes.text();
      console.log('Sync POST: status=' + createRes.status + ', response=' + createText);
      if(createRes.ok){
        try{
          let created = JSON.parse(createText);
          cloudId = created.metadata.id;
          localStorage.setItem(CLOUD_KEY, cloudId);
          showCloudStatus('Cloud cree: ' + cloudId);
        }catch(e){
          showCloudStatus('Erreur creation: ' + e);
        }
      }else{
        showCloudStatus('Erreur POST: ' + createRes.status);
      }
    }else{
      showCloudStatus('Erreur sync: ' + res.status);
    }
  }catch(e){
    console.log('Sync: Erreur', e);
    showCloudStatus('Erreur: ' + e.message);
  }
}

function showCloudStatus(msg){
  let el = document.getElementById('cloud-status');
  if(el) el.textContent = msg;
}

async function syncFromCloud(){
  if(!cloudId) return;
  try{
    showCloudStatus('Rapatriement...');
    let res = await fetch(CLOUD_URL + cloudId + '/latest', {
      headers: { 'X-Master-Key': CLOUD_API_KEY }
    });
    if(res.ok){
      let data = await res.json();
      if(data.record && data.record.meds){
        meds = data.record.meds;
        toBuyList = data.record.toBuyList || [];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
        localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
        renderMeds();
        renderToBuy();
        updateStats();
        showCloudStatus('Donnees recues!');
      }else{
        showCloudStatus('Pas de donnees cloud');
      }
    }else if(res.status === 404){
      showCloudStatus('Cloud pas encore cree');
    }else{
      showCloudStatus('Erreur: ' + res.status);
    }
  }catch(e){
    console.log('Sync from cloud: Erreur', e);
    showCloudStatus('Erreur de connexion');
  }
}

// Auto-sync toutes les 30 secondes
setInterval(() => {
  if(cloudId) syncToCloud();
}, 30000);

// Event listeners pour Cloud
document.getElementById('btn-cloud').onclick = showCloudModal;
document.getElementById('cloud-btn').onclick = connectCloud;
document.getElementById('cloud-id').onkeyup = e => { if(e.key === 'Enter') connectCloud(); };

function syncNow(){
  if(!cloudId){
    showCloudStatus('Pas de Cloud ID!');
    return;
  }
  showCloudStatus('Synchronisation...');
  syncToCloud();
  setTimeout(() => {
    syncFromCloud();
    showCloudStatus('Termine!');
    alert('Synchronisation terminee!');
  }, 1000);
}

// Si deja connecte, sync au demarrage
if(cloudId){
  syncFromCloud();
}

/* =========================
   INITIALISATION
========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  renderToBuy();
});
</script>

  <!-- Cloud Sync Modal -->
  <div id="cloud-modal" class="password-modal" style="display:none;">
    <div class="password-content">
      <h2 style="margin-bottom:1rem;">‚òÅÔ∏è Synchronisation Cloud</h2>
      <p style="margin-bottom:1rem;color:#666;">Entrez un ID unique pour synchroniser entre PC et telephone</p>
      <input type="text" id="cloud-id" placeholder="ID unique (ex: pharmacie1)" style="margin-bottom:1rem;">
      <div style="display:flex;gap:.5rem;margin-bottom:1rem;">
        <button id="cloud-btn" style="background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;flex:1;">Connecter / Sync</button>
        <button onclick="syncNow()" style="background:var(--accent);color:#fff;border:none;padding:.75rem 1rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;">Sync maintenant</button>
      </div>
      <p id="cloud-status" style="padding:.5rem;background:#f0f0f0;border-radius:var(--radius);margin-bottom:1rem;"></p>
      <button onclick="hideCloudModal()" style="background:#ddd;color:#333;border:none;padding:.5rem 1rem;border-radius:var(--radius);cursor:pointer;">Fermer</button>
    </div>
  </div>

</body>
</html>
