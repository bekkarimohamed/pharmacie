<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion de la Pharmacie √† Domicile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --primary-color: #667eea;
      --accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-color: #f093fb;
      --text: #2c3e50;
      --text-light: #ecf0f1;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #3498db;
      --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
      --radius: 15px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --title-color: #00695c;
      --list-header: #00796b;
      --list-row: rgba(255, 255, 255, 0.98);
      --list-row-alt: rgba(255, 255, 255, 0.98);
      --list-border: rgba(0, 121, 107, 0.22);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="60" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
      animation: float 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(180deg); }
    }

    nav{
      background: var(--primary);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow-light);
    }

    nav ul{
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      list-style: none;
      align-items: center;
      justify-content: center;
    }

    /* Dark mode toggle button */
    .theme-toggle-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      margin-left: auto;
    }

    .theme-toggle-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    .theme-toggle-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
      transition: var(--transition);
    }

    body.dark-mode .theme-toggle-btn svg {
      transform: rotate(180deg);
    }

    /* Dark mode toggle */
    .theme-toggle {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* Dark mode styles */
    body.dark-mode {
      --background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      --card-bg: rgba(22, 33, 62, 0.95);
      --text: #ecf0f1;
      --text-light: #2c3e50;
      --list-header: #00796b;
      --list-row: rgba(22, 33, 62, 0.85);
      --list-row-alt: rgba(22, 33, 62, 0.85);
      --list-border: rgba(0, 121, 107, 0.28);
      --title-color: #00695c;
    }

    h1, h2, h3, h4{
      color: var(--title-color);
    }

    body.dark-mode .stat-card,
    body.dark-mode .form,
    body.dark-mode .table,
    body.dark-mode .hero,
    body.dark-mode .cta-section {
      background: var(--card-bg);
      color: var(--text);
    }

    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background: rgba(255,255,255,0.1);
      color: var(--text);
      border-color: rgba(255,255,255,0.2);
    }

    body.dark-mode input:focus,
    body.dark-mode textarea:focus,
    body.dark-mode select:focus {
      background: rgba(255,255,255,0.15);
    }

    /* Dark mode toggle */
    .theme-toggle {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* Dark mode styles */
    body.dark-mode {
      --background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      --card-bg: rgba(22, 33, 62, 0.95);
      --text: #ecf0f1;
      --text-light: #2c3e50;
      --list-header: linear-gradient(135deg, #00796b 0%, #00838f 100%);
      --list-row: rgba(22, 33, 62, 0.85);
      --list-row-alt: rgba(0, 150, 136, 0.16);
      --list-border: rgba(0, 150, 136, 0.28);
    }

    body.dark-mode .stat-card,
    body.dark-mode .form,
    body.dark-mode .table,
    body.dark-mode .hero,
    body.dark-mode .cta-section {
      background: var(--card-bg);
      color: var(--text);
    }

    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background: rgba(255,255,255,0.1);
      color: var(--text);
      border-color: rgba(255,255,255,0.2);
    }

    body.dark-mode input:focus,
    body.dark-mode textarea:focus,
    body.dark-mode select:focus {
      background: rgba(255,255,255,0.15);
    }

    nav a{
      color: var(--text-light);
      text-decoration: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    /* SVG Icons */
    .nav-icon { width: 18px; height: 18px; fill: currentColor; }

    nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    nav a:hover::before {
      left: 100%;
    }

    nav a:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .container{
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    section{
      display: none;
      animation: slideIn 0.4s ease-out;
    }

    section.active{display: block}

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 4px;
      overflow: hidden;
      box-shadow: var(--shadow);
      animation: tableSlideIn 0.5s ease-out;
    }

    @keyframes tableSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    th, td{
      padding: 1rem;
      border-bottom: 1px solid var(--list-border);
      text-align: left;
      vertical-align: top;
    }

    th{
      background: var(--list-header);
      color: white;
      font-weight: 700;
      position: relative;
      letter-spacing: 0.3px;
    }

    th::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    }

    tbody tr{
      background: var(--list-row);
    }
    tr:hover{
      background: rgba(0, 150, 136, 0.12);
      transform: scale(1.01);
      transition: var(--transition);
    }

    .expired{color: var(--danger) !important; font-weight: bold; animation: pulse 2s infinite;}
    .expiring-soon{color: var(--warning) !important; font-weight: bold; animation: pulse 2s infinite;}
    .valid{color: var(--success) !important;}
    .stock-zero{color: var(--danger) !important; font-weight: bold; background: rgba(231, 76, 60, 0.1); animation: shake 0.5s;}

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }

    .action-btn{
      background: none;
      border: none;
      cursor: pointer;
      margin: 0 0.25rem;
      font-size: 1.1rem;
      padding: 0.5rem;
      border-radius: var(--radius);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    .action-btn:hover::before {
      width: 100%;
      height: 100%;
    }

    .action-btn:hover{transform: scale(1.1) rotate(5deg);}
    .edit{color: var(--success);}
    .delete{color: var(--danger);}
    .use{color: var(--warning);}

    form{
      max-width: 520px;
      margin-top: 1rem;
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      animation: formSlideIn 0.5s ease-out;
    }

    @keyframes formSlideIn {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .form-group{margin-bottom: 1.5rem}
    label{
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, textarea, select{
      width: 100%;
      padding: 1rem;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: var(--transition);
      background: rgba(255,255,255,0.8);
    }

    input:focus, textarea:focus, select:focus{
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.2);
      transform: translateY(-2px);
    }

    textarea{resize: vertical; min-height: 100px;}

    button[type=submit]{
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      width: 100%;
    }

    button[type=submit]::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    button[type=submit]:hover::before {
      left: 100%;
    }

    button[type=submit]:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    #search, #search-edit, #search-delete, #search-use{
      width: 100%;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: var(--radius);
      font-size: 1rem;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }

    #search:focus, #search-edit:focus, #search-delete:focus, #search-use:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.2);
    }

    .notes-cell{max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}

    /* Debug sync */
    #debug-sync{
      background: rgba(26, 26, 46, 0.9);
      color: #00ff00;
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      max-height: 120px;
      overflow-y: auto;
      border-bottom: 2px solid #00ff00;
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
    }

    #debug-sync .log-entry{margin: 2px 0; animation: logEntry 0.3s ease-out;}
    @keyframes logEntry {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    #debug-sync .log-success{color: #00ff00;}
    #debug-sync .log-error{color: #ff5555;}
    #debug-sync .log-info{color: #ffff00;}

    .notes-cell:hover{white-space: normal; overflow: visible;}

    .stats-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .stat-card{
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      animation: cardBounce 0.6s ease-out;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--accent);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    @keyframes cardBounce {
      0% { opacity: 0; transform: scale(0.8) translateY(20px); }
      50% { transform: scale(1.05) translateY(-5px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    .stat-number{
      font-size: 3rem;
      font-weight: bold;
      margin: 0.5rem 0;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: numberCount 1s ease-out;
    }

    @keyframes numberCount {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }

    .password-modal{
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .password-content{
      background: var(--card-bg);
      padding: 3rem;
      border-radius: var(--radius);
      text-align: center;
      width: 90%;
      max-width: 450px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      animation: modalSlideIn 0.4s ease-out;
    }

    .details-modal{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      z-index: 9000;
      padding: 1rem;
    }
    .details-content{
      background: var(--card-bg);
      color: var(--text);
      width: 100%;
      max-width: 520px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }
    .details-content h3{
      margin-bottom: 0.75rem;
      font-size: 1.2rem;
    }
    .details-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem 1rem;
      font-size: 0.95rem;
    }
    .details-grid .label{
      color: var(--primary-color);
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .details-grid .value{
      color: var(--text);
      word-break: break-word;
    }
    .details-actions{
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .details-close{
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.8) translateY(-20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .empty-msg{
      text-align: center;
      padding: 3rem;
      color: #666;
      font-style: italic;
      animation: fadeIn 0.5s ease-out;
    }

    .nav-btn{
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }

    .nav-btn:hover{
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }

    /* SVG Icons */
    .icon { width: 20px; height: 20px; fill: currentColor; }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      /* Navigation mobile - menu compact en grille */
      nav{padding:.3rem}
      nav ul{
        display:grid;
        grid-template-columns:repeat(4, 1fr);
        gap:.3rem;
        align-items:center
      }
      nav a{
        padding:.35rem .4rem;
        font-size:.68rem;
        text-align:center;
        flex-direction:column;
        gap:.2rem;
        line-height:1.1
      }

      /* Container - plus compact */
      .container{padding:.5rem}

      /* Titres r√©duits */
      h1{font-size:1rem}
      h2{font-size:.95rem}
      h3{font-size:.9rem}

      /* Stats grid - compact */
      .stats-grid{
        grid-template-columns:repeat(2,1fr);
        gap:.4rem;
        margin:.5rem 0
      }
      .stat-card{
        padding:.5rem
      }
      .stat-number{font-size:1.1rem}

      /* Forms - compact */
      form{
        padding:.5rem;
        margin-top:.3rem
      }
      .form-group{margin-bottom:.5rem}
      label{font-size:.9rem;margin-bottom:.3rem}

      /* Inputs plus compacts */
      input,textarea,select{
        padding:.4rem;
        font-size:.85rem
      }

      /* Buttons */
      button[type=submit]{
        padding:.4rem .75rem;
        font-size:.85rem
      }

      /* Search + value row */
      #inventory>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }
      #inventory>div[style*="display:flex"]>div{
        justify-content:center
      }

      /* Use mode quantity */
      #use-mode>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }

      /* Tables responsive avec scroll horizontal */
      table{
        font-size:.75rem;
        display:block;
        overflow-x:auto;
        white-space:nowrap;
        -webkit-overflow-scrolling: touch;
        max-width: 100vw;
        margin: 0 -0.5rem;
      }
      th,td{
        padding:.3rem .25rem;
        min-width:50px
      }
      .notes-cell{max-width:60px}

      /* Modal edit */
      #edit-modal{padding:.2rem}
      #edit-modal>div{
        padding:.5rem;
        max-width:98vw
      }

      /* Modal password */
      .password-content{
        padding:.75rem;
        max-width:90vw
      }

      /* Buttons row in modal */
      #edit-modal>div>form>div[style*="display:flex"]{
        flex-direction:column;
        gap:.3rem
      }

      /* Liste d'attention - responsive */
      .attention-list-item {
        font-size: 0.85rem;
        padding: 0.75rem;
      }

      /* Debug sync - plus compact */
      #debug-sync {
        font-size: 0.7rem;
        padding: 0.5rem;
      }
    }

    @media (max-width: 480px) {
      /* Navigation mobile - afficher tous les libell√©s */
      nav ul{
        grid-template-columns:repeat(4, 1fr);
        gap:.25rem
      }
      nav a{
        padding:.3rem .25rem;
        font-size:.62rem;
        flex-direction:column;
        gap:.1rem;
        line-height:1.1;
        text-align:center
      }
      .nav-icon{
        width:16px;
        height:16px
      }
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      
      /* Toujours visible */
      #logout-link{
        display:block !important
      }

      /* Colonnes visibles sur mobile */
      #med-table th:nth-child(1),
      #med-table td:nth-child(1){
        min-width:90px
      }
      #med-table th:nth-child(2),
      #med-table td:nth-child(2){
        min-width:60px
      }
      #med-table th:nth-child(3),
      #med-table td:nth-child(3){
        min-width:60px
      }
      #med-table th:nth-child(4),
      #med-table td:nth-child(4){
        min-width:45px
      }
      #med-table th:nth-child(5),
      #med-table td:nth-child(5){
        min-width:65px
      }
      #med-table th:nth-child(6),
      #med-table td:nth-child(6){
        min-width:60px
      }
      #med-table th:nth-child(7),
      #med-table td:nth-child(7){
        min-width:70px
      }

      /* Liste attention - tr√®s compact */
      .attention-list-item {
        font-size: 0.8rem;
        padding: 0.5rem;
        margin: 0.25rem 0;
      }

      /* Table "√Ä acheter" - responsive */
      #tobuy-table {
        font-size: 0.7rem;
      }
      #tobuy-table th, #tobuy-table td {
        padding: 0.25rem 0.15rem;
      }
    }
  </style>
</head>

<body>

  <!-- Modal de connexion -->
  <div id="pwd-modal" class="password-modal">
    <div class="password-content">
      <h2>üîê Acc√®s s√©curis√©</h2>
      <p style="margin-top:.5rem;">Entrez le mot de passe pour acc√©der √† l'application</p>

      <input type="password" id="pwd-input" placeholder="Mot de passe"
             style="width:100%;padding:.75rem;margin:1rem 0;border:1px solid #ddd;border-radius:var(--radius);font-size:1.1rem;" />

      <button id="pwd-btn"
              style="background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;font-weight:600;">
        Acc√©der
      </button>

      <p id="pwd-error" style="color:#d32f2f;margin-top:1rem;display:none;">Mot de passe incorrect</p>
      <p style="margin-top:1rem;font-size:.9rem;color:#666;">Astuce : Entr√©e = valider</p>
    </div>
  </div>

  <!-- Modal d√©tails m√©dicament -->
  <div id="details-modal" class="details-modal">
    <div class="details-content">
      <h3 id="details-title">D√©tails</h3>
      <div class="details-grid">
        <div class="label">Nom</div><div class="value" id="details-name">-</div>
        <div class="label">Dosage</div><div class="value" id="details-dosage">-</div>
        <div class="label">Genre</div><div class="value" id="details-genre">-</div>
        <div class="label">Quantit√©</div><div class="value" id="details-quantity">-</div>
        <div class="label">Date d'achat</div><div class="value" id="details-purchase">-</div>
        <div class="label">Stock initial</div><div class="value" id="details-initial">-</div>
        <div class="label">Prix</div><div class="value" id="details-price">-</div>
        <div class="label">Bo√Ætes</div><div class="value" id="details-boxes">-</div>
        <div class="label">P√©remption</div><div class="value" id="details-expiry">-</div>
        <div class="label">Notes</div><div class="value" id="details-notes">-</div>
      </div>
      <div class="details-actions">
        <button class="details-close" id="details-close-btn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <nav id="main-nav" style="display:none;">
    <ul>
      <li><a href="#" data-target="home"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg> Accueil</a></li>
      <li><a href="#" data-target="inventory"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 7h-4V4c0-1.1-.9-2-2-2H10c-1.1 0-2 .9-2 2v3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zM10 4h4v3h-4V4z"/></svg> Stock actuel</a></li>
      <li><a href="#" data-target="add"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Saisie</a></li>
      <li><a href="#" data-target="edit-mode"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Modifier</a></li>
      <li><a href="#" data-target="delete-mode"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Supprimer</a></li>
      <li><a href="#" data-target="use-mode"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Utiliser</a></li>
      <li><a href="#" data-target="to-buy"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4V2C7 1.45 7.45 1 8 1s1 .45 1 1v2h6V2c0-.55.45-1 1-1s1 .45 1 1v2h5c.55 0 1 .45 1 1s-.45 1-1 1h-1v13c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V6H2c-.55 0-1-.45-1-1s.45-1 1-1h5zm2 0V3c0-.55.45-1 1-1s1 .45 1 1v1h4V3c0-.55.45-1 1-1s1 .45 1 1v1h2v2H5V6h4zm-2 4v9h12V8H7z"/></svg> √Ä acheter</a></li>

      <!-- Theme Toggle Button -->
      <li><button id="theme-toggle" class="theme-toggle-btn" title="Basculer mode sombre/clair">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/>
        </svg>
      </button></li>

      <!-- NOUVEAU : Sauvegarder / Restaurer / Vider / Sync -->
      <li><a href="#" id="btn-save" class="nav-btn"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V7h10v2z"/></svg> Sauvegarder</a></li>
      <li><a href="#" id="btn-restore" class="nav-btn"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg> Restaurer</a></li>
      <li><a href="#" id="btn-clean-dup" class="nav-btn"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/></svg> Nettoyer</a></li>
      <li><a href="#" id="btn-clear" class="nav-btn"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Vider</a></li>
      <li><a href="#" id="btn-reset-all" class="nav-btn"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6V3L8 7l4 4V8c3.31 0 6 2.69 6 6a6 6 0 11-6-6z"/></svg> R√©initialiser</a></li>

      <li><a href="#" id="logout-link"><svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg> Quitter</a></li>
    </ul>
  </nav>

  <!-- Debug Sync Status - cach√© par d√©faut -->
  <!-- <div id="debug-sync" style="display:none;"> -->
  <!--   <div class="log-info">üíª Debug Sync Cloud</div> -->
  <!-- </div> -->

  <div class="container" id="main" style="display:none;">

    <!-- Accueil -->
    <section id="home" class="section active">
      <h1>üè• Gestionnaire de Pharmacie √† Domicile</h1>

      <div class="stats-grid">
        <div class="stat-card"><h3>üìä Stock total</h3><div class="stat-number" id="total-meds">0</div></div>
        <div class="stat-card"><h3>‚ùå Expir√©s</h3><div class="stat-number" id="expired-count">0</div></div>
        <div class="stat-card"><h3>‚ö†Ô∏è Pr√©‚Äëexpiration</h3><div class="stat-number" id="preexp-count">0</div></div>
        <div class="stat-card"><h3>üì¶ Stock nul</h3><div class="stat-number" id="zerostock-count">0</div></div>
      </div>

      <h3>üìã M√©dicaments n√©cessitant une attention</h3>
      <div id="attention-list" style="margin-top:.75rem;"></div>
      
      <!-- Debug sync status -->
      <div style="background:#f0f0f0;padding:1rem;margin-top:1rem;border-radius:8px;font-size:0.9rem;">
        <h4>üîÑ √âtat Sync Cloud</h4>
        <p>üì± Locaux: <strong id="debug-local-count">0</strong></p>
        <p>‚òÅÔ∏è Cloud: <strong id="debug-cloud-count">0</strong></p>
        <p>üîó Statut: <strong id="debug-status">En attente...</strong></p>
        <button onclick="forceDebugSync()" style="margin-top:0.5rem;padding:0.5rem 1rem;background:#2196F3;color:#fff;border:none;border-radius:4px;cursor:pointer;">üîÑ Tester Sync</button>
      </div>
    </section>

    <!-- Stock actuel -->
    <section id="inventory" class="section">
      <h2>üì¶ Stock actuel</h2>

      <div style="display:flex;gap:1rem;margin:1rem 0;align-items:center;flex-wrap:wrap;">
        <input type="text" id="search" placeholder="üîé Rechercher (nom, dosage, notes)‚Ä¶" style="flex:1;">
      </div>

      <table id="med-table">
        <thead>
          <tr>
            <th>Nom</th><th>Genre</th><th>Dosage</th><th>Qt√©</th>
            <th>P√©remption</th><th>Alerte</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ajout -->
    <section id="add" class="section">
      <h2>‚ûï Ajouter un m√©dicament</h2>

      <form id="add-form">
        <div class="form-group"><label>Nom *</label><input type="text" id="name" required></div>
        <div class="form-group"><label>Dosage *</label><input type="text" id="dosage" placeholder="ex : 500mg, 10ml" required></div>
        <div class="form-group"><label>Genre *</label>
          <select id="genre" required style="width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem;">
            <option value="">S√©lectionner...</option>
            <option value="Comprim√©s">Comprim√©s</option>
            <option value="G√©lules">G√©lules</option>
            <option value="Suppositoires">Suppositoires</option>
            <option value="Sachets">Sachets</option>
            <option value="Gel">Gel</option>
            <option value="Flacon">Flacon</option>
            <option value="Sirop">Sirop</option>
            <option value="Solution">Solution</option>
            <option value="Pommade">Pommade</option>
            <option value="Lotion">Lotion</option>
            <option value="Cr√®me">Cr√®me</option>
            <option value="Poudre">Poudre</option>
            <option value="Gouttes">Gouttes</option>
            <option value="Inhalation">Inhalation</option>
            <option value="Patch">Patch</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div class="form-group">
          <label>Date d'achat</label>
          <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
            <input type="date" id="purchase-date" style="flex:1;min-width:160px;" disabled>
            <label style="display:flex;align-items:center;gap:.4rem;font-size:.9rem;">
              <input type="checkbox" id="purchase-date-custom">
              Autre jour
            </label>
          </div>
          <small style="display:block;margin-top:.4rem;color:#666;">Par d√©faut : aujourd'hui. Cochez "Autre jour" pour saisir.</small>
        </div>

        <!-- Stock initial AVANT quantit√© actuelle -->
        <div class="form-group"><label>Stock initial *</label><input type="number" id="initial-stock" min="0" required></div>
        <div class="form-group"><label>Quantit√© actuelle *</label><input type="number" id="quantity" min="0" required></div>

        <div class="form-group"><label>Prix (DH) *</label><input type="number" id="price" min="0" step="0.01" required></div>
        <div class="form-group"><label>Nombre de bo√Ætes *</label><input type="number" id="nb-boxes" min="1" value="1" required></div>

        <div class="form-group">
          <label>Date de p√©remption (MM/AA) *</label>
          <input type="text" id="expiry-mmaa" inputmode="numeric" placeholder="ex : 02/26" maxlength="5" required>
          <small style="display:block;margin-top:.5rem;color:#666;">Format : MM/AA</small>
        </div>

        <div class="form-group"><label>Notes</label><textarea id="notes" placeholder="Optionnel"></textarea></div>

        <button type="submit">üíä Ajouter</button>
      </form>
    </section>

    <!-- Modifier -->
    <section id="edit-mode" class="section">
      <h2>‚úèÔ∏è Modifier</h2>
      <input type="text" id="search-edit" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-edit">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>P√©remption</th><th>Alerte</th><th>Modifier</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Supprimer -->
    <section id="delete-mode" class="section">
      <h2>üóëÔ∏è Supprimer</h2>
      <input type="text" id="search-delete" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-delete">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>P√©remption</th><th>Alerte</th><th>Supprimer</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Utiliser -->
    <section id="use-mode" class="section">
      <h2>üíä Utiliser</h2>

      <div class="form-group" style="max-width:420px;">
        <label for="use-qty">Quantit√© √† utiliser :</label>
        <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
          <input type="number" id="use-qty" min="1" value="1" style="width:120px;">
          <span class="chip">Alerte stock faible ‚â§ 5</span>
        </div>
      </div>

      <input type="text" id="search-use" placeholder="üîé Rechercher‚Ä¶" />

      <table id="med-table-use">
        <thead>
          <tr>
            <th>Nom</th><th>Dosage</th><th>Qt√©</th><th>P√©remption</th><th>Alerte</th><th>Utiliser</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- √Ä acheter -->
    <section id="to-buy" class="section">
      <h2>üõí M√©dicaments √† acheter</h2>
      <button id="tobuy-toggle" class="nav-btn" style="margin:.5rem 0;">‚ûï Ajouter</button>

      <form id="tobuy-form" style="max-width:420px;display:none;">
        <div class="form-group"><label>Nom du m√©dicament *</label><input type="text" id="tobuy-name" required></div>
        <div class="form-group"><label>Quantit√© *</label><input type="number" id="tobuy-qty" min="1" value="1" required></div>
        <div class="form-group"><label>Genre / Notes</label><input type="text" id="tobuy-notes" placeholder="ex : comprim√©, sirop, cr√®me..."></div>
        <button type="submit">‚ûï Ajouter √† la liste</button>
      </form>

      <table id="tobuy-table" style="margin-top:1.5rem;">
        <thead>
          <tr>
            <th>Nom</th><th>Quantit√©</th><th>Genre</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </div>

  <!-- Modal d'√©dition -->
  <div id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000;overflow-y:auto;padding:1rem;">
    <div style="background:#fff;padding:2rem;border-radius:8px;width:100%;max-width:540px;box-shadow:0 4px 20px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto;">
      <h3 style="margin-bottom:1.2rem;">‚úèÔ∏è Modifier le m√©dicament</h3>

      <form id="edit-form">
        <input type="hidden" id="edit-index">

        <div class="form-group"><label>Nom *</label><input type="text" id="edit-name" required></div>
        <div class="form-group"><label>Dosage *</label><input type="text" id="edit-dosage" required></div>
        <div class="form-group"><label>Genre *</label>
          <select id="edit-genre" required style="width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem;">
            <option value="">S√©lectionner...</option>
            <option value="Comprim√©s">Comprim√©s</option>
            <option value="G√©lules">G√©lules</option>
            <option value="Suppositoires">Suppositoires</option>
            <option value="Sachets">Sachets</option>
            <option value="Gel">Gel</option>
            <option value="Flacon">Flacon</option>
            <option value="Sirop">Sirop</option>
            <option value="Solution">Solution</option>
            <option value="Pommade">Pommade</option>
            <option value="Lotion">Lotion</option>
            <option value="Cr√®me">Cr√®me</option>
            <option value="Poudre">Poudre</option>
            <option value="Gouttes">Gouttes</option>
            <option value="Inhalation">Inhalation</option>
            <option value="Patch">Patch</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div class="form-group"><label>Date d'achat</label>
          <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
            <input type="date" id="edit-purchase-date" style="flex:1;min-width:160px;" disabled>
            <label style="display:flex;align-items:center;gap:.4rem;font-size:.9rem;">
              <input type="checkbox" id="edit-purchase-date-custom">
              Autre jour
            </label>
          </div>
          <small style="display:block;margin-top:.4rem;color:#666;">Par d√©faut : aujourd'hui. Cochez "Autre jour" pour saisir.</small>
        </div>

        <div class="form-group"><label>Stock initial *</label><input type="number" id="edit-initial" min="0" required></div>
        <div class="form-group"><label>Quantit√© actuelle *</label><input type="number" id="edit-quantity" min="0" required></div>

        <div class="form-group"><label>Prix (DH) *</label><input type="number" id="edit-price" min="0" step="0.01" required></div>
        <div class="form-group"><label>Nombre de bo√Ætes *</label><input type="number" id="edit-nb-boxes" min="1" value="1" required></div>

        <div class="form-group">
          <label>P√©remption (MM/AA) *</label>
          <input type="text" id="edit-expiry-mmaa" inputmode="numeric" maxlength="5" placeholder="ex : 02/26" required>
        </div>

        <div class="form-group"><label>Notes</label><textarea id="edit-notes"></textarea></div>

        <div style="display:flex;gap:1rem;flex-wrap:wrap;">
          <button type="submit" style="flex:1;">üíæ Enregistrer</button>
          <button type="button" id="edit-cancel" style="flex:1;background:#6c757d;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;font-weight:600;">‚ùå Annuler</button>
        </div>
      </form>

      <p style="margin-top:1rem;font-size:.9rem;color:#666;">Astuce : √âchap = fermer</p>
    </div>
  </div>

<script>
/* =========================
   CONFIG / STOCKAGE
========================= */
const PASSWORD = "mohamed1964";
const STORAGE_KEY = "medicines";
const TOBUY_KEY = "medicines_to_buy";
const PENDING_DELETE_KEY = "medicines_pending_delete";
const PENDING_TOBUY_DELETE_KEY = "tobuy_pending_delete";

// (optionnel) cl√© si tu veux g√©rer des exemples une seule fois
const SEEDED_KEY = "medicines_seeded_once";

let auth = false;
let meds = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let toBuyList = JSON.parse(localStorage.getItem(TOBUY_KEY)) || [];

// Ajouter timestamps aux donn√©es existantes si manquant
meds.forEach(m => {
  if(!m.created_at) m.created_at = new Date().toISOString();
  if(!m.updated_at) m.updated_at = new Date().toISOString();
});
toBuyList.forEach(t => {
  if(!t.created_at) t.created_at = new Date().toISOString();
  if(!t.updated_at) t.updated_at = new Date().toISOString();
});

/* =========================
   UTILITAIRES
========================= */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}

function getTodayISODate(){
  return new Date().toISOString().slice(0,10);
}

function openDetails(idx){
  const m = meds[idx];
  if(!m) return;

  const setText = (id, val) => {
    const el = document.getElementById(id);
    if(el) el.textContent = val;
  };

  setText('details-title', `D√©tails: ${m.name || ''}`);
  setText('details-name', m.name || '-');
  setText('details-dosage', m.dosage || '-');
  setText('details-genre', m.genre || '-');
  setText('details-quantity', String(Number(m.quantity) || 0));
  setText('details-purchase', m.purchaseDate || '-');
  setText('details-initial', String(Number(m.initialStock) || 0));
  setText('details-price', (Number(m.price) || 0).toFixed(2) + ' DH');
  setText('details-boxes', String(Number(m.nbBoxes) || 1));
  setText('details-expiry', fmtMMAA(m.expiry));
  setText('details-notes', (m.notes || '-'));

  const modal = document.getElementById('details-modal');
  if(modal) modal.style.display = 'flex';
}

function closeDetails(){
  const modal = document.getElementById('details-modal');
  if(modal) modal.style.display = 'none';
}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(meds)); }
function isOnline(){ return navigator.onLine !== false; }
function getPendingDeleteMap(){
  try {
    return JSON.parse(localStorage.getItem(PENDING_DELETE_KEY)) || {};
  } catch(e) {
    return {};
  }
}
function setPendingDeleteMap(map){
  localStorage.setItem(PENDING_DELETE_KEY, JSON.stringify(map || {}));
}
function markPendingDelete(key){
  const map = getPendingDeleteMap();
  map[key] = Date.now();
  setPendingDeleteMap(map);
}
function clearPendingDelete(key){
  const map = getPendingDeleteMap();
  if(map[key]){
    delete map[key];
    setPendingDeleteMap(map);
  }
}
function cleanupPendingDeletes(cloudKeys){
  const map = getPendingDeleteMap();
  let changed = false;
  Object.keys(map).forEach(k => {
    if(!cloudKeys[k]){
      delete map[k];
      changed = true;
    }
  });
  if(changed) setPendingDeleteMap(map);
}

function getPendingToBuyDeleteMap(){
  try {
    return JSON.parse(localStorage.getItem(PENDING_TOBUY_DELETE_KEY)) || {};
  } catch(e) {
    return {};
  }
}
function setPendingToBuyDeleteMap(map){
  localStorage.setItem(PENDING_TOBUY_DELETE_KEY, JSON.stringify(map || {}));
}
function toBuyDeleteKey(id, name){
  if(id) return `id:${id}`;
  return `name:${String(name || '').toLowerCase().trim()}`;
}
function markPendingToBuyDelete(id, name){
  const map = getPendingToBuyDeleteMap();
  map[toBuyDeleteKey(id, name)] = Date.now();
  setPendingToBuyDeleteMap(map);
}
function clearPendingToBuyDelete(id, name){
  const map = getPendingToBuyDeleteMap();
  const key = toBuyDeleteKey(id, name);
  if(map[key]){
    delete map[key];
    setPendingToBuyDeleteMap(map);
  }
}
function cleanupPendingToBuyDeletes(cloudItems){
  const map = getPendingToBuyDeleteMap();
  const cloudKeys = {};
  cloudItems.forEach(a => {
    cloudKeys[toBuyDeleteKey(a.id, a.name)] = true;
  });
  let changed = false;
  Object.keys(map).forEach(k => {
    if(!cloudKeys[k]){
      delete map[k];
      changed = true;
    }
  });
  if(changed) setPendingToBuyDeleteMap(map);
}

function normalizeName(str){
  return String(str || "").trim().replace(/\s+/g, " ");
}
function keyOf(name, dosage){
  return (normalizeName(name) + "||" + normalizeName(dosage)).toLowerCase();
}

function fmtMMAAFromISO(iso){
  const dt = new Date(iso);
  if (isNaN(dt.getTime())) return "-";
  return `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getFullYear()).slice(-2)}`;
}
function fmtMMAA(d){ return fmtMMAAFromISO(d); }

function parseMMAAtoISO(mmaa){
  const raw = String(mmaa || "").trim();
  const compact = raw.replaceAll("/","").replace(/\D/g,'').slice(0,4);
  if(/^\d{4}$/.test(compact)){
    mmaa = compact.slice(0,2) + "/" + compact.slice(2,4);
  } else {
    mmaa = raw;
  }

  if(!/^\d{2}\/\d{2}$/.test(mmaa)) return null;

  const mm = parseInt(mmaa.slice(0,2), 10);
  const aa = parseInt(mmaa.slice(3,5), 10);
  if(mm < 1 || mm > 12) return null;

  const yyyy = (aa <= 79) ? (2000 + aa) : (1900 + aa);
  const iso = `${yyyy}-${String(mm).padStart(2,'0')}-01`;
  const dt = new Date(iso);
  if(isNaN(dt.getTime())) return null;
  return iso;
}

function expClass(iso){
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(iso); exp.setHours(0,0,0,0);
  const diff = Math.ceil((exp - today) / (1000*60*60*24));
  if(diff < 0) return "expired";
  if(diff <= 30) return "expiring-soon";
  return "valid";
}
function stockClass(q){ return (Number(q) === 0) ? "stock-zero" : ""; }

function mergeNotes(a,b){
  const n1 = (a||'').trim();
  const n2 = (b||'').trim();
  if(!n1) return n2;
  if(!n2) return n1;
  if(n1.toLowerCase() === n2.toLowerCase()) return n1;
  return n1 + " | " + n2;
}
function earliestExpiry(aISO, bISO){
  if(!aISO) return bISO;
  if(!bISO) return aISO;
  const da = new Date(aISO);
  const db = new Date(bISO);
  return (db < da) ? bISO : aISO;
}

/* =========================
   AUTH
========================= */
function setAppVisible(isVisible){
  document.getElementById('pwd-modal').style.display = isVisible ? 'none' : 'flex';
  document.getElementById('main-nav').style.display = isVisible ? 'block' : 'none';
  document.getElementById('main').style.display = isVisible ? 'block' : 'none';
}
function checkPwd(){
  const val = document.getElementById('pwd-input').value;
  if(val === PASSWORD){
    auth = true;
    document.getElementById('pwd-error').style.display = 'none';
    setAppVisible(true);
    show('inventory');
    updateStats();
    renderAll();
  } else {
    document.getElementById('pwd-error').style.display = 'block';
  }
}
function logout(){
  auth = false;
  setAppVisible(false);
  document.getElementById('pwd-input').value = '';
  document.getElementById('pwd-error').style.display = 'none';
}

/* =========================
   NAVIGATION
========================= */
function show(id){
  if(!auth) return;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  renderAll();
  if(id === 'to-buy') renderToBuy();
}

/* =========================
   STATS + LISTE ATTENTION
========================= */
function updateStats(){
  const today = new Date(); today.setHours(0,0,0,0);
  const limit = new Date(today); limit.setDate(today.getDate() + 30);

  let exp=0, pre=0, zer=0;
  let listHtml = '';

  meds.forEach(m=>{
    const e = new Date(m.expiry); e.setHours(0,0,0,0);
    const isExp = e < today;
    const isPre = !isExp && e <= limit;
    const isZero = Number(m.quantity) === 0;

    if(isExp) exp++;
    if(isPre) pre++;
    if(isZero) zer++;

    if(isExp || isPre || isZero){
      let status = '';
      if(isExp) status = '‚ùå EXPIR√â';
      else if(isPre) status = '‚ö†Ô∏è PR√â‚ÄëEXPIRATION';
      else status = 'üì¶ STOCK NUL';

      listHtml += `
        <div style="background:#fff;padding:1rem;margin:.5rem 0;border-radius:var(--radius);box-shadow:0 1px 4px var(--shadow);">
          <strong>${escapeHtml(m.name)}</strong> (${escapeHtml(m.dosage)}) ‚Äì ${status}
          <br><small>Qt√© : ${Number(m.quantity)||0}, Exp : ${fmtMMAA(m.expiry)}</small>
        </div>`;
    }
  });

  document.getElementById('total-meds').textContent = meds.length;
  document.getElementById('expired-count').textContent = exp;
  document.getElementById('preexp-count').textContent = pre;
  document.getElementById('zerostock-count').textContent = zer;

  document.getElementById('attention-list').innerHTML =
    listHtml || '<p style="color:#2e7d32;">‚úÖ Aucun probl√®me d√©tect√©</p>';
}

/* =========================
   RECHERCHE PAR SECTION
========================= */
function getActiveSearchValue(){
  const activeSection = document.querySelector('.section.active');
  if(!activeSection) return '';
  const input = activeSection.querySelector('input[id^="search"]');
  return input ? (input.value || '').toLowerCase() : '';
}

/* =========================
   RENDU TABLEAUX
========================= */
function renderAll(){
  if(!auth) return;

  const filter = getActiveSearchValue();

  const filtered = filter ? meds.filter(m => {
    const n = (m.name || '').toLowerCase();
    const d = (m.dosage || '').toLowerCase();
    const no = (m.notes || '').toLowerCase();
    return n.includes(filter) || d.includes(filter) || no.includes(filter);
  }) : meds;

  function renderTable(tableId){
    const tbody = document.querySelector(`#${tableId} tbody`);
    if(!tbody) return;

    tbody.innerHTML = '';

      if(filtered.length === 0){
        const colCount =
          tableId === 'med-table' ? 7 :
          tableId === 'med-table-edit' ? 6 :
          tableId === 'med-table-delete' ? 6 :
          tableId === 'med-table-use' ? 6 : 7;

      tbody.innerHTML = `<tr><td colspan="${colCount}" class="empty-msg">Aucun m√©dicament trouv√©</td></tr>`;
      return;
    }

    filtered.forEach(m=>{
      const idx = meds.indexOf(m);
      const expCls = expClass(m.expiry);
      const stkCls = stockClass(Number(m.quantity));
      const q = Number(m.quantity) || 0;

      // Calcul des alertes
      let alertMsgs = [];
      if (q < 5) alertMsgs.push('<span style="color:#d32f2f;font-weight:bold;">stock < 5</span>');
      
      const today = new Date(); today.setHours(0,0,0,0);
      const exp = new Date(m.expiry); exp.setHours(0,0,0,0);
      const diffDays = Math.ceil((exp - today) / (1000*60*60*24));
      if (diffDays <= 30) alertMsgs.push('<span style="color:#f57c00;font-weight:bold;">date < 1mois</span>');

      let alertHtml = alertMsgs.length > 0 ? alertMsgs.join('<br>') : '-';

      let row = `
        <tr class="${stkCls}">
          <td style="color:#1976d2;font-weight:bold;cursor:pointer;text-decoration:underline;" title="Voir d√©tails" onclick="openDetails(${idx})">${escapeHtml(m.name)}</td>
      `;
      if(tableId === 'med-table'){
        row += `<td>${escapeHtml(m.genre || '-')}</td>`;
      }
      row += `
          <td>${escapeHtml(m.dosage)}</td>
          <td style="color:#d32f2f;font-weight:bold;font-size:1.1em;">${q}</td>
          <td class="${expCls}">${fmtMMAA(m.expiry)}</td>
          <td>${alertHtml}</td>
      `;

      if(tableId === 'med-table'){
        row += `
          <td>
            <button class="action-btn edit" title="Modifier" onclick="openEdit(${idx})">‚úèÔ∏è</button>
            <button class="action-btn delete" title="Supprimer" onclick="removeMed(${idx})">üóëÔ∏è</button>
            <button class="action-btn use" title="Utiliser" onclick="useMed(${idx})">üíä</button>
          </td>
        `;
      } else if(tableId === 'med-table-edit'){
        row += `
          <td><button class="action-btn edit" title="Modifier" onclick="openEdit(${idx})">‚úèÔ∏è</button></td>
        `;
      } else if(tableId === 'med-table-delete'){
        row += `
          <td><button class="action-btn delete" title="Supprimer" onclick="removeMed(${idx})">üóëÔ∏è</button></td>
        `;
      } else if(tableId === 'med-table-use'){
        row += `
          <td><button class="action-btn use" title="Utiliser" onclick="useMed(${idx})">üíä</button></td>
        `;
      }

      row += `</tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  renderTable('med-table');
  renderTable('med-table-edit');
  renderTable('med-table-delete');
  renderTable('med-table-use');

  // Valeur totale supprim√©e (prix non affich√©)
}

/* =========================
   AJOUT (avec alerte + cumul)
========================= */
document.getElementById('add-form').addEventListener('submit', function(e){
  e.preventDefault();

  const name = normalizeName(document.getElementById('name').value);
  const dosage = normalizeName(document.getElementById('dosage').value);
  const genre = document.getElementById('genre').value;
  const purchaseDateEl = document.getElementById('purchase-date');
  const purchaseDateCustomEl = document.getElementById('purchase-date-custom');
  let purchaseDate = purchaseDateEl ? purchaseDateEl.value : '';
  if(!purchaseDateCustomEl || !purchaseDateCustomEl.checked){
    purchaseDate = getTodayISODate();
  }
  if(!purchaseDate) purchaseDate = getTodayISODate();

  const initialStock = parseInt(document.getElementById('initial-stock').value, 10) || 0;
  const quantity = parseInt(document.getElementById('quantity').value, 10) || 0;

  const priceVal = parseFloat(document.getElementById('price').value);
  const price = Number.isFinite(priceVal) ? priceVal : 0;

  const nbBoxes = parseInt(document.getElementById('nb-boxes').value, 10) || 1;

  const expiryMMAA = document.getElementById('expiry-mmaa').value;
  const expiryISO = parseMMAAtoISO(expiryMMAA);
  if(!expiryISO){
    alert("‚ùå Date invalide. Utilise MM/AA (ex : 02/26).");
    return;
  }

  const notes = document.getElementById('notes').value.trim();
  const now = new Date().toISOString();

  const k = keyOf(name, dosage);
  const existingIndex = meds.findIndex(m => keyOf(m.name, m.dosage) === k);

  if(existingIndex === -1){
    const newMed = {
      name, dosage, genre, initialStock, quantity, price, nbBoxes,
      expiry: expiryISO, notes, purchaseDate,
      created_at: now,
      updated_at: now,
      _localModified: true
    };
    meds.push(newMed);
    save();

    // Sauvegarder vers cloud IMM√âDIATEMENT
    if(window.addMedicament){
      addMedicament({
        name, dosage, genre, initialStock, quantity, price, nbBoxes,
        expiry: expiryISO, notes, purchaseDate
      }).then(result => {
        if(result.error){
          console.error('Erreur ajout cloud:', result.error);
        } else {
          console.log('‚úÖ Ajout cloud r√©ussi');
          // Assigner l'ID retourn√© au m√©dicament local
          if(result.data && result.data[0] && result.data[0].id){
            meds[meds.length - 1].id = result.data[0].id;
            meds[meds.length - 1].updated_at = new Date().toISOString();
            save();
            console.log('ID cloud assign√©:', result.data[0].id);
          }
        }
      });
    }

    e.target.reset();
    if(purchaseDateEl && purchaseDateCustomEl){
      purchaseDateCustomEl.checked = false;
      purchaseDateEl.disabled = true;
      purchaseDateEl.value = getTodayISODate();
    }
    show('inventory');
    renderAll();
    updateStats();
    return;
  }

  const ex = meds[existingIndex];

  const msg =
`‚ö†Ô∏è Ce m√©dicament existe d√©j√† :
- ${ex.name} (${ex.dosage})

Stock actuel :
- Quantit√© actuelle : ${ex.quantity}
- Stock initial : ${ex.initialStock}
- Prix : ${Number(ex.price||0).toFixed(2)} DH
- P√©remption : ${fmtMMAA(ex.expiry)}

Nouvelle saisie :
- +Qt√© : ${quantity}
- +Stock init. : ${initialStock}
- Nouveau prix : ${price.toFixed(2)} DH (remplace l'ancien)
- P√©remption : ${fmtMMAA(expiryISO)}

‚úÖ Voulez-vous ACTUALISER (cumuler les stocks) ?`;

  if(!confirm(msg)) return;

  ex.quantity = (Number(ex.quantity)||0) + quantity;
  ex.initialStock = (Number(ex.initialStock)||0) + initialStock;
  ex.price = price; // dernier prix remplace
  ex.nbBoxes = nbBoxes;
  ex.genre = genre;
  ex.expiry = earliestExpiry(ex.expiry, expiryISO);
  ex.notes = mergeNotes(ex.notes, notes);
  ex.purchaseDate = purchaseDate;
  ex._localModified = true; // Marquer comme modifi√© localement

  meds[existingIndex] = ex;
  save();
  
  // Mettre √† jour le cloud IMM√âDIATEMENT
  if(window.updateMedicament && ex.id){
    updateMedicament(ex.id, ex).then(result => {
      if(result.error){
        console.error('Erreur update cloud:', result.error);
      } else {
        console.log('‚úÖ Update cloud r√©ussi');
      }
    });
  }
  
  e.target.reset();
  show('inventory');
  renderAll();
  updateStats();
});

/* =========================
   EDITION (MM/AA)
========================= */
function openEdit(idx){
  const m = meds[idx];
  if(!m) return;

  document.getElementById('edit-index').value = idx;
  document.getElementById('edit-name').value = m.name || '';
  document.getElementById('edit-dosage').value = m.dosage || '';
  document.getElementById('edit-genre').value = m.genre || '';
  document.getElementById('edit-quantity').value = Number(m.quantity) || 0;
  document.getElementById('edit-initial').value = Number(m.initialStock) || 0;
  document.getElementById('edit-price').value = Number(m.price) || 0;
  document.getElementById('edit-nb-boxes').value = Number(m.nbBoxes) || 1;
  document.getElementById('edit-expiry-mmaa').value = fmtMMAA(m.expiry);
  document.getElementById('edit-notes').value = m.notes || '';
  const editPurchaseDate = document.getElementById('edit-purchase-date');
  const editPurchaseCustom = document.getElementById('edit-purchase-date-custom');
  if(editPurchaseDate && editPurchaseCustom){
    const today = getTodayISODate();
    const val = m.purchaseDate || today;
    editPurchaseDate.value = val;
    const isCustom = val !== today;
    editPurchaseCustom.checked = isCustom;
    editPurchaseDate.disabled = !isCustom;
  }

  document.getElementById('edit-modal').style.display = 'flex';
}
function closeEdit(){ document.getElementById('edit-modal').style.display = 'none'; }
document.getElementById('edit-cancel').addEventListener('click', closeEdit);

document.getElementById('edit-form').addEventListener('submit', function(e){
  e.preventDefault();

  const idx = parseInt(document.getElementById('edit-index').value, 10);
  if(Number.isNaN(idx) || !meds[idx]) return;

  const name = normalizeName(document.getElementById('edit-name').value);
  const dosage = normalizeName(document.getElementById('edit-dosage').value);
  const genre = document.getElementById('edit-genre').value;
  const editPurchaseDate = document.getElementById('edit-purchase-date');
  const editPurchaseCustom = document.getElementById('edit-purchase-date-custom');
  let purchaseDate = editPurchaseDate ? editPurchaseDate.value : '';
  if(!editPurchaseCustom || !editPurchaseCustom.checked){
    purchaseDate = (meds[idx] && meds[idx].purchaseDate) ? meds[idx].purchaseDate : getTodayISODate();
  }
  if(!purchaseDate) purchaseDate = getTodayISODate();

  const initialStock = parseInt(document.getElementById('edit-initial').value, 10) || 0;
  const quantity = parseInt(document.getElementById('edit-quantity').value, 10) || 0;

  const priceVal = parseFloat(document.getElementById('edit-price').value);
  const price = Number.isFinite(priceVal) ? priceVal : 0;

  const nbBoxes = parseInt(document.getElementById('edit-nb-boxes').value, 10) || 1;

  const expiryMMAA = document.getElementById('edit-expiry-mmaa').value;
  const expiryISO = parseMMAAtoISO(expiryMMAA);
  if(!expiryISO){
    alert("‚ùå Date invalide. Utilise MM/AA (ex : 02/26).");
    return;
  }

  const notes = document.getElementById('edit-notes').value.trim();

  // si modifie vers un existant => proposer fusion
  const newKey = keyOf(name, dosage);
  const otherIndex = meds.findIndex((m, i) => i !== idx && keyOf(m.name, m.dosage) === newKey);

  if(otherIndex !== -1){
    const target = meds[otherIndex];
    const msg =
`‚ö†Ô∏è Un autre m√©dicament existe d√©j√† avec le m√™me Nom+Dosage :
- ${target.name} (${target.dosage})

Voulez-vous FUSIONNER (cumuler) ce m√©dicament modifi√© avec l'existant ?`;

    if(confirm(msg)){
      const oldId = meds[idx].id;
      target.quantity = (Number(target.quantity)||0) + quantity;
      target.initialStock = (Number(target.initialStock)||0) + initialStock;
      target.price = price; // dernier prix remplace
      target.nbBoxes = nbBoxes;
      target.genre = genre;
      target.expiry = earliestExpiry(target.expiry, expiryISO);
      target.notes = mergeNotes(target.notes, notes);
      if(!target.purchaseDate) target.purchaseDate = purchaseDate;
      target._localModified = true; // Marquer comme modifi√© localement

      meds[otherIndex] = target;
      meds.splice(idx, 1);

      save();
      
      // Mettre √† jour le cloud IMM√âDIATEMENT
      if(window.updateMedicament && target.id){
        updateMedicament(target.id, target).then(result => {
          if(result.error){
            console.error('Erreur update cloud:', result.error);
          } else {
            console.log('‚úÖ Update cloud r√©ussi (fusion)');
          }
        });
      }
      // Supprimer l'ancien en cloud si n√©cessaire
      if(window.deleteMedicament && oldId && oldId !== target.id){
        deleteMedicament(oldId).then(result => {
          if(result && result.error){
            console.error('Erreur suppression cloud (ancien):', result.error);
          }
        });
      }
      
      closeEdit();
      renderAll();
      updateStats();
      return;
    }
  }

  const keepId = meds[idx].id;
  meds[idx] = { name, dosage, genre, quantity, initialStock, price, nbBoxes, expiry: expiryISO, notes, purchaseDate };
  if(keepId) meds[idx].id = keepId;
  meds[idx]._localModified = true; // Marquer comme modifi√© localement
  save();

  // Mettre √† jour le cloud IMM√âDIATEMENT
  if(window.updateMedicament && meds[idx].id){
    updateMedicament(meds[idx].id, { name, dosage, genre, quantity, initialStock, price, nbBoxes, expiry: expiryISO, notes, purchaseDate }).then(result => {
      if(result.error){
        console.error('Erreur update cloud:', result.error);
      } else {
        console.log('‚úÖ Update cloud r√©ussi');
      }
    });
  }
  
  closeEdit();
  renderAll();
  updateStats();
});

/* =========================
   SUPPRESSION / UTILISATION
========================= */
function removeMed(idx){
  const m = meds[idx];
  if(!m) return;
  if(confirm(`Supprimer "${m.name} (${m.dosage})" ?`)){
    const key = keyOf(m.name, m.dosage);
    markPendingDelete(key);

    // Supprimer du cloud IMM√âDIATEMENT (avec fallback nom+dosage)
    if(window.deleteMedicament){
      deleteMedicament(m.id, m.name, m.dosage).then(result => {
        if(result && result.error){
          console.error('‚ùå Erreur suppression cloud:', result.error);
        } else {
          clearPendingDelete(key);
          console.log('‚úÖ Suppression cloud r√©ussie');
        }
      });
    }

    meds.splice(idx, 1);
    save();
    renderAll();
    updateStats();
  }
}

function useMed(idx){
  const m = meds[idx];
  if(!m) return;

  const qty = parseInt(document.getElementById('use-qty').value, 10) || 1;
  if(qty <= 0){ alert("‚ùå Quantit√© invalide."); return; }

  if(Number(m.quantity) >= qty){
    const oldQty = Number(m.quantity);
    m.quantity = Number(m.quantity) - qty;
    m._localModified = true; // Marquer comme modifi√© localement
    save();
    
    logDebug('üíä UTILISER: ' + m.name + ' -' + qty + ' (√©tait:' + oldQty + ', maintenant:' + m.quantity + ')');
    
    // Si stock √©puis√©, supprimer localement seulement (pas de sync)
    if(m.quantity === 0){
      logInfo('üóëÔ∏è Stock √©puis√© - suppression locale de ' + m.name);
      const key = keyOf(m.name, m.dosage);
      markPendingDelete(key);
      if(window.deleteMedicament){
        deleteMedicament(m.id, m.name, m.dosage).then(result => {
          if(result && result.error){
            logError('‚ùå Erreur suppression cloud: ' + result.error);
          } else {
            clearPendingDelete(key);
            logSuccess('‚úÖ Suppression cloud: ' + m.name);
          }
        });
      }

      // Supprimer de la liste locale seulement
      setTimeout(() => {
        const medIdx = meds.findIndex(x => x.id === m.id);
        if(medIdx !== -1){
          meds.splice(medIdx, 1);
          save();
          renderAll();
          updateStats();
        }
      }, 100);

      alert(`‚ÑπÔ∏è Derni√®re unit√© de ${m.name} utilis√©e ‚Äì stock √©puis√©.`);
    } else {
      // Mettre √† jour le cloud IMM√âDIATEMENT avec nouvelle quantit√©
      if(window.updateMedicament && m.id){
        updateMedicament(m.id, m).then(result => {
          if(result.error){
            logError('Erreur sync cloud: ' + result.error);
          } else {
            logSuccess('‚úÖ Sync: ' + m.name + ' = ' + m.quantity);
          }
        });
      }
      
      renderAll();
      updateStats();
      
      if(m.quantity <= 5){
        alert(`‚ö†Ô∏è Stock faible : il ne reste plus que ${m.quantity} unit√©(s) de ${m.name}.`);
      }
    }
  } else {
    alert(`‚ùå Stock insuffisant ! ${m.name} poss√®de seulement ${m.quantity} unit√©(s).`);
  }
}

/* =========================
   √Ä ACHETER (Liste de courses)
========================= */
function renderToBuy(){
  const tbody = document.querySelector('#tobuy-table tbody');
  if(!tbody) return;
  
  tbody.innerHTML = '';
  
  // D√©dupliquer par nom (pr√©f√©rer item avec id)
  const dedupMap = {};
  toBuyList.forEach(item => {
    const key = (item.name || '').toLowerCase().trim();
    if(!key) return;
    if(!dedupMap[key] || (!dedupMap[key].id && item.id)){
      dedupMap[key] = item;
    }
  });
  toBuyList = Object.values(dedupMap);

  if(toBuyList.length === 0){
    tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">Aucun m√©dicament dans la liste</td></tr>';
    return;
  }
  
  // Trier par ordre alphab√©tique
  const sortedList = [...toBuyList].sort((a, b) => 
    a.name.toLowerCase().localeCompare(b.name.toLowerCase())
  );
  
  sortedList.forEach((item, idx)=>{
    tbody.innerHTML += `
      <tr>
        <td style="color:#1976d2;font-weight:bold;">${escapeHtml(item.name)}</td>
        <td style="color:#d32f2f;font-weight:bold;font-size:1.1em;">${item.qty}</td>
        <td>${escapeHtml(item.notes || '-')}</td>
        <td><button class="action-btn delete" onclick="removeToBuyItem(${item.id || 'null'}, ${JSON.stringify(item.name)})">üóëÔ∏è</button></td>
      </tr>
    `;
  });
}

// Supprimer par id si possible (fallback nom)
function removeToBuyItem(id, name){
  if(!confirm('Supprimer "' + name + '" de la liste ?')) return;
  markPendingToBuyDelete(id, name);
  
  // Trouver l'index
  const idx = toBuyList.findIndex(item => 
    (id && item.id === id) || item.name.toLowerCase() === name.toLowerCase()
  );
  
  if(idx === -1) {
    console.log('‚ö†Ô∏è Article non trouv√©:', name);
    return;
  }
  
  toBuyList.splice(idx, 1);
  localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
  renderToBuy();

  // Sync vers cloud - suppression activ√©e avec confirmation
  if(window.deleteAchatById && id){
    console.log('‚òÅÔ∏è Suppression cloud (id):', id);
    deleteAchatById(id).then((result) => {
      if(result && result.error){
        throw new Error((result.status ? ('HTTP ' + result.status + ' ') : '') + result.error);
      }
      clearPendingToBuyDelete(id, name);
      console.log('‚úÖ Suppression cloud confirm√©e pour id:', id);
      setTimeout(() => {
        loadToBuyFromCloud();
      }, 500);
    }).catch(e => {
      console.error('‚ùå Erreur suppression cloud:', e);
      if(window.deleteAchatByName){
        console.log('‚òÅÔ∏è Fallback suppression cloud (nom):', name);
        deleteAchatByName(name).then((r) => {
          if(r && r.error){
            throw new Error((r.status ? ('HTTP ' + r.status + ' ') : '') + r.error);
          }
          clearPendingToBuyDelete(id, name);
          loadToBuyFromCloud();
        }).catch(err => {
          console.error('‚ùå Erreur suppression cloud (nom):', err);
          alert('‚ùå Suppression cloud refus√©e: ' + err.message);
          loadToBuyFromCloud();
        });
      } else {
        alert('‚ùå Suppression cloud refus√©e.');
        loadToBuyFromCloud();
      }
    });
  } else if(window.deleteAchatByName){
    console.log('‚òÅÔ∏è Suppression cloud (nom):', name);
    deleteAchatByName(name).then((result) => {
      if(result && result.error){
        throw new Error((result.status ? ('HTTP ' + result.status + ' ') : '') + result.error);
      }
      clearPendingToBuyDelete(id, name);
      loadToBuyFromCloud();
    }).catch(e => {
      console.error('‚ùå Erreur suppression cloud:', e);
      alert('‚ùå Suppression cloud refus√©e: ' + e.message);
      loadToBuyFromCloud();
    });
  }
}

function removeToBuy(idx){
  if(confirm('Supprimer ce m√©dicament de la liste ?')){
    var deletedItem = toBuyList[idx];
    var deletedName = deletedItem.name;
    var deletedId = deletedItem.id;
    
    toBuyList.splice(idx, 1);
    localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
    renderToBuy();
    
    // Sync IMM√âDIAT vers cloud - suppression directe
    if(window.deleteAchatById && deletedId){
      console.log('‚òÅÔ∏è Suppression imm√©diate id', deletedId, 'du cloud');
      deleteAchatById(deletedId);
    } else if(window.deleteAchatByName){
      console.log('‚òÅÔ∏è Suppression imm√©diate de', deletedName, 'du cloud');
      deleteAchatByName(deletedName);
    }
  }
}

document.getElementById('tobuy-form').addEventListener('submit', function(e){
  e.preventDefault();

  const name = normalizeName(document.getElementById('tobuy-name').value);
  const qty = parseInt(document.getElementById('tobuy-qty').value, 10) || 1;
  const notes = document.getElementById('tobuy-notes').value.trim();

  if(!name) return;

  // V√©rifier si l'article existe d√©j√†
  const existingIndex = toBuyList.findIndex(item =>
    item.name.toLowerCase() === name.toLowerCase()
  );

  if(existingIndex !== -1){
    // Cumuler les quantit√©s
    toBuyList[existingIndex].qty += qty;
    toBuyList[existingIndex].notes = mergeNotes(toBuyList[existingIndex].notes, notes);
    const existingId = toBuyList[existingIndex].id;
    if(window.updateAchatById && existingId){
      updateAchatById(existingId, {
        name,
        qty: toBuyList[existingIndex].qty,
        notes: toBuyList[existingIndex].notes
      }).then(() => {
        loadToBuyFromCloud();
      });
    }
  } else {
    // Ajouter nouveau
    toBuyList.push({ name, qty, notes });
  }

  localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));

  // Sync vers cloud imm√©diatement
  if(window.addAchat){
    console.log('‚òÅÔ∏è Sync ajout achat vers cloud:', { name, qty, notes });
    addAchat({ name, qty, notes }).then((res) => {
      if(res && res.data && res.data[0] && res.data[0].id){
        const newId = res.data[0].id;
        const idx = toBuyList.findIndex(item => item.name.toLowerCase() === name.toLowerCase());
        if(idx !== -1){
          toBuyList[idx].id = newId;
          localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
          renderToBuy();
        }
      }
      loadToBuyFromCloud();
    });
  } else {
    console.warn('‚ö†Ô∏è addAchat non disponible');
  }

  e.target.reset();
  document.getElementById('tobuy-qty').value = 1;
  renderToBuy();
});

/* =========================
   SAUVEGARDE / RESTAURATION / VIDAGE
========================= */
function downloadJSON(filename, dataObj){
  const json = JSON.stringify(dataObj, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function saveBackup(){
  if(!auth) return;
  const payload = {
    app: "pharmacie_domicile",
    version: 1,
    exportedAt: new Date().toISOString(),
    medicines: meds
  };
  downloadJSON("pharmacie-stock.json", payload);
  alert("‚úÖ Sauvegarde t√©l√©charg√©e : pharmacie-stock.json");
}

function restoreBackupFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);

      // accepter 2 formats:
      // - { medicines: [...] }
      // - [...] (liste directe)
      const list = Array.isArray(obj) ? obj : (obj && Array.isArray(obj.medicines) ? obj.medicines : null);
      if(!list) throw new Error("Format invalide");

      // validation minimale
      const cleaned = list.map(x => ({
        name: normalizeName(x.name),
        dosage: normalizeName(x.dosage),
        genre: x.genre || '',
        quantity: Number(x.quantity)||0,
        initialStock: Number(x.initialStock)||0,
        price: Number(x.price)||0,
        nbBoxes: Number(x.nbBoxes)||1,
        expiry: x.expiry,
        notes: (x.notes||"").toString()
      }));

      meds = cleaned;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
      localStorage.setItem(SEEDED_KEY, "1");

      renderAll();
      updateStats();
      alert("‚úÖ Restauration termin√©e !");
    }catch(err){
      alert("‚ùå Impossible de restaurer : fichier JSON invalide.");
    }
  };
  reader.readAsText(file);
}

function restoreBackup(){
  if(!auth) return;
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json,.json";
  input.onchange = () => {
    if(input.files && input.files[0]){
      const ok = confirm("‚ö†Ô∏è Restaurer va remplacer ton stock actuel. Continuer ?");
      if(!ok) return;
      restoreBackupFromFile(input.files[0]);
    }
  };
  input.click();
}

function clearAllStock(){
  if(!auth) return;
  const ok = confirm("üßπ Voulez-vous VRAIMENT vider tout le stock ? Cette action est irr√©versible.");
  if(!ok) return;

  meds = [];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
  localStorage.setItem(SEEDED_KEY, "1");

  // Effacer aussi le cloud
  if(window.clearAllCloudMeds){
    clearAllCloudMeds().then(() => {
      alert('‚úÖ Stock local ET cloud effac√©s.');
    }).catch(e => {
      console.error('Erreur effacement cloud:', e);
      alert('‚úÖ Stock local effac√©. Le cloud n\'a pas pu √™tre effac√©.');
    });
  } else {
    alert('‚úÖ Stock local effac√©.');
  }

  renderAll();
  updateStats();
}

/* =========================
   √âV√âNEMENTS UI
========================= */
document.getElementById('pwd-btn').addEventListener('click', checkPwd);
document.getElementById('logout-link').addEventListener('click', (e)=>{ e.preventDefault(); logout(); });
document.getElementById('details-close-btn').addEventListener('click', closeDetails);
document.getElementById('details-modal').addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'details-modal') closeDetails();
});

const purchaseDateInput = document.getElementById('purchase-date');
const purchaseDateCustom = document.getElementById('purchase-date-custom');
if(purchaseDateInput && purchaseDateCustom){
  purchaseDateInput.value = getTodayISODate();
  purchaseDateCustom.addEventListener('change', ()=>{
    purchaseDateInput.disabled = !purchaseDateCustom.checked;
    if(!purchaseDateCustom.checked){
      purchaseDateInput.value = getTodayISODate();
    }
  });
}
const editPurchaseDateInput = document.getElementById('edit-purchase-date');
const editPurchaseDateCustom = document.getElementById('edit-purchase-date-custom');
if(editPurchaseDateInput && editPurchaseDateCustom){
  editPurchaseDateCustom.addEventListener('change', ()=>{
    editPurchaseDateInput.disabled = !editPurchaseDateCustom.checked;
    if(!editPurchaseDateCustom.checked){
      editPurchaseDateInput.value = getTodayISODate();
    }
  });
}

// Dark mode toggle
const themeToggle = document.getElementById('theme-toggle');
if(themeToggle) {
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  });
}

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if(savedTheme === 'dark') {
  document.body.classList.add('dark-mode');
}

document.querySelectorAll('nav a[data-target]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    show(a.getAttribute('data-target'));
  });
});

// actions backup
document.getElementById('btn-save').addEventListener('click', (e)=>{ e.preventDefault(); saveBackup(); });
document.getElementById('btn-restore').addEventListener('click', (e)=>{ e.preventDefault(); restoreBackup(); });
document.getElementById('btn-clear').addEventListener('click', (e)=>{ e.preventDefault(); clearAllStock(); });
document.getElementById('btn-clean-dup').addEventListener('click', (e)=>{ e.preventDefault(); clearLocalDuplicates(); });
document.getElementById('btn-reset-all').addEventListener('click', async (e)=>{
  e.preventDefault();
  if(!confirm('‚ö†Ô∏è Tout effacer (local + cloud) ? Cette action est irr√©versible.')) return;

  // Effacer cloud
  try {
    if(window.clearAllCloudMeds) await clearAllCloudMeds();
    if(window.clearAchats) await clearAchats();
  } catch(e) {
    console.warn('Erreur effacement cloud:', e);
  }

  // Effacer local
  meds = [];
  toBuyList = [];
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(TOBUY_KEY);
  localStorage.removeItem(SEEDED_KEY);
  localStorage.removeItem(PENDING_DELETE_KEY);

  renderAll();
  renderToBuy();
  updateStats();
  alert('‚úÖ Donn√©es locales et cloud effac√©es.');
});

const toBuyToggle = document.getElementById('tobuy-toggle');
const toBuyForm = document.getElementById('tobuy-form');
if(toBuyToggle && toBuyForm){
  toBuyToggle.addEventListener('click', (e)=>{
    e.preventDefault();
    const isHidden = toBuyForm.style.display === 'none' || toBuyForm.style.display === '';
    toBuyForm.style.display = isHidden ? 'block' : 'none';
    toBuyToggle.textContent = isHidden ? '‚ûñ Fermer' : '‚ûï Ajouter';
  });
}

// recherches live
['search','search-edit','search-delete','search-use'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', renderAll);
});

// auto-format MM/AA
function attachMMAAFormatter(inputId){
  const el = document.getElementById(inputId);
  if(!el) return;
  el.addEventListener('input', ()=>{
    let v = el.value.replaceAll("/","").replace(/\D/g,'').slice(0,4);
    if(v.length >= 3) v = v.slice(0,2) + "/" + v.slice(2);
    el.value = v;
  });
}
attachMMAAFormatter('expiry-mmaa');
attachMMAAFormatter('edit-expiry-mmaa');

// clavier : Enter login, Escape edit
document.addEventListener('keydown', e=>{
  if(e.key === "Enter" && document.getElementById('pwd-modal').style.display !== 'none'){
    checkPwd();
  }
  if(e.key === "Escape" && document.getElementById('edit-modal').style.display === 'flex'){
    closeEdit();
  }
});

/* =========================
   DEBUG LOG SYNC
========================= */
function logDebug(msg, type){
  const debugDiv = document.getElementById('debug-sync');
  if(!debugDiv) return;
  
  debugDiv.style.display = 'block';
  const time = new Date().toLocaleTimeString();
  const cssClass = type === 'success' ? 'log-success' : (type === 'error' ? 'log-error' : 'log-info');
  
  const entry = document.createElement('div');
  entry.className = 'log-entry ' + cssClass;
  entry.textContent = '[' + time + '] ' + msg;
  
  debugDiv.appendChild(entry);
  debugDiv.scrollTop = debugDiv.scrollHeight;
  
  // Garder que les 20 derni√®res lignes
  while(debugDiv.children.length > 20){
    debugDiv.removeChild(debugDiv.firstChild);
  }
}
function logSuccess(msg){ logDebug(msg, 'success'); }
function logError(msg){ logDebug(msg, 'error'); }
function logInfo(msg){ logDebug(msg, 'info'); }

/* =========================
   INITIALISATION
========================= */
const FAST_SYNC_INTERVAL_MS = 5000;
let autoSyncTimer = null;
let cloudSubUnsubscribe = null;
let achatsSubUnsubscribe = null;
document.addEventListener('DOMContentLoaded', ()=>{
  renderToBuy();

  // Initialiser le cloud
  function tryInitCloud(){
    if(typeof initCloud === 'function'){
      logInfo('üîÑ Connexion cloud...');
      console.log('üîÑ Tentative de connexion cloud...');
      initCloud().then(function(enabled){
        if(enabled){
          logSuccess('‚úÖ Cloud Supabase ACTIV√â');
          console.log('‚úÖ Cloud Supabase ACTIV√â');
          window.cloudReady = true;

          // Charger donn√©es cloud initiales
          loadFromCloud();

          // Sync automatique rapide
          if(autoSyncTimer) clearInterval(autoSyncTimer);
          autoSyncTimer = setInterval(() => {
            if(window.cloudReady){
              autoSyncFromCloud();
            }
          }, FAST_SYNC_INTERVAL_MS);

          // Abonnement (polling) pour d√©tection rapide des changements
          if(cloudSubUnsubscribe) cloudSubUnsubscribe();
          cloudSubUnsubscribe = subscribeToCloudChanges();

          if(achatsSubUnsubscribe) achatsSubUnsubscribe();
          achatsSubUnsubscribe = subscribeToAchatsChanges();
        } else {
          logInfo('‚ùå Cloud Supabase NON activ√©');
          console.log('‚ùå Cloud Supabase NON activ√©');
        }
      }).catch(function(e){
        logError('‚ùå Erreur initCloud: ' + e);
        console.error('‚ùå Erreur initCloud:', e);
      });
    } else {
      logInfo('‚è≥ Attente de cloud.js...');
      console.warn('‚è≥ Attente de cloud.js...');
      setTimeout(tryInitCloud, 100);
    }
  }
  tryInitCloud();
});

// Sync rapide au retour sur l'onglet
document.addEventListener('visibilitychange', () => {
  if(document.visibilityState === 'visible' && window.cloudReady){
    autoSyncFromCloud();
  }
});

window.addEventListener('focus', () => {
  if(window.cloudReady){
    autoSyncFromCloud();
  }
});

// Pas d'auto-sync - sync manuel uniquement
// Les modifications sont sync√©es imm√©diatement vers le cloud

// Sync manuel via bouton

// Sync automatique depuis cloud - VERSION AM√âLIOR√âE AVEC CONFLITS
async function autoSyncFromCloud(){
  if(autoSyncFromCloud._running) return;
  autoSyncFromCloud._running = true;
  if(!window.getMedicaments) {
    console.warn('‚è≥ getMedicaments non disponible - sync retard√©');
    autoSyncFromCloud._running = false;
    return;
  }

  console.log('üîÑ D√©marrage autoSyncFromCloud am√©lior√©...');

  try {
    var result = await getMedicaments();

    if(!result || result.length === 0) {
      console.log('‚ÑπÔ∏è Aucun m√©dicament dans le cloud');
      if(isOnline()){
        meds = [];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
        renderAll();
        updateStats();
        console.log('üßπ Local stock effac√© (cloud vide)');
      }
      return;
    }

    var cloudMeds = result.map(function(m){
      return {
        id: m.id,
        name: m.nom,
        dosage: m.dosage,
        genre: m.genre,
        quantity: m.quantite,
        initialStock: m.stock_initial,
        price: m.prix,
        nbBoxes: m.nb_boites,
        expiry: m.date_peremption,
        notes: m.notes || '',
        purchaseDate: m.date_achat || '',
        updated_at: m.updated_at || m.created_at
      };
    });

    console.log('‚òÅÔ∏è Cloud meds re√ßus:', cloudMeds.length);

    // Nettoyer les suppressions en attente
    var cloudKeys = {};
    cloudMeds.forEach(function(cm){
      cloudKeys[keyOf(cm.name, cm.dosage)] = true;
    });
    cleanupPendingDeletes(cloudKeys);
    var pendingDeleteMap = getPendingDeleteMap();
    cloudMeds = cloudMeds.filter(function(cm){
      return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
    });

    // PROTECTION ANTI-DOUBLONS : Cr√©er une map unique par cl√©
    var uniqueCloudMeds = {};
    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      if(!uniqueCloudMeds[key]){
        uniqueCloudMeds[key] = cm;
      } else {
        console.warn('‚ö†Ô∏è Doublon cloud ignor√©:', cm.name, cm.dosage);
      }
    });

    // Convertir en tableau unique
    cloudMeds = Object.values(uniqueCloudMeds);

    var localChanged = false;
    var addedCount = 0;
    var updatedCount = 0;

    // Cr√©er une map des m√©dicaments locaux par cl√©
    var localMap = {};
    meds.forEach(function(m, index){
      var key = keyOf(m.name, m.dosage);
      localMap[key] = { med: m, index: index };
    });

    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      var localEntry = localMap[key];

      if(!localEntry){
        // NOUVEAU m√©dicament du cloud, l'ajouter
        console.log('‚ûï Nouveau du cloud:', cm.name);

        var validMed = {
          id: cm.id,
          name: cm.name,
          dosage: cm.dosage,
          genre: cm.genre || '',
          quantity: Math.max(0, Number(cm.quantity) || 0),
          initialStock: Math.max(0, Number(cm.initialStock) || 0),
          price: Math.max(0, Number(cm.price) || 0),
          nbBoxes: Math.max(1, Number(cm.nbBoxes) || 1),
          expiry: cm.expiry || null,
          notes: cm.notes || '',
          updated_at: cm.updated_at
        };

        meds.push(validMed);
        localChanged = true;
        addedCount++;
        console.log('‚úÖ M√©dicament ajout√©:', cm.name, 'qty:', validMed.quantity, 'price:', validMed.price);
      } else {
        // M√©dicament existe d√©j√†, v√©rifier si mise √† jour n√©cessaire
        var localMed = localEntry.med;
        var cloudTime = new Date(cm.updated_at || 0);
        var localTime = new Date(localMed.updated_at || 0);

        // Si cloud plus r√©cent OU si local n'a pas de timestamp
        if(cloudTime > localTime || !localMed.updated_at){
          console.log('üîÑ Mise √† jour depuis cloud:', cm.name, 'ancien qty:', localMed.quantity, 'nouveau:', cm.quantity);

          // Mettre √† jour les donn√©es locales avec celles du cloud
          localMed.id = cm.id;
          localMed.quantity = Math.max(0, Number(cm.quantity) || 0);
          localMed.initialStock = Math.max(0, Number(cm.initialStock) || 0);
          localMed.price = Math.max(0, Number(cm.price) || 0);
          localMed.nbBoxes = Math.max(1, Number(cm.nbBoxes) || 1);
          localMed.expiry = cm.expiry || localMed.expiry;
          localMed.notes = cm.notes || localMed.notes;
          localMed.genre = cm.genre || localMed.genre;
          localMed.updated_at = cm.updated_at;

          meds[localEntry.index] = localMed;
          localChanged = true;
          updatedCount++;
          console.log('‚úÖ M√©dicament mis √† jour:', cm.name, 'qty:', localMed.quantity, 'price:', localMed.price);
        }
      }
    });

    if(localChanged){
      save();
      console.log('üíæ Sync termin√©: +' + addedCount + ' ajout√©s, ~' + updatedCount + ' mis √† jour');
      if(typeof renderAll === 'function') renderAll();
      if(typeof updateStats === 'function') updateStats();
    } else {
      console.log('‚ÑπÔ∏è Aucune modification n√©cessaire');
    }

    // Sync achats (√Ä acheter) avec validation stricte
    if(window.getAchats){
      try {
        var achatsResult = await getAchats();
        if(achatsResult && achatsResult.length > 0){
          console.log('üîÑ Sync achats: cloud=' + achatsResult.length + ', local=' + toBuyList.length);

            var uniqueCloudAchats = {};
            achatsResult.forEach(function(a){
              var key = (a.nom || '').toLowerCase().trim();
              if(key && a.nom){
                uniqueCloudAchats[key] = {
                  id: a.id,
                  name: a.nom.trim(),
                  qty: Math.max(1, Number(a.quantite) || 1),
                  notes: (a.notes || '').trim()
                };
              }
            });

            const cloudList = Object.values(uniqueCloudAchats);
            cleanupPendingToBuyDeletes(cloudList);
            const pendingMap = getPendingToBuyDeleteMap();

            var changed = false;

            // Mettre √† jour les achats existants
            toBuyList.forEach(function(localItem, index){
              var key = localItem.name.toLowerCase().trim();
              var cloudItem = uniqueCloudAchats[key];

              if(cloudItem){
                if(pendingMap[toBuyDeleteKey(cloudItem.id, cloudItem.name)]) return;
                var newQty = Math.max(1, Number(cloudItem.qty) || 1);
                var newNotes = cloudItem.notes || '';

                if(localItem.qty !== newQty || localItem.notes !== newNotes || !localItem.id){
                  toBuyList[index].qty = newQty;
                  toBuyList[index].notes = newNotes;
                  if(!toBuyList[index].id) toBuyList[index].id = cloudItem.id;
                  changed = true;
                  console.log('üîÑ Achat mis √† jour:', localItem.name, 'qty:', newQty);
                }
                delete uniqueCloudAchats[key];
              }
            });

          // Ajouter les nouveaux achats
            Object.values(uniqueCloudAchats).forEach(function(newItem){
              if(pendingMap[toBuyDeleteKey(newItem.id, newItem.name)]) return;
              var exists = toBuyList.some(function(local){
                return local.name.toLowerCase().trim() === newItem.name.toLowerCase().trim();
              });

              if(!exists){
                toBuyList.push(newItem);
                changed = true;
                console.log('‚ûï Nouvel achat du cloud:', newItem.name);
              }
            });

          if(changed){
            localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
            if(typeof renderToBuy === 'function') renderToBuy();
          }
        } else if(isOnline()){
          toBuyList = [];
          localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
          if(typeof renderToBuy === 'function') renderToBuy();
          console.log('üßπ Liste "√Ä acheter" effac√©e (cloud vide)');
        }
      } catch(e) {
        console.warn('Sync achats √©chou√©:', e);
      }
    }

    window.cloudReady = true;
    console.log('‚úÖ Auto-sync am√©lior√© termin√©');
  } catch(e) {
    console.warn('Sync auto √©chou√©:', e);
  } finally {
    autoSyncFromCloud._running = false;
  }
}

// Subscription temps r√©el - √©couter les changements cloud
function subscribeToCloudChanges(){
  if(!window.subscribeToMedicaments) return null;
  
  return subscribeToMedicaments(function(payload){
    console.log('Cloud change detected:', payload);
    
    // Recharger depuis cloud quand un changement est d√©tect√©
    refreshFromCloud();
  }, { intervalMs: FAST_SYNC_INTERVAL_MS });
}

function subscribeToAchatsChanges(){
  if(!window.subscribeToAchats) return null;

  return subscribeToAchats(function(payload){
    console.log('Achats change detected:', payload);
    loadToBuyFromCloud();
  }, { intervalMs: FAST_SYNC_INTERVAL_MS });
}

// Rafra√Æchir depuis cloud (pour sync temps r√©el)
function refreshFromCloud(){
  if(!window.getMedicaments) return;
  
  getMedicaments().then(function(result){
    if(!result || result.length === 0) return;
    
    let cloudMeds = result.map(function(m){
      return {
        id: m.id,
        name: m.nom,
        dosage: m.dosage,
        genre: m.genre,
        quantity: m.quantite,
        initialStock: m.stock_initial,
        price: m.prix,
        nbBoxes: m.nb_boites,
        expiry: m.date_peremption,
        notes: m.notes || '',
        purchaseDate: m.date_achat || ''
      };
    });

    // Nettoyer les suppressions en attente
    var cloudKeys = {};
    cloudMeds.forEach(function(cm){
      cloudKeys[keyOf(cm.name, cm.dosage)] = true;
    });
    cleanupPendingDeletes(cloudKeys);
    var pendingDeleteMap = getPendingDeleteMap();
    cloudMeds = cloudMeds.filter(function(cm){
      return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
    });

    // Nettoyer les suppressions en attente
    var cloudKeys = {};
    cloudMeds.forEach(function(cm){
      cloudKeys[keyOf(cm.name, cm.dosage)] = true;
    });
    cleanupPendingDeletes(cloudKeys);
    var pendingDeleteMap = getPendingDeleteMap();
    cloudMeds = cloudMeds.filter(function(cm){
      return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
    });
    
    // Fusion cloud + local (AJOUTER + METTRE √Ä JOUR + SUPPRIMER)
    // Cr√©er map cloud par cl√©
    var cloudByKey = {};
    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      cloudByKey[key] = cm;
    });
    
    var deletedCount = 0;
    var updatedCount = 0;
    
    // Pour chaque med local, v√©rifier s'il existe dans cloud
    meds.forEach(function(lm){
      var key = keyOf(lm.name, lm.dosage);
      var cm = cloudByKey[key];
      
      if(!cm){
        // N'existe pas dans cloud ‚Üí supprimer local
        console.log('üóëÔ∏è Supprimer local (pas dans cloud):', lm.name);
        lm._toDelete = true;
        deletedCount++;
      } else {
        // Existe dans cloud ‚Üí v√©rifier si modifi√©
        if(lm._localModified && !cm._localModified){
          // Local modifi√© plus r√©cemment ‚Üí garder local
          console.log('‚è≠Ô∏è Skip update (local plus r√©cent):', lm.name);
        } else if(lm.quantity !== cm.quantity || lm.price !== cm.price || lm.expiry !== cm.expiry){
          // Cloud plus r√©cent ‚Üí prendre les donn√©es cloud
          console.log('‚úÖ Update depuis cloud:', lm.name, 'qty:', lm.quantity, '‚Üí', cm.quantity);
          lm.id = cm.id;
          lm.quantity = cm.quantity;
          lm.price = cm.price;
          lm.expiry = cm.expiry;
          lm.notes = cm.notes || '';
          updatedCount++;
        }
      }
    });
    
    // Supprimer les meds marqu√©s
    meds = meds.filter(function(m){ return !m._toDelete; });
    
    // Ajouter les nouveaux du cloud
    var addedCount = 0;
    cloudMeds.forEach(function(cm){
      var key = keyOf(cm.name, cm.dosage);
      var exists = meds.some(function(m){ return keyOf(m.name, m.dosage) === key; });
      console.log('üîç Check cloud med:', cm.name, '| key:', key, '| exists:', exists);
      if(!exists){
        meds.push(cm);
        addedCount++;
        console.log('‚ûï AJOUT√â:', cm.name);
      }
    });
    
    save();
    renderAll();
    updateStats();
    
    console.log('üìä Final meds count:', meds.length);
    if(addedCount > 0 || deletedCount > 0 || updatedCount > 0){
      console.log('‚úÖ Sync termin√©e: +' + addedCount + ' ajout√©s, -' + deletedCount + ' supprim√©s, ~' + updatedCount + ' mis √† jour');
    } else {
      console.log('‚ÑπÔ∏è Sync: pas de changements');
    }
  });
}

// Charger depuis cloud vers local (FUSION intelligente)
function loadFromCloud(){
  if(!window.getMedicaments) return;
  
  console.log('üîÑ loadFromCloud: r√©cup√©ration donn√©es cloud...');
  
  getMedicaments().then(function(result){
    if(!result || result.length === 0){
      console.log('‚ÑπÔ∏è Aucune donn√©e cloud ou erreur');
      return;
    }
    
    // Convertir cloud meds vers format local (avec 'name' au lieu de 'nom')
    var cloudMeds = result.map(function(m){
      return {
        id: m.id,
        name: m.nom,
        dosage: m.dosage,
        genre: m.genre,
        quantity: m.quantite,
        initialStock: m.stock_initial,
        price: m.prix,
        nbBoxes: m.nb_boites,
        expiry: m.date_peremption,
        notes: m.notes || '',
        purchaseDate: m.date_achat || ''
      };
    });
    
    // Nettoyer les suppressions en attente
    var cloudKeys = {};
    cloudMeds.forEach(function(cm){
      cloudKeys[keyOf(cm.name, cm.dosage)] = true;
    });
    cleanupPendingDeletes(cloudKeys);
    var pendingDeleteMap = getPendingDeleteMap();
    cloudMeds = cloudMeds.filter(function(cm){
      return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
    });

    console.log('üì• Cloud meds:', cloudMeds.length);
    
    if(cloudMeds.length > 0){
      // FUSION intelligente : ajouter nouveaux meds du cloud
      var localByKey = {};
      meds.forEach(function(m){
        localByKey[keyOf(m.name, m.dosage)] = m;
      });
      
      // Ajouter les meds du cloud qui n'existent pas en local
      var addedCount = 0;
      cloudMeds.forEach(function(cm){
        var key = keyOf(cm.name, cm.dosage);
        if(!localByKey[key]){
          meds.push(cm);
          addedCount++;
        }
      });
      
      if(addedCount > 0){
        save();
        renderAll();
        updateStats();
        console.log('‚úÖ Fusion cloud: ' + addedCount + ' nouveaux m√©dicaments ajout√©s');
      } else {
        console.log('‚ÑπÔ∏è Aucune nouvelle donn√©e cloud');
      }
    }
    
    // Charger aussi la liste √† acheter
    loadToBuyFromCloud();
  });
}

// Charger liste √† acheter depuis cloud (FUSION)
function loadToBuyFromCloud(){
  if(!window.getAchats) return;
  
  console.log('üîÑ loadToBuyFromCloud...');
  
  getAchats().then(function(result){
    if(!result || result.length === 0){
      console.log('‚ÑπÔ∏è Aucune donn√©e achats cloud');
      if(isOnline()){
        toBuyList = [];
        localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
        renderToBuy();
        console.log('üßπ Liste "√Ä acheter" effac√©e (cloud vide)');
      }
      return;
    }
    
    // Remplacer la liste locale par le cloud (source de v√©rit√©)
    const pendingMap = getPendingToBuyDeleteMap();
    const cloudList = result.map(a => ({ id: a.id, name: a.nom }));
    cleanupPendingToBuyDeletes(cloudList);
    toBuyList = result.map(a => ({
      id: a.id,
      name: a.nom,
      qty: a.quantite,
      notes: a.notes || ''
    })).filter(a => !pendingMap[toBuyDeleteKey(a.id, a.name)]);

    localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
    renderToBuy();
    console.log('‚úÖ Sync achats termin√©e:', toBuyList.length, 'articles');
  });
}

// Charger depuis cloud ET afficher un message
async function loadAndShowFromCloud(){
  if(typeof getMedicaments !== 'function') {
    alert('‚ö†Ô∏è Cloud non activ√©');
    return;
  }
  
  var result = await getMedicaments();
  
  if(result.error){
    alert('‚ùå Erreur cloud: ' + result.error);
    return;
  }
  
  if(!result || result.length === 0){
    alert('‚ö†Ô∏è Aucune donn√©e dans le cloud');
    return;
  }
  
  var cloudMeds = result.map(function(m){
    return {
      id: m.id,
      name: m.nom,
      dosage: m.dosage,
      genre: m.genre,
      quantity: m.quantite,
      initialStock: m.stock_initial,
      price: m.prix,
      nbBoxes: m.nb_boites,
      expiry: m.date_peremption,
      notes: m.notes || '',
      purchaseDate: m.date_achat || ''
    };
  });

  // Nettoyer les suppressions en attente
  var cloudKeys = {};
  cloudMeds.forEach(function(cm){
    cloudKeys[keyOf(cm.name, cm.dosage)] = true;
  });
  cleanupPendingDeletes(cloudKeys);
  var pendingDeleteMap = getPendingDeleteMap();
  cloudMeds = cloudMeds.filter(function(cm){
    return !pendingDeleteMap[keyOf(cm.name, cm.dosage)];
  });
  
  // Fusionner : ajouter les m√©dicaments cloud qui n'existent pas en local
  var localMap = {};
  meds.forEach(function(m){
    var key = (m.name + '_' + m.dosage).toLowerCase();
    localMap[key] = true;
  });
  
  var added = 0;
  cloudMeds.forEach(function(cm){
    var key = (cm.name + '_' + cm.dosage).toLowerCase();
    if(!localMap[key]){
      meds.push(cm);
      added++;
    }
  });
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
  localStorage.setItem(SEEDED_KEY, "1");
  
  renderAll();
  updateStats();
  
  console.log('Fusion termin√©e:', added, 'nouveaux');
  alert('‚úÖ ' + added + ' m√©dicaments ajout√©s depuis cloud !');
}

// Sauvegarder TOUTES les donn√©es locales vers cloud
// Sauvegarder VERS cloud (mode FUSION - pas d'√©crasement)
async function saveAllToCloud(callback){
  if(typeof addMedicament !== 'function') {
    if(callback) callback();
    return;
  }
  
  console.log('D√©but sync fusion vers cloud, meds count:', meds.length);
  
  // R√©cup√©rer les donn√©es cloud actuelles
  var cloudData = await getMedicaments();
  var cloudMeds = cloudData || [];
  
  console.log('Cloud a:', cloudMeds.length, 'm√©dicaments');
  
  // Cr√©er une map pour les m√©dicaments cloud par nom+dosage
  var cloudMap = {};
  cloudMeds.forEach(function(m){
    var key = keyOf(m.name, m.dosage);
    cloudMap[key] = m;
  });
  
  // Pour chaque m√©dicament local, fusionner avec cloud
  for(var j = 0; j < meds.length; j++){
    var m = meds[j];
    var key = (m.name + '_' + m.dosage).toLowerCase();
    
    var medData = {
      name: m.name,
      dosage: m.dosage,
      genre: m.genre,
      quantity: m.quantity,
      initialStock: m.initialStock,
      price: m.price,
      nbBoxes: m.nbBoxes,
      expiry: m.expiry,
      notes: m.notes || '',
      purchaseDate: m.purchaseDate || ''
    };
    
    if(cloudMap[key]){
      // Existe d√©j√† dans cloud, mettre √† jour
      console.log('Mise √† jour:', medData.name);
      await updateMedicament(cloudMap[key].id, medData);
    } else {
      // N'existe pas, cr√©er
      console.log('Cr√©ation:', medData.name);
      await addMedicament(medData);
    }
  }
  
  console.log('Sync fusion termin√©e');
  if(callback) callback();
}

// Debug sync
async function forceDebugSync(){
  var localCount = meds.length;
  document.getElementById('debug-local-count').textContent = localCount;
  document.getElementById('debug-status').textContent = 'V√©rification...';
  if(!window.getMedicaments) return;
  try {
    var result = await getMedicaments();
    var cloudCount = result ? result.length : 0;
    document.getElementById('debug-cloud-count').textContent = cloudCount;
    if(cloudCount === 0 && localCount > 0){
      document.getElementById('debug-status').textContent = 'Sync...';
      var synced = 0;
      for(var m of meds){
        var addResult = await addMedicament(m);
        if(!addResult.error) synced++;
      }
      document.getElementById('debug-status').textContent = 'Termin√©! ' + synced;
    } else if(cloudCount > 0){
      document.getElementById('debug-status').textContent = 'Sync OK';
    }
  } catch(e){
    document.getElementById('debug-status').textContent = 'Erreur';
  }
}

// Clear local duplicates and sync with cloud
async function clearLocalDuplicates(){
  if(!auth) return;
  if(!confirm('‚ö†Ô∏è Voulez-vous supprimer les doublons locaux et synchroniser avec le cloud ?')) return;

  console.log('üßπ Suppression des doublons locaux...');

  // Cr√©er une map pour d√©tecter les doublons
  var uniqueMeds = {};
  var duplicatesRemoved = 0;

  meds.forEach(function(m, index){
    var key = keyOf(m.name, m.dosage);
    if(uniqueMeds[key]){
      // Doublon trouv√©, supprimer
      duplicatesRemoved++;
      console.log('üóëÔ∏è Doublon supprim√©:', m.name, m.dosage);
    } else {
      uniqueMeds[key] = m;
    }
  });

  // Convertir la map en tableau
  meds = Object.values(uniqueMeds);

  console.log('‚úÖ Doublons supprim√©s:', duplicatesRemoved);
  console.log('üìä M√©dicaments uniques restants:', meds.length);

  save();
  renderAll();
  updateStats();

  // Synchroniser avec le cloud
  if(window.getMedicaments){
    console.log('üîÑ Synchronisation avec le cloud...');
    loadFromCloud();
  }

  alert('‚úÖ Nettoyage termin√© ! ' + duplicatesRemoved + ' doublons supprim√©s.');
}

// Improved sync for "√Ä acheter" deletions
async function syncToBuyDeletions(){
  if(!window.getAchats) return;

  try {
    var cloudResult = await getAchats();
    if(!cloudResult || cloudResult.length === 0){
      // Si cloud vide, vider local aussi
      toBuyList = [];
      localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
      renderToBuy();
      console.log('üóëÔ∏è Liste "√Ä acheter" vid√©e (cloud vide)');
      return;
    }

    // Cr√©er map des noms cloud
    var cloudNames = {};
    cloudResult.forEach(function(a){
      cloudNames[a.nom.toLowerCase()] = {
        qty: a.quantite,
        notes: a.notes || ''
      };
    });

    var changed = false;

    // Supprimer les locaux qui n'existent plus dans cloud
    for(var i = toBuyList.length - 1; i >= 0; i--){
      var localName = toBuyList[i].name.toLowerCase();
      if(!cloudNames[localName]){
        console.log('üóëÔ∏è Suppression locale (pas dans cloud):', toBuyList[i].name);
        toBuyList.splice(i, 1);
        changed = true;
      } else {
        // Mettre √† jour quantit√© si diff√©rente
        var cloudItem = cloudNames[localName];
        if(toBuyList[i].qty !== cloudItem.qty || toBuyList[i].notes !== cloudItem.notes){
          toBuyList[i].qty = cloudItem.qty;
          toBuyList[i].notes = cloudItem.notes;
          changed = true;
          console.log('üîÑ Quantit√© mise √† jour:', toBuyList[i].name);
        }
      }
    }

    if(changed){
      localStorage.setItem(TOBUY_KEY, JSON.stringify(toBuyList));
      renderToBuy();
      console.log('‚úÖ Sync "√Ä acheter" termin√©');
    }

  } catch(e) {
    console.warn('Erreur sync "√Ä acheter":', e);
  }
}

</script>

<!-- Supabase Realtime SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Cloud Integration (REST API) -->
<script src="cloud.js?v=20260209"></script>

</body>
</html>




