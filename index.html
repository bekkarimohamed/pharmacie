<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion Pharmacie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{--primary:#ff6f61;--accent:#88c0d0;--text:#363636;--radius:8px;--shadow:rgba(0,0,0,0.1)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;background:#fff;color:var(--text);min-height:100vh}
    nav{background:var(--primary);padding:.75rem;position:sticky;top:0;z-index:100}
    nav ul{display:flex;flex-wrap:wrap;gap:1rem;list-style:none;align-items:center}
    nav a{color:#fff;text-decoration:none;padding:.5rem 1rem;border-radius:var(--radius);display:inline-block}
    .container{padding:2rem;max-width:1200px;margin:auto}
    section{display:none}
    section.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:1rem;box-shadow:0 2px 8px var(--shadow);border-radius:var(--radius)}
    th,td{padding:.75rem;border-bottom:1px solid #eee;text-align:left}
    th{background:var(--accent);color:#fff}
    .expired{color:#d32f2f!important;font-weight:bold}
    .expiring-soon{color:#f57c00!important;font-weight:bold}
    .stock-zero{color:#d32f2f!important;font-weight:bold;background:#ffebee}
    .action-btn{background:none;border:none;cursor:pointer;margin:0 .25rem;font-size:1.1rem}
    form{max-width:520px;margin-top:1rem;background:#fff;padding:1.5rem;border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow)}
    .form-group{margin-bottom:1.2rem}
    label{display:block;margin-bottom:.5rem;font-weight:bold;color:var(--primary)}
    input,textarea,select{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:var(--radius);font-size:1rem}
    button[type=submit]{background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;font-size:1rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin:2rem 0}
    .stat-card{background:#fff;padding:1.5rem;border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow);text-align:center}
    .stat-number{font-size:2rem;font-weight:bold;margin:.5rem 0}
    .password-modal{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:10000}
    .password-content{background:#fff;padding:2rem;border-radius:var(--radius);text-align:center;width:90%;max-width:420px}
    .empty-msg{text-align:center;padding:2rem;color:#666;font-style:italic}
    #sync-status{position:fixed;bottom:10px;right:10px;padding:.5rem 1rem;border-radius:20px;font-size:.8rem;z-index:1000;background:#4caf50;color:#fff}
    #sync-status.offline{background:#f44336}
    #sync-status.hidden{display:none}
    #cloud-modal{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:10001}
    #cloud-modal.hidden{display:none}
    .cloud-content{background:#fff;padding:2rem;border-radius:var(--radius);width:90%;max-width:450px}
    .cloud-content input{width:100%;padding:.75rem;margin:.5rem 0;border:1px solid #ddd;border-radius:var(--radius)}
    .cloud-content button{background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;width:100%;margin-top:.5rem}
    @media (max-width:768px){
      nav{padding:.3rem}
      nav ul{display:grid;grid-template-columns:repeat(3,1fr);gap:.3rem}
      nav a{padding:.3rem .4rem;font-size:.75rem;text-align:center}
      .container{padding:.5rem}
      .stats-grid{grid-template-columns:repeat(2,1fr);gap:.4rem;margin:.5rem 0}
      .stat-card{padding:.5rem}
      .stat-number{font-size:1.1rem}
      form{padding:.5rem}
      input,textarea,select{padding:.4rem;font-size:.85rem}
      table{font-size:.75rem;display:block;overflow-x:auto;white-space:nowrap}
      th,td{padding:.3rem .25rem}
      #sync-status{bottom:5px;right:5px;font-size:.7rem;padding:.3rem .6rem}
      #btn-save,#btn-restore,#btn-clear{display:none}
      #logout-link{display:block!important}
      #med-table th:nth-child(10),#med-table td:nth-child(10),#med-table-edit th:nth-child(4),#med-table-edit td:nth-child(4),#med-table-edit th:nth-child(5),#med-table-edit td:nth-child(5),#med-table-delete th:nth-child(4),#med-table-delete td:nth-child(4),#med-table-delete th:nth-child(5),#med-table-delete td:nth-child(5),#med-table-use th:nth-child(4),#med-table-use td:nth-child(4),#med-table-use th:nth-child(5),#med-table-use td:nth-child(5){display:none}
    }
  </style>
</head>
<body>
  <div id="cloud-modal" class="">
    <div class="cloud-content">
      <h2>Cloud Sync</h2>
      <p>Entrez votre ID unique pour synchroniser entre PC et telephone</p>
      <input type="text" id="cloud-id" placeholder="ex: famille-pharmacie-2024">
      <button id="cloud-btn">Connecter</button>
      <p style="font-size:.8rem;color:#666;margin-top:1rem">Utilisez le MEME ID sur tous vos appareils</p>
    </div>
  </div>
  <div id="pwd-modal" class="password-modal">
    <div class="password-content">
      <h2>Mot de passe</h2>
      <input type="password" id="pwd-input" placeholder="Entrez mot de passe" style="width:100%;padding:.75rem;margin:1rem 0;border:1px solid #ddd;border-radius:var(--radius)">
      <button id="pwd-btn" style="background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer">Acceder</button>
      <p id="pwd-error" style="color:#d32f2f;margin-top:1rem;display:none">Mot de passe incorrect</p>
    </div>
  </div>
  <div id="sync-status" class="hidden">Sync</div>
  <nav id="main-nav" style="display:none">
    <ul>
      <li><a href="#" data-target="home">Accueil</a></li>
      <li><a href="#" data-target="inventory">Inventaire</a></li>
      <li><a href="#" data-target="add">Ajouter</a></li>
      <li><a href="#" data-target="edit">Modifier</a></li>
      <li><a href="#" data-target="delete">Supprimer</a></li>
      <li><a href="#" data-target="use">Utiliser</a></li>
      <li><a href="#" data-target="buy">A acheter</a></li>
      <li><a href="#" id="btn-save">Sauvegarder</a></li>
      <li><a href="#" id="btn-restore">Restaurer</a></li>
      <li><a href="#" id="btn-clear">Vider</a></li>
      <li><a href="#" id="logout-link">Quitter</a></li>
    </ul>
  </nav>
  <div class="container" id="main" style="display:none">
    <section id="home" class="active">
      <h1>Gestion Pharmacie</h1>
      <div class="stats-grid">
        <div class="stat-card"><h3>Total</h3><div class="stat-number" id="total-meds">0</div></div>
        <div class="stat-card"><h3>Expires</h3><div class="stat-number" id="expired-count">0</div></div>
        <div class="stat-card"><h3>Pre-expi</h3><div class="stat-number" id="preexp-count">0</div></div>
        <div class="stat-card"><h3>Zero</h3><div class="stat-number" id="zerostock-count">0</div></div>
      </div>
      <h3>Attention</h3>
      <div id="attention-list"></div>
    </section>
    <section id="inventory">
      <h2>Inventaire</h2>
      <input type="text" id="search" placeholder="Rechercher" style="width:100%;padding:.75rem;margin-bottom:1rem;border:1px solid #ddd;border-radius:var(--radius)">
      <div style="margin-bottom:1rem">Valeur: <strong id="total-value">0 DH</strong></div>
      <table id="med-table">
        <thead><tr><th>Nom</th><th>Genre</th><th>Dose</th><th>Qte</th><th>Stock</th><th>Prix</th><th>Exp</th><th>Alerte</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
    <section id="add">
      <h2>Ajouter</h2>
      <form id="add-form">
        <div class="form-group"><label>Nom *</label><input type="text" id="name" required></div>
        <div class="form-group"><label>Dose *</label><input type="text" id="dosage" required></div>
        <div class="form-group"><label>Genre *</label><select id="genre" required><option value="">Choisir</option><option>Comprimes</option><option>Gelules</option><option>Suppositoires</option><option>Sachets</option><option>Gel</option><option>Flacon</option><option>Sirop</option><option>Solution</option><option>Pommade</option><option>Lotion</option><option>Creme</option><option>Poudre</option><option>Gouttes</option><option>Inhalation</option><option>Patch</option><option>Autre</option></select></div>
        <div class="form-group"><label>Stock initial *</label><input type="number" id="initial-stock" min="0" required></div>
        <div class="form-group"><label>Qte actuelle *</label><input type="number" id="quantity" min="0" required></div>
        <div class="form-group"><label>Prix DH *</label><input type="number" id="price" min="0" step="0.01" required></div>
        <div class="form-group"><label>Nb boites *</label><input type="number" id="nb-boxes" min="1" value="1" required></div>
        <div class="form-group"><label>Expiration MM/AA *</label><input type="text" id="expiry" maxlength="5" placeholder="ex: 02/26" required></div>
        <div class="form-group"><label>Notes</label><textarea id="notes"></textarea></div>
        <button type="submit">Ajouter</button>
      </form>
    </section>
    <section id="edit">
      <h2>Modifier</h2>
      <input type="text" id="search-edit" placeholder="Rechercher" style="width:100%;padding:.75rem;margin-bottom:1rem;border:1px solid #ddd;border-radius:var(--radius)">
      <table id="edit-table"><thead><tr><th>Nom</th><th>Dose</th><th>Qte</th><th>Stock</th><th>Prix</th><th>Exp</th><th>Action</th></tr></thead><tbody></tbody></table>
    </section>
    <section id="delete">
      <h2>Supprimer</h2>
      <input type="text" id="search-delete" placeholder="Rechercher" style="width:100%;padding:.75rem;margin-bottom:1rem;border:1px solid #ddd;border-radius:var(--radius)">
      <table id="delete-table"><thead><tr><th>Nom</th><th>Dose</th><th>Qte</th><th>Stock</th><th>Prix</th><th>Exp</th><th>Action</th></tr></thead><tbody></tbody></table>
    </section>
    <section id="use">
      <h2>Utiliser</h2>
      <div style="margin-bottom:1rem"><label>Qte a utiliser:</label> <input type="number" id="use-qty" value="1" min="1" style="width:80px"></div>
      <input type="text" id="search-use" placeholder="Rechercher" style="width:100%;padding:.75rem;margin-bottom:1rem;border:1px solid #ddd;border-radius:var(--radius)">
      <table id="use-table"><thead><tr><th>Nom</th><th>Dose</th><th>Qte</th><th>Stock</th><th>Prix</th><th>Exp</th><th>Action</th></tr></thead><tbody></tbody></table>
    </section>
    <section id="buy">
      <h2>A acheter</h2>
      <form id="buy-form" style="max-width:420px">
        <div class="form-group"><label>Nom *</label><input type="text" id="buy-name" required></div>
        <div class="form-group"><label>Qte *</label><input type="number" id="buy-qty" min="1" value="1" required></div>
        <div class="form-group"><label>Notes</label><input type="text" id="buy-notes" placeholder="ex: comprime"></div>
        <button type="submit">Ajouter</button>
      </form>
      <table id="buy-table" style="margin-top:1rem"><thead><tr><th>Nom</th><th>Qte</th><th>Notes</th><th>Action</th></tr></thead><tbody></tbody></table>
    </section>
  </div>
  <div id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000">
    <div style="background:#fff;padding:2rem;border-radius:8px;width:90%;max-width:500px">
      <h3>Modifier</h3>
      <form id="edit-form">
        <input type="hidden" id="edit-index">
        <div class="form-group"><label>Nom</label><input type="text" id="edit-name" required></div>
        <div class="form-group"><label>Dose</label><input type="text" id="edit-dosage" required></div>
        <div class="form-group"><label>Genre</label><select id="edit-genre"><option>Comprimes</option><option>Gelules</option><option>Suppositoires</option><option>Sachets</option><option>Gel</option><option>Flacon</option><option>Sirop</option><option>Solution</option><option>Pommade</option><option>Lotion</option><option>Creme</option><option>Poudre</option><option>Gouttes</option><option>Inhalation</option><option>Patch</option><option>Autre</option></select></div>
        <div class="form-group"><label>Stock initial</label><input type="number" id="edit-initial" min="0"></div>
        <div class="form-group"><label>Qte</label><input type="number" id="edit-quantity" min="0"></div>
        <div class="form-group"><label>Prix</label><input type="number" id="edit-price" min="0" step="0.01"></div>
        <div class="form-group"><label>Nb boites</label><input type="number" id="edit-boxes" min="1" value="1"></div>
        <div class="form-group"><label>Exp MM/AA</label><input type="text" id="edit-exp" maxlength="5"></div>
        <div class="form-group"><label>Notes</label><textarea id="edit-notes"></textarea></div>
        <button type="submit" style="background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer">Enregistrer</button>
        <button type="button" id="edit-cancel" style="background:#999;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:var(--radius);cursor:pointer;margin-left:.5rem">Annuler</button>
      </form>
    </div>
  </div>
<script>
/* CLOUD SYNC JSONBIN.IO */
const CLOUD_KEY = 'pharmacie_cloud_id';
let cloudId = localStorage.getItem(CLOUD_KEY);
let syncTimer = null;
const CLOUD_URL = 'https://api.jsonbin.io/v3/b/';
const CLOUD_KEY_ID = '$2a$10$xH4HVlQO5QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ';

function isCloudConfigured(){return cloudId!==null}
function saveCloudId(id){cloudId=id.trim().toLowerCase();localStorage.setItem(CLOUD_KEY,cloudId)}

function syncToCloud(){if(!cloudId)return;showSync('sync');fetch(CLOUD_URL+cloudId,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':CLOUD_KEY_ID},body:JSON.stringify({m:meds,t:toBuy,u:new Date().toISOString()})}).then(r=>{if(r.ok)showSync('ok');else showSync('err');}).catch(e=>showSync('err'));}

function syncFromCloud(){if(!cloudId)return;showSync('sync');fetch(CLOUD_URL+cloudId,{headers:{'X-Master-Key':CLOUD_KEY_ID}}).then(r=>r.json()).then(d=>{if(d.record){if(d.record.m){meds=d.record.m;localStorage.setItem('meds',JSON.stringify(meds));}if(d.record.t){toBuy=d.record.t;localStorage.setItem('buy',JSON.stringify(toBuy));}render();updateStats();}showSync('ok');}).catch(e=>showSync('off');)}

function showSync(s){var e=document.getElementById('sync-status');e.className='';if(s=='ok'){e.textContent='OK';e.classList.add('hidden',setTimeout(_=>e.classList.add('hidden'),2000));}else if(s=='sync'){e.textContent='Sync...';}else if(s=='off'){e.textContent='Offline';e.classList.add('offline');}else{e.textContent='Err';e.classList.add('offline');}}

/* APP */
const PWD='1964';const LS_MEDS='meds';const LS_BUY='buy';let auth=false;let meds=JSON.parse(localStorage.getItem(LS_MEDS))||[];let toBuy=JSON.parse(localStorage.getItem(LS_BUY))||[];

function esc(s){return String(s??'').replace(/&/g,'&').replace(/</g,'<').replace(/>/g,'>').replace(/"/g,'"').replace(/'/g,'&#039;');}
function save(){localStorage.setItem(LS_MEDS,JSON.stringify(meds));syncToCloud();}
function saveBuy(){localStorage.setItem(LS_BUY,JSON.stringify(toBuy));syncToCloud();}
function norm(s){return String(s||'').trim().replace(/\s+/g,' ');}
function key(n,d){return (norm(n)+'||'+norm(d)).toLowerCase();}
function expDate(iso){let d=new Date(iso);if(isNaN(d.getTime()))return'-';return String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getFullYear()).slice(-2);}
function parseExp(s){let v=String(s||'').replace(/\D/g,'').slice(0,4);if(v.length>=3)v=v.slice(0,2)+'/'+v.slice(2);if(!/^\d{2}\/\d{2}$/.test(v))return null;let mm=parseInt(v.slice(0,2));let yy=parseInt(v.slice(3));if(mm<1||mm>12)return null;let yyyy=yy<=79?2000+yy:1900+yy;return yyyy+'-'+String(mm).padStart(2,'0')+'-01';}
function expClass(iso){let t=new Date();t.setHours(0,0,0,0);let e=new Date(iso);e.setHours(0,0,0,0);let d=Math.ceil((e-t)/(1000*60*60*24));if(d<0)return'expired';if(d<=30)return'expiring-soon';return'valid';}

function showSec(id){document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');render();}

function updStats(){let e=0,p=0,z=0,l='';let t=new Date();t.setHours(0,0,0,0);let l30=new Date(t);l30.setDate(t.getDate()+30);meds.forEach(m=>{let ed=new Date(m.e);ed.setHours(0,0,0,0);let ie=ed<t;let ip=!ie&&ed<=l30;let iz=m.q==0;if(ie)e++;if(ip)p++;if(iz)z++;if(ie||ip||iz){let st=ie?'EXP':ip?'PRE-EXP':'ZERO';l+='<div style="background:#fff;padding:1rem;margin:.5rem 0;border-radius:8px">'+esc(m.n)+' ('+esc(m.d)+') - '+st+'<br><small>Qte:'+m.q+' Exp:'+expDate(m.e)+'</small></div>';}});document.getElementById('total-meds').textContent=meds.length;document.getElementById('expired-count').textContent=e;document.getElementById('preexp-count').textContent=p;document.getElementById('zerostock-count').textContent=z;document.getElementById('attention-list').innerHTML=l||'OK';}

function render(){let f=getSearch();let fm=f?meds.filter(m=>(m.n||'').toLowerCase().includes(f)||(m.d||'').toLowerCase().includes(f)||(m.notes||'').toLowerCase().includes(f)):meds;function tbl(id,cols,acts){let t=document.querySelector('#'+id+' tbody');if(!t)return;t.innerHTML='';if(fm.length==0){t.innerHTML='<tr><td colspan="'+cols+'" class="empty-msg">Rien</td></tr>';return;}fm.forEach((m,i)=>{let j=meds.indexOf(m);let ec=expClass(m.e);let q=m.q||0;let al=[];if(q<5)al.push('<span style="color:red">Qte<5</span>');let t2=new Date();t2.setHours(0,0,0,0);let ed=new Date(m.e);ed.setHours(0,0,0,0);if(Math.ceil((ed-t2)/(1000*60*60*24))<=30)al.push('<span style="color:orange">Exp<1m</span>');let r='<tr class="'+(q==0?'stock-zero':'')+'"><td>'+esc(m.n)+'</td><td>'+esc(m.g||'-')+'</td><td>'+esc(m.d)+'</td><td style="color:red">'+q+'</td><td>'+(m.s||0)+'</td><td>'+Number(m.p||0).toFixed(2)+' DH</td><td class="'+ec+'">'+expDate(m.e)+'</td><td>'+al.join('<br>')+'</td>';if(id=='med-table'){r+='<td>'+esc(m.notes||'-')+'</td><td><button onclick="openEdit('+j+')">‚úè</button><button onclick="delMed('+j+')">üóë</button><button onclick="useMed('+j+')">üíä</button></td>';}else if(id=='edit-table'||id=='delete-table'||id=='use-table'){r+=acts?'<td>'+acts+'</td>':'</tr>';}t.innerHTML+=r+'</tr>';});}tbl('med-table',10,'');tbl('edit-table',7,'<button onclick="openEdit(IDX)">‚úè</button>'.replace('IDX',''));tbl('delete-table',7,'<button onclick="delMed(IDX)">üóë</button>'.replace('IDX',''));tbl('use-table',7,'<button onclick="useMed(IDX)">üíä</button>'.replace('IDX',''));let tot=fm.reduce((s,m)=>s+Number(m.p||0)*Number(m.b||1),0);document.getElementById('total-value').textContent=tot.toFixed(2)+' DH';}

function getSearch(){let s=document.querySelector('section.active input[id^="search"]');return s?(s.value||'').toLowerCase():'';}

function checkPwd(){if(document.getElementById('pwd-input').value==PWD){auth=true;document.getElementById('pwd-modal').style.display='none';document.getElementById('main-nav').style.display='block';document.getElementById('main').style.display='block';showSec('inventory');updStats();render();if(cloudId){syncFromCloud();syncTimer=setInterval(syncToCloud,30000);}}else{document.getElementById('pwd-error').style.display='block';}}

function logout(){auth=false;clearInterval(syncTimer);document.getElementById('pwd-modal').style.display='flex';document.getElementById('main-nav').style.display='none';document.getElementById('main').style.display='none';document.getElementById('pwd-input').value='';document.getElementById('pwd-error').style.display='none';}

function openEdit(i){let m=meds[i];document.getElementById('edit-index').value=i;document.getElementById('edit-name').value=m.n;document.getElementById('edit-dosage').value=m.d;document.getElementById('edit-genre').value=m.g;document.getElementById('edit-initial').value=m.s;document.getElementById('edit-quantity').value=m.q;document.getElementById('edit-price').value=m.p;document.getElementById('edit-boxes').value=m.b;document.getElementById('edit-exp').value=expDate(m.e);document.getElementById('edit-notes').value=m.notes;document.getElementById('edit-modal').style.display='flex';}
function closeEdit(){document.getElementById('edit-modal').style.display='none';}

function delMed(i){if(confirm('Supprimer '+meds[i].n+'?')){meds.splice(i,1);save();render();updStats();}}

function useMed(i){let q=parseInt(document.getElementById('use-qty').value)||1;if(q<=0)return;let m=meds[i];if(m.q>=q){m.q-=q;save();render();updStats();if(m.q==0)alert('Stock epuise');else if(m.q<=5)alert('Stock faible: '+m.q);}else alert('Stock insuffisant');}

function renderBuy(){let t=document.querySelector('#buy-table tbody');if(!t)return;t.innerHTML='';if(toBuy.length==0){t.innerHTML='<tr><td colspan="4" class="empty-msg">Vide</td></tr>';return;}toBuy.forEach((b,i)=>{t.innerHTML+='<tr><td>'+esc(b.n)+'</td><td>'+b.q+'</td><td>'+esc(b.notes||'-')+'</td><td><button onclick="delBuy('+i+')">üóë</button></td></tr>';});}
function delBuy(i){if(confirm('Supprimer?')){toBuy.splice(i,1);saveBuy();renderBuy();}}

/* EVENTS */
document.getElementById('pwd-btn').addEventListener('click',checkPwd);
document.getElementById('logout-link').addEventListener('click',logout);
document.querySelectorAll('nav a[data-target]').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();showSec(a.dataset.target);if(a.dataset.target=='buy')renderBuy();}));
document.getElementById('add-form').addEventListener('submit',e=>{e.preventDefault();let n=norm(document.getElementById('name').value);let d=norm(document.getElementById('dosage').value);let g=document.getElementById('genre').value;let s=parseInt(document.getElementById('initial-stock').value)||0;let q=parseInt(document.getElementById('quantity').value)||0;let p=parseFloat(document.getElementById('price').value)||0;let b=parseInt(document.getElementById('nb-boxes').value)||1;let ex=parseExp(document.getElementById('expiry').value);if(!ex){alert('Date invalide');return;}let nt=document.getElementById('notes').value.trim();let k=key(n,d);let ei=meds.findIndex(m=>key(m.n,m.d)==k);if(ei==-1){meds.push({n,d,g,s,q,p,b,e:ex,notes:nt});save();e.target.reset();showSec('inventory');render();updStats();}else{let exM=meds[ei];if(confirm('Existe deja. Cumuler?')){exM.s+=s;exM.q+=q;exM.p=p;exM.b=b;exM.g=g;exM.e=ex;exM.notes=nt;save();e.target.reset();showSec('inventory');render();updStats();}}});
document.getElementById('edit-form').addEventListener('submit',e=>{e.preventDefault();let i=parseInt(document.getElementById('edit-index').value);let n=norm(document.getElementById('edit-name').value);let d=norm(document.getElementById('edit-dosage').value);let g=document.getElementById('edit-genre').value;let s=parseInt(document.getElementById('edit-initial').value)||0;let q=parseInt(document.getElementById('edit-quantity').value)||0;let p=parseFloat(document.getElementById('edit-price').value)||0;let b=parseInt(document.getElementById('edit-boxes').value)||1;let ex=parseExp(document.getElementById('edit-exp').value);if(!ex){alert('Date invalide');return;}let nt=document.getElementById('edit-notes').value.trim();meds[i]={n,d,g,s,q,p,b,e:ex,notes:nt};save();closeEdit();render();updStats();});
document.getElementById('edit-cancel').addEventListener('click',closeEdit);
document.getElementById('buy-form').addEventListener('submit',e=>{e.preventDefault();let n=norm(document.getElementById('buy-name').value);let q=parseInt(document.getElementById('buy-qty').value)||1;let nt=document.getElementById('buy-notes').value.trim();if(!n)return;toBuy.push({n,q,notes:nt});saveBuy();e.target.reset();document.getElementById('buy-qty').value=1;renderBuy();});
document.getElementById('btn-save').addEventListener('click',()=>{let d=JSON.stringify({m:meds,t:toBuy},null,2);let b=new Blob([d],{type:'application/json'});let u=URL.createObjectURL(b);let a=document.createElement('a');a.href=u;a.download='pharmacie.json';a.click();a.remove();URL.revokeObjectURL(u);});
document.getElementById('btn-restore').addEventListener('click',()=>{let i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=()=>{if(i.files[0]){let r=new FileReader();r.onload=()=>{try{let j=JSON.parse(r.result);let l=Array.isArray(j)?j:j.m||[];meds=l.map(x=>({n:norm(x.n),d:norm(x.d),g:x.g||'',s:Number(x.s)||0,q:Number(x.q)||0,p:Number(x.p)||0,b:Number(x.b)||1,e:x.e,notes:(x.notes||'').toString()}));if(j.t)toBuy=j.t;localStorage.setItem(LS_MEDS,JSON.stringify(meds));localStorage.setItem(LS_BUY,JSON.stringify(toBuy));render();updStats();alert('OK');}catch(e){alert('Erreur');}}};r.readAsText(i.files[0]);}else{alert('Erreur');}};i.click();});
document.getElementById('btn-clear').addEventListener('click',()=>{if(confirm('Vider tout?')){meds=[];toBuy=[];localStorage.removeItem(LS_MEDS);localStorage.removeItem(LS_BUY);render();updStats();}});
['search','search-edit','search-delete','search-use'].forEach(id=>{let el=document.getElementById(id);if(el)el.addEventListener('input',render);});
function fmtExp(v){let r=v.replace(/\D/g,'').slice(0,4);if(r.length>=3)r=r.slice(0,2)+'/'+r.slice(2);return r;}
['expiry','edit-exp'].forEach(id=>{let el=document.getElementById(id);if(el)el.addEventListener('input',()=>el.value=fmtExp(el.value));});
document.addEventListener('keydown',e=>{if(e.key=='Enter'&&document.getElementById('pwd-modal').style.display!='none')checkPwd();if(e.key=='Escape'&&document.getElementById('edit-modal').style.display=='flex')closeEdit();});

/* CLOUD CONFIG */
document.getElementById('cloud-btn').addEventListener('click',()=>{let id=document.getElementById('cloud-id').value.trim();if(!id){alert('Entrez ID');return;}saveCloudId(id);document.getElementById('cloud-modal').classList.add('hidden');if(auth){syncFromCloud();syncTimer=setInterval(syncToCloud,30000);}alert('OK - Utilisez le meme ID sur tous vos appareils');});

/* INIT */
document.addEventListener('DOMContentLoaded',()=>{renderBuy();if(!isCloudConfigured()){setTimeout(()=>document.getElementById('cloud-modal').classList.remove('hidden'),500);}});
</script>
</body>
</html>
